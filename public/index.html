<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Personal Finance Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Light Mode Colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-mid: #764ba2;
            --bg-gradient-end: #f093fb;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: rgba(255, 255, 255, 0.8);
            --card-bg: rgba(255, 255, 255, 0.9);
            --navbar-bg: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.18);
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-heavy: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] {
            /* Dark Mode Colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-mid: #16213e;
            --bg-gradient-end: #0f3460;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: rgba(203, 213, 225, 0.8);
            --card-bg: rgba(30, 41, 59, 0.9);
            --navbar-bg: rgba(30, 41, 59, 0.85);
            --border-color: rgba(148, 163, 184, 0.18);
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.5);
            --shadow-heavy: rgba(0, 0, 0, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            background-size: 300% 300%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--card-bg);
            border-radius: 50px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 1rem;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }

        .theme-toggle.dark::before {
            transform: translateX(24px);
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        /* Navbar */
        .navbar {
            background: var(--navbar-bg);
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            box-shadow: 0 8px 32px var(--shadow-light), 
                        0 0 0 1px var(--border-color) inset;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar:hover {
            background: var(--card-bg);
            box-shadow: 0 12px 40px var(--shadow-medium), 
                        0 0 0 1px var(--border-color) inset;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: #4f46e5;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #4f46e5;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #4f46e5;
            border-radius: 1px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .notification-icon:hover {
            color: #4f46e5;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .mobile-menu {
            display: none;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 60px;
            right: 80px;
            width: 300px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 20px 60px var(--shadow-medium);
            display: none;
            z-index: 999;
            max-height: 400px;
            overflow-y: auto;
        }

        .notifications-panel.active {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(79, 70, 229, 0.05);
        }

        .notification-item.unread {
            background: rgba(79, 70, 229, 0.02);
            border-left: 3px solid #4f46e5;
        }

        /* Main Content */
        main {
            margin-top: 80px;
            padding: 2rem;
            min-height: calc(100vh - 160px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            margin-bottom: 0.5rem;
            background-size: 200% 200%;
            animation: gradientText 3s ease infinite;
        }

        @keyframes gradientText {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dashboard-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-light), 
                        0 0 0 1px var(--border-color) inset;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px var(--shadow-medium), 
                        0 0 0 1px var(--border-color) inset,
                        0 0 50px rgba(79, 70, 229, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, var(--card-color, #4f46e5), var(--card-color-alt, #7c3aed));
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::after {
            left: 100%;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: linear-gradient(135deg, var(--card-color, #4f46e5), var(--card-color-alt, #7c3aed));
            background-size: 200% 200%;
            animation: gradientShift 4s ease infinite;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
            position: relative;
        }

        .stat-icon:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.4);
        }

        .stat-icon i {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon i {
            transform: scale(1.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Charts and Insights */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container,
        .insights-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }

        .expense-chart {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .chart-loading {
            position: relative;
            opacity: 0.6;
        }

        .chart-loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }

        /* AI Insights */
        .insight-item {
            display: flex;
            align-items: start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(79, 70, 229, 0.05);
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid #4f46e5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .insight-item:hover {
            background: rgba(79, 70, 229, 0.1);
            transform: translateX(5px);
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .insight-content h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .insight-content p {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
        }

        /* Recent Transactions */
        .transactions-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .transaction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(79, 70, 229, 0.02);
            transform: translateX(5px);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-name {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .transaction-category {
            font-size: 0.875rem;
            color: #64748b;
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 1rem;
        }

        .transaction-amount.income {
            color: #10b981;
        }

        .transaction-amount.expense {
            color: #ef4444;
        }

        /* Budget Progress */
        .budget-item {
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .budget-item:hover {
            transform: translateX(5px);
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .budget-name {
            font-weight: 500;
            color: #1e293b;
        }

        .budget-amount {
            font-size: 0.875rem;
            color: #64748b;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .progress-fill.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Enhanced Form Styling */
        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
            transition: color 0.3s ease;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        .form-group input:focus + label,
        .form-group select:focus + label {
            color: #4f46e5;
        }

        .form-validation-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
            font-weight: 500;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border-left: 3px solid #ef4444;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .form-group.error label {
            color: #ef4444;
        }

        .form-group.error .form-validation-message {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .form-group.success input,
        .form-group.success select,
        .form-group.success textarea {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .form-group.success label {
            color: #10b981;
        }

        .form-group.success::after {
            content: '✓';
            position: absolute;
            right: 12px;
            top: 42px;
            color: #10b981;
            font-weight: bold;
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Receipt Upload Styling */
        .receipt-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .receipt-upload-area:hover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.02);
            transform: scale(1.01);
        }

        .receipt-upload-area.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
            transform: scale(1.02);
        }

        .receipt-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .receipt-upload-area:hover::before {
            left: 100%;
        }

        /* Import Modal Styles */
        .import-type-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .import-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #4f46e5;
        }

        .import-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .import-type-card:hover::before {
            left: 100%;
        }

        /* Enhanced Button Styles */
        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
            animation: gradientShift 3s ease infinite;
            text-decoration: none;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(79, 70, 229, 0.4);
            background-position: right center;
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4f46e5;
            border: 2px solid rgba(79, 70, 229, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #4f46e5;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.4);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        /* Payment App Integration Styles */
        .payment-app-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .payment-app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .payment-app-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .payment-app-card:hover::before {
            left: 100%;
        }

        .status-badge {
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
            animation: gradientShift 3s ease infinite;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4f46e5;
            border: 2px solid rgba(79, 70, 229, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #4f46e5;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
        }

        /* AI Chatbot */
        .ai-chat-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-size: 200% 200%;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            animation: pulse 2s infinite, gradientShift 3s ease infinite;
        }

        .ai-chat-toggle:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 15px 40px rgba(79, 70, 229, 0.5);
        }

        .ai-chat-toggle:active {
            transform: scale(1.05);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 8px 32px rgba(79, 70, 229, 0.4), 
                           0 0 0 0 rgba(79, 70, 229, 0.7);
            }
            70% {
                box-shadow: 0 8px 32px rgba(79, 70, 229, 0.4), 
                           0 0 0 15px rgba(79, 70, 229, 0);
            }
            100% {
                box-shadow: 0 8px 32px rgba(79, 70, 229, 0.4), 
                           0 0 0 0 rgba(79, 70, 229, 0);
            }
        }

        .ai-chat-panel {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 999;
        }

        .ai-chat-panel.active {
            display: flex;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            margin-right: auto;
        }

        .message.user {
            background: #4f46e5;
            color: white;
            margin-left: auto;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .chat-input input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            outline: none;
            font-family: inherit;
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .suggestion-btn {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.2);
            color: #4f46e5;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-btn:hover {
            background: #4f46e5;
            color: white;
        }

        /* Typing indicator animation */
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #4f46e5;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Chat action buttons */
        .chat-action-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .chat-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        /* Quick action button hover effects */
        .quick-action-btn:hover {
            background: rgba(79, 70, 229, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Export format buttons */
        .export-format-btn:hover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .export-format-btn:active {
            transform: translateY(0);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .data-table th {
            background: rgba(79, 70, 229, 0.05);
            font-weight: 600;
            color: #1e293b;
        }

        .data-table tr:hover {
            background: rgba(79, 70, 229, 0.02);
        }

        /* Footer */
        footer {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            color: white;
            padding: 3rem 2rem 1rem;
            margin-top: 4rem;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-section h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #e2e8f0;
        }

        .footer-section p,
        .footer-section a {
            color: #94a3b8;
            text-decoration: none;
            line-height: 1.6;
            margin-bottom: 0.5rem;
            display: block;
        }

        .footer-section a:hover {
            color: #4f46e5;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-links a {
            width: 40px;
            height: 40px;
            background: rgba(79, 70, 229, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            background: #4f46e5;
            color: white;
            transform: translateY(-2px);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Search and Filters */
        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .nav-container {
                padding: 1rem 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                padding: 1rem;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: var(--navbar-bg);
                backdrop-filter: blur(25px) saturate(150%);
                -webkit-backdrop-filter: blur(25px) saturate(150%);
                flex-direction: column;
                padding: 1.5rem;
                box-shadow: 0 20px 60px var(--shadow-medium);
                border-radius: 0 0 20px 20px;
                animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border-top: 1px solid var(--border-color);
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links a {
                padding: 1rem 0;
                font-size: 1.1rem;
                border-bottom: 1px solid var(--border-color);
                text-align: center;
                transition: all 0.3s ease;
            }

            .nav-links a:last-child {
                border-bottom: none;
            }

            .nav-links a:hover {
                background: rgba(79, 70, 229, 0.05);
                padding-left: 1rem;
                border-radius: 12px;
            }

            @keyframes slideDown {
                from { 
                    opacity: 0; 
                    transform: translateY(-20px); 
                }
                to { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }

            .mobile-menu {
                display: block;
                font-size: 1.5rem;
                color: #4f46e5;
                cursor: pointer;
                padding: 0.75rem;
                border-radius: 12px;
                transition: all 0.3s ease;
                background: rgba(79, 70, 229, 0.05);
            }

            .mobile-menu:hover {
                background: rgba(79, 70, 229, 0.15);
                transform: scale(1.05);
            }

            .mobile-menu:active {
                transform: scale(0.95);
            }

            .user-profile {
                gap: 0.75rem;
            }

            .theme-toggle {
                width: 42px;
                height: 22px;
                margin-right: 0.5rem;
            }

            .theme-toggle::before {
                width: 16px;
                height: 16px;
            }

            .theme-toggle.dark::before {
                transform: translateX(20px);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }

            .dashboard-title {
                font-size: 2.25rem;
                text-align: center;
            }

            .dashboard-subtitle {
                text-align: center;
                font-size: 1rem;
            }

            .ai-chat-panel {
                width: calc(100vw - 2rem);
                right: 1rem;
                height: 450px;
                border-radius: 20px 20px 0 0;
                bottom: 80px;
            }

            .ai-chat-toggle {
                width: 60px;
                height: 60px;
                bottom: 1.5rem;
                right: 1.5rem;
            }

            main {
                padding: 1.25rem;
                margin-top: 80px;
            }

            .search-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .search-box,
            .filter-select {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
                gap: 1rem;
                margin-top: 1.5rem;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 85vh;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .notifications-panel {
                right: 1rem;
                width: calc(100vw - 2rem);
                max-height: 350px;
                top: 70px;
            }

            .expense-chart {
                height: 280px;
            }

            .chart-container,
            .insights-panel,
            .transactions-list {
                padding: 1.5rem;
                border-radius: 16px;
            }

            .transaction-item {
                padding: 1.25rem 0;
                flex-wrap: wrap;
            }

            .transaction-icon {
                width: 40px;
                height: 40px;
            }

            .stat-card {
                padding: 1.75rem;
                text-align: center;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                margin: 0 auto 1rem;
            }

            .insight-item {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .budget-item {
                margin-bottom: 1.25rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 1rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.75rem;
            }

            main {
                padding: 1rem;
                margin-top: 70px;
            }

            .nav-container {
                padding: 0.75rem 1rem;
            }

            .logo {
                font-size: 1.25rem;
            }

            .user-profile {
                gap: 0.5rem;
            }

            .theme-toggle {
                width: 38px;
                height: 20px;
                margin-right: 0.25rem;
            }

            .theme-toggle::before {
                width: 14px;
                height: 14px;
            }

            .theme-toggle.dark::before {
                transform: translateX(18px);
            }

            .notification-icon {
                padding: 0.5rem;
                font-size: 1.1rem;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .modal-content {
                padding: 1.25rem;
                width: 98%;
                margin: 0.5rem;
                border-radius: 12px;
            }

            .stat-value {
                font-size: 1.75rem;
            }

            .dashboard-title {
                font-size: 1.875rem;
            }

            .dashboard-subtitle {
                font-size: 0.95rem;
            }

            .form-group {
                margin-bottom: 1.25rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.875rem;
                border-radius: 10px;
            }

            .btn {
                padding: 0.875rem 1.5rem;
                border-radius: 12px;
                font-size: 0.95rem;
            }

            .receipt-upload-area {
                padding: 1.25rem;
                border-radius: 10px;
            }

            .ai-chat-toggle {
                width: 55px;
                height: 55px;
                bottom: 1.25rem;
                right: 1.25rem;
                font-size: 1.5rem;
            }

            .ai-chat-panel {
                height: 400px;
                bottom: 85px;
            }

            .chat-messages {
                padding: 0.75rem;
            }

            .message {
                padding: 0.75rem 1rem;
                margin-bottom: 0.75rem;
                border-radius: 10px;
                font-size: 0.9rem;
            }

            .chat-input {
                padding: 0.75rem;
            }

            .chat-input input {
                padding: 0.75rem;
                border-radius: 10px;
            }

            .stats-grid {
                gap: 1rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-icon {
                width: 45px;
                height: 45px;
            }

            .chart-container,
            .insights-panel,
            .transactions-list {
                padding: 1.25rem;
            }

            .panel-title {
                font-size: 1.1rem;
                margin-bottom: 1.25rem;
            }

            .insight-item {
                padding: 1rem;
                border-radius: 10px;
            }

            .insight-icon {
                width: 28px;
                height: 28px;
            }

            .transaction-item {
                padding: 1rem 0;
            }

            .transaction-icon {
                width: 35px;
                height: 35px;
            }

            .transaction-amount {
                font-size: 0.95rem;
            }

            .budget-item {
                margin-bottom: 1rem;
            }

            .progress-bar {
                height: 6px;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .dashboard-title {
                font-size: 1.625rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .ai-chat-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .modal-content {
                padding: 1rem;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }
        }

        /* Touch-friendly enhancements */
        @media (pointer: coarse) {
            .btn,
            .notification-icon,
            .mobile-menu,
            .theme-toggle,
            .user-avatar {
                min-height: 44px;
                min-width: 44px;
            }

            .nav-links a {
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stat-card,
            .insight-item,
            .transaction-item,
            .budget-item {
                min-height: 48px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                min-height: 48px;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .ai-chat-panel {
                height: 350px;
            }

            .modal-content {
                max-height: 80vh;
            }

            .notifications-panel {
                max-height: 280px;
            }
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Success/Error Messages */
        .toast {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
            z-index: 1500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3730a3;
        }

        /* Enhanced Animations */
        @keyframes slideInLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        /* Icon Buttons */
        .btn-icon {
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            transform: translateY(-2px);
        }

        .btn-icon.btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Tags */
        .tag {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Goal Cards */
        .goal-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .goal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .goal-header h4 {
            margin: 0;
            color: #1e293b;
            font-weight: 600;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .goal-amount {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Authentication Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-container.active {
            display: flex;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
        }

        .auth-header {
            margin-bottom: 2rem;
        }

        .auth-header h2 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 2rem;
            font-weight: 700;
        }

        .auth-header p {
            color: #64748b;
            font-size: 1rem;
        }

        .auth-tabs {
            display: flex;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 12px;
            margin-bottom: 2rem;
            padding: 0.25rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: #4f46e5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .auth-form {
            text-align: left;
        }

        .auth-form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1e293b;
        }

        .auth-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .auth-form-group.error input {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .auth-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-submit {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
        }

        .auth-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            margin: 1.5rem 0;
            text-align: center;
            position: relative;
            color: #64748b;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
        }

        .auth-divider span {
            background: rgba(255, 255, 255, 0.95);
            padding: 0 1rem;
        }

        .social-auth {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .social-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .social-btn:hover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }

        .forgot-password {
            text-align: center;
            margin-top: 1rem;
        }

        .forgot-password a {
            color: #4f46e5;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 1000;
            animation: slideInDown 0.3s ease-out;
        }

        .profile-dropdown.active {
            display: block;
        }

        .profile-dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .profile-dropdown-header h4 {
            margin: 0 0 0.25rem;
            color: #1e293b;
            font-size: 1rem;
        }

        .profile-dropdown-header p {
            margin: 0;
            color: #64748b;
            font-size: 0.875rem;
        }

        .profile-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            color: #64748b;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-dropdown-item:hover {
            background: rgba(79, 70, 229, 0.05);
            color: #4f46e5;
        }

        .profile-dropdown-item:last-child {
            border-bottom: none;
        }

        .profile-dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.05);
            color: #ef4444;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .user-avatar.guest {
            background: #64748b;
        }

        /* Financial Goal Tracking Enhancements */
        .goal-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .goal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .goal-card.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
            border-color: rgba(76, 175, 80, 0.5);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .goal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .goal-category {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .goal-progress-container {
            margin: 1rem 0;
        }

        .goal-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 6px;
            transition: width 0.8s ease;
            position: relative;
        }

        .goal-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .goal-progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .goal-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .goal-timeline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .goal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .goal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
        }

        .goal-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .goal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .goal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .milestone-celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            z-index: 10000;
            border: 2px solid var(--primary-color);
            animation: celebrationPop 0.5s ease;
            display: none;
        }

        @keyframes celebrationPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .celebration-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        .goal-recommendations {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(138, 43, 226, 0.05));
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .recommendation-title {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recommendation-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
        }

        .add-goal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .add-goal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
        }
    </style>
    <link rel="stylesheet" href="style.css">
            </ul>
            
            <div class="user-profile">
                <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                </div>
                <div class="notification-icon" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">3</span>
                </div>
                <div class="notification-icon" onclick="openModal('settingsModal')" title="Settings">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleProfileDropdown()">
                    <span id="userInitials">G</span>
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-dropdown-header" id="profileHeader">
                            <h4 id="profileName">Guest User</h4>
                            <p id="profileEmail">guest@financeai.com</p>
                        </div>
                        <div class="profile-dropdown-item" onclick="showProfileSettings()">
                            <i class="fas fa-user"></i>
                            Profile Settings
                        </div>
                        <div class="profile-dropdown-item" onclick="showAccountSettings()">
                            <i class="fas fa-cog"></i>
                            Account Settings
                        </div>
                        <div class="profile-dropdown-item" onclick="showBillingInfo()">
                            <i class="fas fa-credit-card"></i>
                            Billing & Plans
                        </div>
                        <div class="profile-dropdown-item" onclick="showHelpSupport()">
                            <i class="fas fa-question-circle"></i>
                            Help & Support
                        </div>
                        <div class="profile-dropdown-item danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign Out
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mobile-menu" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notification-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: var(--text-primary);">Notifications</h3>
                    <button onclick="showNotificationSettings()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s ease;" title="Notification Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <div id="notificationsList">
                <div class="notification-item unread">
                    <h4>Welcome! 👋</h4>
                    <p>Your personal finance assistant is ready to help you manage your money better</p>
                    <small>Just now</small>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Financial Dashboard</h1>
                    <p class="dashboard-subtitle" id="dashboardSubtitle">Welcome back, Guest! Here's your financial overview</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card" style="--card-color: #10b981; --card-color-alt: #059669;" onclick="showStatDetails('balance')">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalBalance">₹45,250</div>
                        <div class="stat-label">Total Balance</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +12.5% this month
                        </div>
                    </div>

                    <div class="stat-card" style="--card-color: #ef4444; --card-color-alt: #dc2626;" onclick="showStatDetails('expenses')">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalExpenses">₹8,430</div>
                        <div class="stat-label">Monthly Expenses</div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-down"></i>
                            -5.2% vs last month
                        </div>
                    </div>

                    <div class="stat-card" style="--card-color: #4f46e5; --card-color-alt: #7c3aed;" onclick="showStatDetails('savings')">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-piggy-bank"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalSavings">₹12,800</div>
                        <div class="stat-label">Total Savings</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +8.3% this month
                        </div>
                    </div>

                    <div class="stat-card" style="--card-color: #f59e0b; --card-color-alt: #d97706;" onclick="showStatDetails('investments')">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalInvestments">₹25,600</div>
                        <div class="stat-label">Investments</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +15.7% this month
                        </div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Expense Chart -->
                    <div class="chart-container">
                        <h3 class="panel-title">Monthly Expense Breakdown</h3>
                        <div class="expense-chart">
                            <canvas id="expenseChart"></canvas>
                        </div>
                        <div class="action-buttons">
                            <button class="btn" onclick="exportChart()">
                                <i class="fas fa-download"></i>
                                Export Chart
                            </button>
                            <button class="btn btn-secondary" onclick="showDetailedReport()">
                                <i class="fas fa-chart-bar"></i>
                                Detailed Report
                            </button>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="insights-panel">
                        <h3 class="panel-title">AI Financial Insights</h3>
                        
                        <div class="insight-item" onclick="showInsightDetails('savings')">
                            <div class="insight-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Smart Savings Tip</h4>
                                <p>You could save ₹1,200 monthly by reducing dining out expenses by 30%</p>
                            </div>
                        </div>

                        <div class="insight-item" onclick="showInsightDetails('budget')">
                            <div class="insight-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Budget Alert</h4>
                                <p>You've spent 85% of your entertainment budget this month</p>
                            </div>
                        </div>

                        <div class="insight-item" onclick="showInsightDetails('investment')">
                            <div class="insight-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Investment Opportunity</h4>
                                <p>Consider investing your surplus ₹5,000 in diversified mutual funds</p>
                            </div>
                        </div>

                        <!-- Budget Progress -->
                        <h4 style="margin: 2rem 0 1rem; color: #1e293b; font-size: 1rem;">Monthly Budget Progress</h4>
                        
                        <div class="budget-item" onclick="showBudgetDetails('food')">
                            <div class="budget-header">
                                <span class="budget-name">Food & Dining</span>
                                <span class="budget-amount">₹3,450 / ₹5,000</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 69%;"></div>
                            </div>
                        </div>

                        <div class="budget-item" onclick="showBudgetDetails('transport')">
                            <div class="budget-header">
                                <span class="budget-name">Transportation</span>
                                <span class="budget-amount">₹2,100 / ₹2,500</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill warning" style="width: 84%;"></div>
                            </div>
                        </div>

                        <div class="budget-item" onclick="showBudgetDetails('entertainment')">
                            <div class="budget-header">
                                <span class="budget-name">Entertainment</span>
                                <span class="budget-amount">₹2,550 / ₹3,000</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill danger" style="width: 85%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="transactions-list">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Recent Transactions</h3>
                        <button class="btn" onclick="addTransaction()">
                            <i class="fas fa-plus"></i>
                            Add Transaction
                        </button>
                    </div>
                    
                    <div id="transactionsList">
                        <!-- Transactions will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Financial Goals -->
                <div class="transactions-list" style="margin-top: 2rem;">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Financial Goals</h3>
                        <button class="btn btn-secondary" onclick="showAddGoalModal()">
                            <i class="fas fa-plus"></i>
                            Add Goal
                        </button>
                    </div>
                    
                    <!-- Goal Recommendations -->
                    <div class="goal-recommendations" id="goalRecommendations">
                        <div class="recommendation-title">
                            <i class="fas fa-lightbulb"></i>
                            <span>Smart Recommendations</span>
                        </div>
                        <div id="recommendationsList">
                            <!-- Recommendations will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div id="goalsContainer">
                        <!-- Goals will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Add Goal Modal -->
                <div class="add-goal-modal" id="addGoalModal">
                    <div class="add-goal-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: var(--text-primary);">Add New Goal</h2>
                            <button onclick="closeAddGoalModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="goalForm" onsubmit="submitGoal(event)">
                            <div class="form-group">
                                <label for="goalTitle">Goal Title</label>
                                <input type="text" id="goalTitle" required placeholder="e.g., Emergency Fund">
                            </div>
                            
                            <div class="form-group">
                                <label for="goalCategory">Category</label>
                                <select id="goalCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Emergency Fund">Emergency Fund</option>
                                    <option value="Vacation">Vacation</option>
                                    <option value="House">House Purchase</option>
                                    <option value="Car">Car Purchase</option>
                                    <option value="Education">Education</option>
                                    <option value="Retirement">Retirement</option>
                                    <option value="Investment">Investment</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="goalAmount">Target Amount (₹)</label>
                                <input type="number" id="goalAmount" required min="1" placeholder="100000">
                            </div>
                            
                            <div class="form-group">
                                <label for="goalCurrentAmount">Current Amount (₹)</label>
                                <input type="number" id="goalCurrentAmount" min="0" placeholder="0" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="goalDeadline">Target Date</label>
                                <input type="date" id="goalDeadline" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="goalDescription">Description (Optional)</label>
                                <textarea id="goalDescription" rows="3" placeholder="Additional details about your goal..."></textarea>
                            </div>
                            
                            <div class="goal-actions">
                                <button type="button" class="goal-btn goal-btn-secondary" onclick="closeAddGoalModal()">Cancel</button>
                                <button type="submit" class="goal-btn goal-btn-primary">Create Goal</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Milestone Celebration Modal -->
                <div class="milestone-celebration" id="celebrationModal">
                    <div class="celebration-emoji">🎉</div>
                    <h2 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Congratulations!</h2>
                    <p id="celebrationMessage" style="margin: 0 0 1.5rem 0; color: var(--text-secondary);">You've reached a milestone!</p>
                    <button onclick="closeCelebration()" class="goal-btn goal-btn-primary">Continue</button>
                </div>
            </section>

            <!-- Expenses Section -->
            <section id="expenses" class="section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Expense Tracking</h1>
                    <p class="dashboard-subtitle">Monitor and categorize your spending</p>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" placeholder="Search expenses..." id="expenseSearch" onkeyup="filterExpenses()">
                    </div>
                    <select class="filter-select" id="categoryFilter" onchange="filterExpenses()">
                        <option value="">All Categories</option>
                        <option value="Food">Food & Dining</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Bills">Bills & Utilities</option>
                    </select>
                    <select class="filter-select" id="dateFilter" onchange="filterExpenses()">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="addTransaction('expense')">
                        <i class="fas fa-plus"></i>
                        Add Expense
                    </button>
                    <button class="btn" onclick="addTransaction('income')" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-plus-circle"></i>
                        Add Income
                    </button>
                    <button class="btn" onclick="addQuickCashExpense()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="fas fa-money-bill-wave"></i>
                        Quick Cash
                    </button>
                    <button class="btn btn-secondary" onclick="bulkImport()">
                        <i class="fas fa-upload"></i>
                        Bulk Import
                    </button>
                    <button class="btn btn-secondary" onclick="exportExpenses()">
                        <i class="fas fa-download"></i>
                        Export CSV
                    </button>
                    <!-- Advanced Features -->
                    <button class="btn" onclick="scanReceipt()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-camera"></i>
                        Scan Receipt
                    </button>
                    <button class="btn btn-secondary" onclick="showRecurringTransactions()">
                        <i class="fas fa-redo"></i>
                        Recurring
                    </button>
                    <button class="btn btn-secondary" onclick="showInsights()">
                        <i class="fas fa-lightbulb"></i>
                        AI Insights
                    </button>
                    <button class="btn btn-secondary" onclick="showAdvancedAnalytics()">
                        <i class="fas fa-chart-line"></i>
                        Analytics
                    </button>
                </div>

                <div class="stat-card">
                    <table class="data-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Expenses will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Budget Section -->
            <section id="budget" class="section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Budget Management</h1>
                    <p class="dashboard-subtitle">Create and manage your personalized budgets</p>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="createBudget()">
                        <i class="fas fa-plus"></i>
                        Create Budget
                    </button>
                    <button class="btn btn-secondary" onclick="copyPreviousBudget()">
                        <i class="fas fa-copy"></i>
                        Copy Previous Budget
                    </button>
                    <button class="btn btn-secondary" onclick="generateBudget()">
                        <i class="fas fa-magic"></i>
                        AI Generate Budget
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" id="budgetOverview">
                        <h3>Budget Overview</h3>
                        <div id="budgetProgressList">
                            <!-- Budget progress will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Investments Section -->
            <section id="investments" class="section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Investment Portfolio</h1>
                    <p class="dashboard-subtitle">Track and optimize your investments</p>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="addInvestment()">
                        <i class="fas fa-plus"></i>
                        Add Investment
                    </button>
                    <button class="btn btn-secondary" onclick="viewRecommendations()">
                        <i class="fas fa-lightbulb"></i>
                        AI Recommendations
                    </button>
                    <button class="btn btn-secondary" onclick="portfolioAnalysis()">
                        <i class="fas fa-chart-pie"></i>
                        Portfolio Analysis
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="chart-container">
                            <h3 class="panel-title">Portfolio Performance</h3>
                            <canvas id="portfolioChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Financial Analytics</h1>
                    <p class="dashboard-subtitle">Deep insights into your financial health</p>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i>
                        Generate Report
                    </button>
                    <button class="btn btn-secondary" onclick="compareMonths()">
                        <i class="fas fa-balance-scale"></i>
                        Compare Months
                    </button>
                    <button class="btn btn-secondary" onclick="forecastAnalysis()">
                        <i class="fas fa-crystal-ball"></i>
                        Financial Forecast
                    </button>
                </div>

                <div class="dashboard-grid">
                    <div class="chart-container">
                        <h3 class="panel-title">Spending Trends</h3>
                        <canvas id="trendsChart" style="height: 300px;"></canvas>
                    </div>

                    <div class="insights-panel">
                        <h3 class="panel-title">Financial Health Score</h3>
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; font-weight: bold; color: #10b981; margin-bottom: 1rem;">82</div>
                            <p style="color: #64748b;">Good financial health</p>
                            <div style="margin-top: 1rem;">
                                <div class="progress-bar" style="height: 12px;">
                                    <div class="progress-fill" style="width: 82%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- AI Chatbot -->
    <button class="ai-chat-toggle" onclick="toggleChat()">
        <i class="fas fa-robot"></i>
    </button>

    <div class="ai-chat-panel" id="chatPanel">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-robot" style="color: white; font-size: 1.2rem;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; color: var(--text-primary);">AI Assistant</h3>
                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">💡 Smart financial insights</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div class="status-indicator" style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                <span style="font-size: 0.75rem; color: #10b981; font-weight: 500;">Online</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div style="display: flex; align-items: start; gap: 0.5rem;">
                    <div style="width: 24px; height: 24px; background: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.25rem;">
                        <i class="fas fa-robot" style="color: white; font-size: 0.7rem;"></i>
                    </div>
                    <div>
                        <p>Hello! I'm your AI financial assistant. I can help you with budget analysis, spending insights, investment advice, and goal tracking. What would you like to explore?</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Action Buttons -->
        <div class="chat-quick-actions" style="padding: 1rem; border-top: 1px solid var(--border-color); background: rgba(79, 70, 229, 0.02);">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                <button class="quick-action-btn" onclick="sendQuickAction('analyze_spending')" style="padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie" style="color: #ef4444;"></i>
                    <span>Analyze Spending</span>
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('budget_tips')" style="padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                    <span>Budget Tips</span>
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('investment_advice')" style="padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-line" style="color: #10b981;"></i>
                    <span>Investment</span>
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('goal_progress')" style="padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-target" style="color: #8b5cf6;"></i>
                    <span>Goals</span>
                </button>
            </div>
        </div>

        <div class="chat-suggestions">
            <button class="suggestion-btn" onclick="sendSuggestion('Show my spending trends for this month')">📊 Monthly Trends</button>
            <button class="suggestion-btn" onclick="sendSuggestion('How can I optimize my budget?')">💰 Optimize Budget</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Suggest investment opportunities')">📈 Investment Ideas</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Track my financial goals')">🎯 Goal Tracking</button>
        </div>
        <div class="chat-input">
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" placeholder="Ask about your finances..." onkeypress="handleChatInput(event)" id="chatInput" style="flex: 1;">
                <button onclick="sendChatMessage()" style="padding: 0.75rem; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add Transaction Modal -->
    <div class="modal" id="addTransactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Transaction</h3>
                <button class="modal-close" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <form onsubmit="submitTransaction(event)">
                <div class="form-group">
                    <label>Type</label>
                    <select id="transactionType" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="transactionAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="transactionCategory" required>
                        <option value="">Select Category</option>
                        <option value="Food">Food & Dining</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Bills">Bills & Utilities</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="transactionDescription" required placeholder="e.g., Lunch at restaurant">
                </div>
                
                <!-- Payment Method -->
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="transactionPaymentMethod">
                        <option value="cash">Cash</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="upi">UPI/Digital Wallet</option>
                        <option value="netbanking">Net Banking</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- Receipt Upload -->
                <div class="form-group">
                    <label>Receipt/Bill (optional)</label>
                    <div class="receipt-upload-area" style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('receiptFile').click()">
                        <input type="file" id="receiptFile" accept="image/*,.pdf" style="display: none;" onchange="handleReceiptUpload(event)">
                        <i class="fas fa-camera" style="font-size: 2rem; color: #64748b; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Click to upload receipt or take photo</p>
                        <small style="color: #94a3b8; font-size: 0.8rem;">Supports images and PDF files</small>
                        <div id="receiptPreview" style="margin-top: 1rem; display: none;">
                            <div style="background: rgba(79, 70, 229, 0.1); padding: 0.5rem 1rem; border-radius: 8px; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-image" style="color: #4f46e5;"></i>
                                <span id="receiptFileName" style="font-size: 0.9rem;"></span>
                                <button type="button" onclick="removeReceipt()" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location (for cash transactions) -->
                <div class="form-group" id="locationGroup" style="display: none;">
                    <label>Location (optional)</label>
                    <input type="text" id="transactionLocation" placeholder="e.g., Mall, Restaurant name">
                    <small style="color: #64748b; font-size: 0.875rem;">Helpful for cash transactions</small>
                </div>
                
                <div class="form-group">
                    <label>Tags (optional)</label>
                    <input type="text" id="transactionTags" placeholder="e.g., food, delivery, weekend (comma separated)">
                    <small style="color: #64748b; font-size: 0.875rem;">Add tags to categorize and search your transactions easily</small>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Add Transaction</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Budget Modal -->
    <div class="modal" id="createBudgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Budget</h3>
                <button class="modal-close" onclick="closeModal('createBudgetModal')">&times;</button>
            </div>
            <form onsubmit="submitBudget(event)">
                <div class="form-group">
                    <label>Budget Name</label>
                    <input type="text" id="budgetName" required placeholder="e.g., Monthly Food Budget">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="budgetCategory" required>
                        <option value="">Select Category</option>
                        <option value="Food">Food & Dining</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Bills">Bills & Utilities</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monthly Budget Amount (₹)</label>
                    <input type="number" id="budgetAmount" step="0.01" required min="1">
                </div>
                <div class="form-group">
                    <label>Alert Threshold (%)</label>
                    <input type="number" id="budgetThreshold" value="80" min="50" max="100" 
                           placeholder="Alert when reaching this % of budget">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="budgetStartDate" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Create Budget</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createBudgetModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <div class="form-group">
                    <label>Data Management</label>
                    <div class="action-buttons" style="flex-direction: column; align-items: stretch;">
                        <button class="btn" onclick="exportAllData()">
                            <i class="fas fa-download"></i>
                            Export All Data (JSON)
                        </button>
                        <button class="btn" onclick="exportTransactionsCSV()">
                            <i class="fas fa-file-csv"></i>
                            Export Transactions (CSV)
                        </button>
                        <button class="btn" onclick="exportBudgetsCSV()">
                            <i class="fas fa-chart-bar"></i>
                            Export Budgets (CSV)
                        </button>
                        <button class="btn btn-secondary" onclick="bulkImport()">
                            <i class="fas fa-upload"></i>
                            Import Data
                        </button>
                        <button class="btn btn-warning" onclick="restoreEmergencyBackup()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-undo"></i>
                            Restore Emergency Backup
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i>
                            Clear All Data
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notifications</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="notificationsEnabled" checked onchange="toggleNotifications()">
                        <label for="notificationsEnabled" style="margin: 0;">Enable budget alerts and notifications</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Auto-Backup</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="autoBackupEnabled" checked onchange="toggleAutoBackup()">
                        <label for="autoBackupEnabled" style="margin: 0;">Automatically backup data locally</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>App Info</label>
                    <div style="padding: 1rem; background: rgba(79, 70, 229, 0.05); border-radius: 12px;">
                        <p><strong>Version:</strong> 2.0</p>
                        <p><strong>Last Backup:</strong> <span id="lastBackupTime">Just now</span></p>
                        <p><strong>Total Transactions:</strong> <span id="totalTransactions">${appData.transactions.length}</span></p>
                        <p><strong>Data Size:</strong> <span id="dataSize">Calculating...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Expense Fetching Modal -->
    <div class="modal" id="autoExpenseModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Auto Expense Fetching</h3>
                <button class="modal-close" onclick="closeModal('autoExpenseModal')">&times;</button>
            </div>
            
            <div style="padding: 1rem 0;">
                <!-- Payment App Integration -->
                <div class="form-group">
                    <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">Connect Payment Apps</label>
                    
                    <div class="payment-app-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        
                        <!-- Paytm Integration -->
                        <div class="payment-app-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="connectPaymentApp('paytm')">
                            <div style="background: #002970; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">P</div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">Paytm</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Auto-fetch UPI & wallet transactions</p>
                            <div class="connection-status" style="margin-top: 1rem;">
                                <span class="status-badge" style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">Not Connected</span>
                            </div>
                        </div>
                        
                        <!-- Google Pay Integration -->
                        <div class="payment-app-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="connectPaymentApp('googlepay')">
                            <div style="background: #4285f4; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.2rem;">₹</div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">Google Pay</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Import transaction history</p>
                            <div class="connection-status" style="margin-top: 1rem;">
                                <span class="status-badge" style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">Not Connected</span>
                            </div>
                        </div>
                        
                        <!-- PhonePe Integration -->
                        <div class="payment-app-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="connectPaymentApp('phonepe')">
                            <div style="background: #5f259f; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.2rem; font-weight: bold;">Pe</div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">PhonePe</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Sync digital payments</p>
                            <div class="connection-status" style="margin-top: 1rem;">
                                <span class="status-badge" style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">Not Connected</span>
                            </div>
                        </div>
                        
                        <!-- Bank UPI -->
                        <div class="payment-app-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="connectPaymentApp('bankupi')">
                            <div style="background: #10b981; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1rem; font-weight: bold;">UPI</div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">Bank UPI</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Connect bank account</p>
                            <div class="connection-status" style="margin-top: 1rem;">
                                <span class="status-badge" style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">Not Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SMS/Message Integration -->
                <div class="form-group">
                    <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">SMS Transaction Parsing</label>
                    <div style="background: rgba(79, 70, 229, 0.05); border: 2px dashed #4f46e5; border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
                        <i class="fas fa-sms" style="font-size: 2rem; color: #4f46e5; margin-bottom: 1rem;"></i>
                        <h4 style="margin: 0 0 0.5rem; color: #1e293b;">Automatic SMS Parsing</h4>
                        <p style="margin: 0 0 1rem; color: #64748b;">We'll automatically detect and parse transaction SMS from banks and payment apps</p>
                        <button class="btn" onclick="enableSMSParsing()" style="background: #4f46e5;">
                            <i class="fas fa-mobile-alt"></i>
                            Enable SMS Parsing
                        </button>
                    </div>
                </div>
                
                <!-- Manual CSV/Excel Upload -->
                <div class="form-group">
                    <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">Upload Bank Statements</label>
                    <div style="background: rgba(16, 185, 129, 0.05); border: 2px dashed #10b981; border-radius: 12px; padding: 2rem; text-align: center;">
                        <i class="fas fa-file-upload" style="font-size: 2rem; color: #10b981; margin-bottom: 1rem;"></i>
                        <h4 style="margin: 0 0 0.5rem; color: #1e293b;">Upload Bank Statement</h4>
                        <p style="margin: 0 0 1rem; color: #64748b;">Upload CSV/Excel files from your bank or payment app exports</p>
                        <input type="file" id="bankStatementFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                        <button class="btn" onclick="document.getElementById('bankStatementFile').click()" style="background: #10b981;">
                            <i class="fas fa-upload"></i>
                            Choose File
                        </button>
                    </div>
                </div>
                
                <!-- Auto-fetch Settings -->
                <div class="form-group">
                    <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">Auto-fetch Settings</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoFetchDaily" checked>
                            <label for="autoFetchDaily" style="margin: 0; font-size: 0.9rem;">Daily auto-fetch</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoFetchWeekly">
                            <label for="autoFetchWeekly" style="margin: 0; font-size: 0.9rem;">Weekly summary</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="duplicateDetection" checked>
                            <label for="duplicateDetection" style="margin: 0; font-size: 0.9rem;">Duplicate detection</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="smartCategorization" checked>
                            <label for="smartCategorization" style="margin: 0; font-size: 0.9rem;">Smart categorization</label>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" onclick="saveAutoFetchSettings()">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('autoExpenseModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Import Data</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            
            <div style="padding: 1rem 0;">
                <!-- Import Type Selection -->
                <div class="form-group">
                    <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">Choose Import Type</label>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <!-- JSON Import -->
                        <div class="import-type-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('jsonFile').click()">
                            <input type="file" id="jsonFile" accept=".json" style="display: none;" onchange="handleJSONImport(event)">
                            <div style="background: #4f46e5; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem;">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">JSON Backup</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Import complete app backup</p>
                        </div>
                        
                        <!-- CSV Import -->
                        <div class="import-type-card" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('csvFile').click()">
                            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSVImport(this.files[0])">
                            <div style="background: #10b981; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem;">
                                <i class="fas fa-file-csv"></i>
                            </div>
                            <h4 style="margin: 0 0 0.5rem; color: #1e293b;">CSV File</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Import bank statements or transactions</p>
                        </div>
                    </div>
                </div>
                
                <!-- CSV Format Guide -->
                <div class="form-group">
                    <label style="font-size: 1rem; margin-bottom: 0.5rem; display: block; color: #6b7280;">CSV Format Guide</label>
                    <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; font-size: 0.875rem;">
                        <p style="margin: 0 0 0.5rem; font-weight: 600; color: #3b82f6;">Supported Column Headers:</p>
                        <ul style="margin: 0; padding-left: 1.5rem; color: #64748b;">
                            <li><strong>Date:</strong> Date, Transaction Date, Txn Date</li>
                            <li><strong>Description:</strong> Description, Details, Particular, Narration</li>
                            <li><strong>Amount:</strong> Amount, Debit, Credit, Value</li>
                            <li><strong>Type:</strong> Type, Transaction Type, Dr/Cr</li>
                            <li><strong>Category:</strong> Category, Tag, Group</li>
                        </ul>
                        <p style="margin: 0.5rem 0 0; font-size: 0.8rem; color: #9ca3af;">
                            💡 The system will automatically map columns based on header names
                        </p>
                    </div>
                </div>
                
                <!-- Sample CSV Template -->
                <div class="form-group">
                    <label style="font-size: 1rem; margin-bottom: 0.5rem; display: block;">Download Sample Template</label>
                    <button class="btn btn-secondary" onclick="downloadSampleCSV()" style="width: 100%;">
                        <i class="fas fa-download"></i>
                        Download Sample CSV Template
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('importModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <div class="auth-header">
                <h2>Welcome to FinanceAI</h2>
                <p>Your intelligent personal finance companion</p>
                <div style="background: rgba(79, 70, 229, 0.1); padding: 1rem; border-radius: 12px; margin-top: 1rem; font-size: 0.875rem;">
                    <strong>Demo Credentials:</strong><br>
                    Email: demo@financeai.com<br>
                    Password: demo123
                </div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" id="signupTab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <form onsubmit="handleLogin(event)">
                    <div class="auth-form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="Enter your email">
                        <div class="auth-error" id="loginEmailError">Please enter a valid email address</div>
                    </div>
                    <div class="auth-form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                        <div class="auth-error" id="loginPasswordError">Password must be at least 6 characters</div>
                    </div>
                    <button type="submit" class="auth-submit" id="loginSubmit">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                </form>

                <div class="auth-divider">
                    <span>or continue with</span>
                </div>

                <div class="social-auth">
                    <button class="social-btn" onclick="socialLogin('google')">
                        <i class="fab fa-google"></i>
                        Google
                    </button>
                    <button class="social-btn" onclick="socialLogin('facebook')">
                        <i class="fab fa-facebook-f"></i>
                        Facebook
                    </button>
                </div>

                <div class="forgot-password">
                    <a href="#" onclick="showForgotPassword()">Forgot your password?</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div class="auth-form" id="signupForm" style="display: none;">
                <form onsubmit="handleSignup(event)">
                    <div class="auth-form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" required placeholder="Enter your full name">
                        <div class="auth-error" id="signupNameError">Please enter your full name</div>
                    </div>
                    <div class="auth-form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" required placeholder="Enter your email">
                        <div class="auth-error" id="signupEmailError">Please enter a valid email address</div>
                    </div>
                    <div class="auth-form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required placeholder="Create a password">
                        <div class="auth-error" id="signupPasswordError">Password must be at least 6 characters</div>
                    </div>
                    <div class="auth-form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" required placeholder="Confirm your password">
                        <div class="auth-error" id="confirmPasswordError">Passwords do not match</div>
                    </div>
                    <button type="submit" class="auth-submit" id="signupSubmit">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>

                <div class="auth-divider">
                    <span>or continue with</span>
                </div>

                <div class="social-auth">
                    <button class="social-btn" onclick="socialLogin('google')">
                        <i class="fab fa-google"></i>
                        Google
                    </button>
                    <button class="social-btn" onclick="socialLogin('facebook')">
                        <i class="fab fa-facebook-f"></i>
                        Facebook
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>FinanceAI</h3>
                    <p>Your intelligent personal finance manager, powered by advanced AI to help you achieve financial freedom and make smarter money decisions.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-github"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>

                <div class="footer-section">
                    <h3>Features</h3>
                    <a href="#" onclick="switchToSection('expenses')">Expense Tracking</a>
                    <a href="#" onclick="switchToSection('budget')">Smart Budgeting</a>
                    <a href="#" onclick="switchToSection('investments')">Investment Planning</a>
                    <a href="#" onclick="toggleChat()">AI Assistant</a>
                    <a href="#" onclick="switchToSection('analytics')">Financial Analytics</a>
                    <a href="#" onclick="showHelp()">24/7 Support</a>
                </div>

                <div class="footer-section">
                    <h3>Company</h3>
                    <a href="#" onclick="showAbout()">About Us</a>
                    <a href="#" onclick="showTeam()">Our Team</a>
                    <a href="#" onclick="showCareers()">Careers</a>
                    <a href="#" onclick="showPress()">Press</a>
                    <a href="#" onclick="showBlog()">Blog</a>
                    <a href="#" onclick="showContact()">Contact</a>
                </div>

                <div class="footer-section">
                    <h3>Support</h3>
                    <a href="#" onclick="showHelp()">Help Center</a>
                    <a href="#" onclick="showSecurity()">Security</a>
                    <a href="#" onclick="showPrivacy()">Privacy Policy</a>
                    <a href="#" onclick="showTerms()">Terms of Service</a>
                    <a href="#" onclick="showAPI()">API Documentation</a>
                    <a href="#" onclick="showStatus()">System Status</a>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 FinanceAI by TechTrek Learners - Chitkara University. All rights reserved.</p>
                <p>Developed by Dishu Singla, Pushkar, and Aryan Garg</p>
            </div>
        </div>
    </footer>

    <script>
        // Global Variables and State Management
        let appData = {
            transactions: [
                { id: 1, amount: 45000, category: 'Income', description: 'Salary Credit', date: '2025-09-16', type: 'income', tags: ['salary', 'monthly'] },
                { id: 2, amount: 450, category: 'Food', description: 'Swiggy Order', date: '2025-09-15', type: 'expense', tags: ['food', 'delivery'] },
                { id: 3, amount: 2100, category: 'Transportation', description: 'Fuel Station', date: '2025-09-14', type: 'expense', tags: ['fuel', 'car'] },
                { id: 4, amount: 1250, category: 'Shopping', description: 'Amazon Purchase', date: '2025-09-13', type: 'expense', tags: ['online', 'electronics'] },
                { id: 5, amount: 649, category: 'Entertainment', description: 'Netflix Subscription', date: '2025-09-12', type: 'expense', tags: ['subscription', 'streaming'] },
                { id: 6, amount: 3200, category: 'Bills', description: 'Electricity Bill', date: '2025-09-11', type: 'expense', tags: ['utilities', 'monthly'] },
                { id: 7, amount: 850, category: 'Healthcare', description: 'Medical Checkup', date: '2025-09-10', type: 'expense', tags: ['health', 'checkup'] }
            ],
            budgets: [
                { id: 1, category: 'Food', name: 'Food & Dining', budget: 5000, spent: 3450, startDate: '2025-09-01', alertThreshold: 80 },
                { id: 2, category: 'Transportation', name: 'Transportation', budget: 2500, spent: 2100, startDate: '2025-09-01', alertThreshold: 85 },
                { id: 3, category: 'Entertainment', name: 'Entertainment', budget: 3000, spent: 2550, startDate: '2025-09-01', alertThreshold: 75 },
                { id: 4, category: 'Shopping', name: 'Shopping', budget: 4000, spent: 2800, startDate: '2025-09-01', alertThreshold: 90 },
                { id: 5, category: 'Bills', name: 'Bills & Utilities', budget: 5000, spent: 3200, startDate: '2025-09-01', alertThreshold: 95 }
            ],
            investments: [
                { id: 1, name: 'Equity Mutual Fund', amount: 15000, returns: 12.5, type: 'mutual_fund', purchaseDate: '2025-01-15', currentValue: 16875 },
                { id: 2, name: 'Fixed Deposit', amount: 8000, returns: 6.8, type: 'fd', purchaseDate: '2025-03-01', currentValue: 8544 },
                { id: 3, name: 'PPF', amount: 2600, returns: 7.1, type: 'ppf', purchaseDate: '2025-04-01', currentValue: 2780 }
            ],
            notifications: [
                { id: 1, title: 'Budget Alert', message: 'You have exceeded 80% of your dining budget this month', time: '2 hours ago', read: false, type: 'warning' },
                { id: 2, title: 'Investment Opportunity', message: 'New SIP recommendation based on your goals', time: '1 day ago', read: false, type: 'info' },
                { id: 3, title: 'Monthly Report', message: 'Your September financial report is ready', time: '3 days ago', read: true, type: 'success' }
            ],
            goals: [
                { 
                    id: 1, 
                    name: 'Emergency Fund', 
                    target: 100000, 
                    current: 45250, 
                    deadline: '2025-12-31', 
                    priority: 'high',
                    category: 'Emergency Fund',
                    description: 'Building a safety net for unexpected expenses',
                    createdDate: '2025-01-01',
                    milestones: [25000, 50000, 75000, 100000],
                    achievedMilestones: [25000]
                },
                { 
                    id: 2, 
                    name: 'Dream Vacation to Japan', 
                    target: 50000, 
                    current: 15000, 
                    deadline: '2025-06-30', 
                    priority: 'medium',
                    category: 'Vacation',
                    description: 'Two weeks exploring Tokyo, Kyoto, and Mount Fuji',
                    createdDate: '2024-12-15',
                    milestones: [12500, 25000, 37500, 50000],
                    achievedMilestones: []
                },
                { 
                    id: 3, 
                    name: 'New Car Purchase', 
                    target: 200000, 
                    current: 25600, 
                    deadline: '2026-03-31', 
                    priority: 'low',
                    category: 'Car',
                    description: 'Saving for a reliable family car',
                    createdDate: '2024-11-01',
                    milestones: [50000, 100000, 150000, 200000],
                    achievedMilestones: []
                }
            ],
            settings: {
                currency: '₹',
                language: 'en',
                theme: 'light',
                notifications: true,
                autoBackup: true,
                dataEncryption: true
            }
        };

        // User Management System
        let currentUser = {
            id: null,
            name: 'Guest User',
            email: 'guest@financeai.com',
            avatar: null,
            isAuthenticated: false,
            joinDate: null,
            plan: 'free',
            preferences: {
                currency: '₹',
                dateFormat: 'DD/MM/YYYY',
                notifications: true
            }
        };

        // Simulated user database (in real app, this would be on server)
        let userDatabase = [
            {
                id: 1,
                name: 'Dishu Singla',
                email: 'dishu@example.com',
                password: 'password123', // In real app, this would be hashed
                avatar: null,
                joinDate: '2025-01-15',
                plan: 'premium'
            },
            {
                id: 2,
                name: 'Demo User',
                email: 'demo@financeai.com',
                password: 'demo123',
                avatar: null,
                joinDate: '2025-09-01',
                plan: 'free'
            },
            {
                id: 3,
                name: 'Test User',
                email: 'test@test.com',
                password: 'test123',
                avatar: null,
                joinDate: '2025-08-15',
                plan: 'premium'
            }
        ];

        let charts = {};
        let currentSection = 'dashboard';
        let chatOpen = false;
        let isLoading = false;
        let animationQueue = [];
        let lastBackup = localStorage.getItem('lastBackup') || Date.now();

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme(); // Initialize theme first
            addSwipeGestures(); // Add mobile swipe gestures
            initializeNotificationSystem(); // Initialize notifications
            showLoadingScreen();
            setTimeout(() => {
                initializeApp();
                hideLoadingScreen();
            }, 1500);
        });

        // Simple notification toggle for the panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                updateNotificationPanel();
                // Mark visible notifications as read after a delay
                setTimeout(() => {
                    notificationQueue.forEach(notification => {
                        if (!notification.read) {
                            notification.read = true;
                        }
                    });
                    localStorage.setItem('notifications', JSON.stringify(notificationQueue));
                    updateNotificationBadge();
                }, 2000);
            }
        }

        function showLoadingScreen() {
            const loadingHTML = `
                <div id="loadingScreen" style="
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    display: flex; 
                    flex-direction: column; 
                    justify-content: center; 
                    align-items: center; 
                    z-index: 9999;
                    color: white;
                ">
                    <div style="margin-bottom: 2rem;">
                        <i class="fas fa-chart-line" style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;"></i>
                        <h1 style="font-size: 2rem; margin: 0; font-weight: 700;">FinanceAI</h1>
                        <p style="margin: 0.5rem 0 0; opacity: 0.8;">Loading your financial dashboard...</p>
                    </div>
                    <div class="spinner"></div>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', loadingHTML);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                loadingScreen.style.transition = 'opacity 0.5s ease';
                setTimeout(() => loadingScreen.remove(), 500);
            }
        }

        function initializeApp() {
            // Check authentication status first
            checkAuthenticationStatus();
            
            if (!currentUser.isAuthenticated) {
                showAuthContainer();
                return;
            }

            loadDataFromStorage();
            setupNavigation();
            renderTransactions();
            renderExpensesTable();
            renderBudgets();
            renderGoals();
            initializeCharts();
            setupEventListeners();
            animateStats();
            simulateRealTimeUpdates();
            setupDataBackup();
            checkBudgetAlerts();
            updateUserProfile();
            
            // Show welcome message
            setTimeout(() => {
                addChatMessage(`Welcome back to FinanceAI, ${currentUser.name}! 🚀 I've loaded your latest financial data. How can I help you today?`, 'bot');
            }, 2000);
        }

        // Data Persistence and Backup
        function saveDataToStorage() {
            try {
                const dataToSave = {
                    ...appData,
                    lastModified: new Date().toISOString(),
                    version: '2.0'
                };
                localStorage.setItem('financeAI_data', JSON.stringify(dataToSave));
                localStorage.setItem('lastBackup', Date.now());
                console.log('✅ Data saved successfully');
            } catch (error) {
                console.error('❌ Error saving data:', error);
                showToast('Failed to save data. Please try again.', 'error');
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('financeAI_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Merge with default data structure
                    appData = {
                        ...appData,
                        ...parsedData,
                        // Ensure arrays exist
                        transactions: parsedData.transactions || appData.transactions,
                        budgets: parsedData.budgets || appData.budgets,
                        investments: parsedData.investments || appData.investments,
                        notifications: parsedData.notifications || appData.notifications,
                        goals: parsedData.goals || appData.goals,
                        settings: { ...appData.settings, ...parsedData.settings }
                    };
                    
                    console.log('✅ Data loaded successfully');
                    showToast('Welcome back! Your data has been restored.', 'success');
                } else {
                    // First time user
                    saveDataToStorage();
                    showToast('Welcome to FinanceAI! Your data will be automatically saved.', 'success');
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showToast('Failed to load saved data. Using default data.', 'warning');
            }
        }

        function setupDataBackup() {
            // Auto-save every 30 seconds
            setInterval(() => {
                saveDataToStorage();
            }, 30000);

            // Save before page unload
            window.addEventListener('beforeunload', saveDataToStorage);
        }

        function exportData() {
            const dataToExport = {
                ...appData,
                exportDate: new Date().toISOString(),
                appVersion: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `financeAI_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (importedData.transactions && Array.isArray(importedData.transactions)) {
                        appData = { ...appData, ...importedData };
                        saveDataToStorage();
                        
                        // Refresh UI
                        renderTransactions();
                        renderExpensesTable();
                        renderBudgets();
                        renderGoals();
                        updateDashboardStats();
                        initializeCharts();
                        
                        showToast('Data imported successfully!', 'success');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('❌ Error importing data:', error);
                    showToast('Failed to import data. Please check the file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('⚠️ This will delete ALL your financial data. This action cannot be undone. Are you sure?')) {
                localStorage.removeItem('financeAI_data');
                localStorage.removeItem('lastBackup');
                location.reload();
            }
        }

        // Navigation Functions
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    this.classList.add('active');
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    currentSection = sectionId;
                    
                    // Initialize section-specific content
                    initializeSectionContent(sectionId);
                });
            });
        }

        function switchToSection(sectionId) {
            const navLink = document.querySelector(`[data-section="${sectionId}"]`);
            if (navLink) {
                navLink.click();
            }
        }

        function initializeSectionContent(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    updateDashboardStats();
                    break;
                case 'expenses':
                    renderExpensesTable();
                    break;
                case 'budget':
                    renderBudgets();
                    break;
                case 'investments':
                    initializePortfolioChart();
                    break;
                case 'analytics':
                    initializeTrendsChart();
                    break;
            }
        }

        // Transaction Management
        function renderTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            const recentTransactions = appData.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 8);
            
            transactionsList.innerHTML = recentTransactions.map((transaction, index) => `
                <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" 
                     style="animation: slideInLeft 0.3s ease ${index * 0.1}s both;">
                    <div class="transaction-icon" style="background: ${getTransactionColor(transaction.category)};">
                        <i class="${getTransactionIcon(transaction.category)}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-name">${transaction.description}</div>
                        <div class="transaction-category">
                            ${transaction.category} • ${formatDate(transaction.date)}
                            ${transaction.tags ? `• ${transaction.tags.slice(0, 2).map(tag => `<span class="tag">${tag}</span>`).join(' ')}` : ''}
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.type}">
                        ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString()}
                    </div>
                    <div class="transaction-actions">
                        <button class="btn-icon" onclick="duplicateTransaction(${transaction.id}); event.stopPropagation();" title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody) return;
            
            const filteredTransactions = getFilteredTransactions();
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No transactions found matching your criteria.</p>
                            <button class="btn" onclick="addTransaction()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Add Your First Transaction
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredTransactions.map((transaction, index) => `
                <tr onclick="showTransactionDetails(${transaction.id})" 
                    style="animation: fadeInUp 0.3s ease ${index * 0.05}s both;">
                    <td>${formatDate(transaction.date)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="transaction-icon" style="width: 24px; height: 24px; font-size: 0.7rem; background: ${getTransactionColor(transaction.category)};">
                                <i class="${getTransactionIcon(transaction.category)}"></i>
                            </div>
                            <div>
                                <div>${transaction.description}</div>
                                ${transaction.tags ? `<div style="font-size: 0.75rem; color: #64748b;">${transaction.tags.slice(0, 3).map(tag => `#${tag}`).join(' ')}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="background: ${getTransactionColor(transaction.category)}20; color: ${getTransactionColor(transaction.category)}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                            ${transaction.category}
                        </span>
                    </td>
                    <td class="${transaction.type}" style="font-weight: 600;">
                        ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString()}
                    </td>
                    <td>
                        <div class="action-buttons" style="gap: 0.25rem;">
                            <button class="btn-icon" onclick="editTransaction(${transaction.id}); event.stopPropagation();" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="duplicateTransaction(${transaction.id}); event.stopPropagation();" title="Duplicate">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="deleteTransaction(${transaction.id}); event.stopPropagation();" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function duplicateTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            const duplicatedTransaction = {
                ...transaction,
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                description: `${transaction.description} (Copy)`
            };
            
            appData.transactions.unshift(duplicatedTransaction);
            
            if (duplicatedTransaction.type === 'expense') {
                updateBudgetSpending(duplicatedTransaction.category, duplicatedTransaction.amount);
            }
            
            renderTransactions();
            renderExpensesTable();
            updateDashboardStats();
            saveDataToStorage();
            
            showToast('Transaction duplicated successfully!', 'success');
        }

        // Goals Management
        function renderGoals() {
            const goalsContainer = document.getElementById('goalsContainer');
            if (!goalsContainer) return;
            
            // Generate goal recommendations first
            generateGoalRecommendations();
            
            goalsContainer.innerHTML = appData.goals.map((goal, index) => {
                const progress = (goal.current / goal.target) * 100;
                const daysRemaining = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                const priorityColor = getPriorityColor(goal.priority);
                const categoryEmoji = getCategoryEmoji(goal.category);
                const isCompleted = progress >= 100;
                const nextMilestone = goal.milestones?.find(m => m > goal.current);
                const timeRemaining = getTimeRemaining(goal.deadline);
                
                return `
                    <div class="goal-card ${isCompleted ? 'completed' : ''}" 
                         style="animation: slideInUp 0.3s ease ${index * 0.1}s both;">
                        <div class="goal-header">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">${categoryEmoji}</span>
                                <div>
                                    <h3 class="goal-title">${goal.name}</h3>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${goal.description}</p>
                                </div>
                            </div>
                            <div class="goal-category">${goal.category}</div>
                        </div>
                        
                        <div class="goal-progress-container">
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                            </div>
                            <div class="goal-progress-text">
                                <span class="goal-amount">₹${goal.current.toLocaleString()}</span>
                                <span>${progress.toFixed(1)}% Complete</span>
                                <span class="goal-amount">₹${goal.target.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="goal-timeline">
                            <i class="fas fa-calendar-alt"></i>
                            <span>${timeRemaining}</span>
                            ${nextMilestone ? `<span style="margin-left: auto; color: var(--primary-color);">Next: ₹${nextMilestone.toLocaleString()}</span>` : ''}
                        </div>
                        
                        <div class="goal-actions">
                            <button class="goal-btn goal-btn-secondary" onclick="addMoneyToGoal(${goal.id}); event.stopPropagation();">
                                <i class="fas fa-plus"></i> Add Money
                            </button>
                            <button class="goal-btn goal-btn-primary" onclick="showGoalDetails(${goal.id}); event.stopPropagation();">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateGoalRecommendations() {
            const recommendationsContainer = document.getElementById('recommendationsList');
            if (!recommendationsContainer) return;
            
            const recommendations = [];
            const totalIncome = appData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const monthlyIncome = totalIncome / 12; // Approximate monthly income
            
            // Emergency fund recommendation
            const emergencyFund = appData.goals.find(g => g.category === 'Emergency Fund');
            if (!emergencyFund && monthlyIncome > 0) {
                recommendations.push({
                    icon: '🚨',
                    title: 'Create Emergency Fund',
                    description: `Build an emergency fund of ₹${(monthlyIncome * 6).toLocaleString()} (6 months of expenses) for financial security.`
                });
            }
            
            // Investment recommendation
            const hasInvestmentGoal = appData.goals.some(g => g.category === 'Investment');
            if (!hasInvestmentGoal && monthlyIncome > 30000) {
                recommendations.push({
                    icon: '📈',
                    title: 'Start Investment Goal',
                    description: 'Consider setting up an investment goal to grow your wealth through SIPs and mutual funds.'
                });
            }
            
            // Retirement planning
            const hasRetirementGoal = appData.goals.some(g => g.category === 'Retirement');
            if (!hasRetirementGoal && monthlyIncome > 20000) {
                recommendations.push({
                    icon: '🏖️',
                    title: 'Plan for Retirement',
                    description: 'Start early with retirement planning. Even ₹5,000/month can grow significantly over time.'
                });
            }
            
            if (recommendations.length === 0) {
                recommendationsContainer.innerHTML = `
                    <div class="recommendation-item">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>✨</span>
                            <span><strong>Great job!</strong> You're on track with your financial goals. Keep up the excellent work!</span>
                        </div>
                    </div>
                `;
            } else {
                recommendationsContainer.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-item">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">${rec.icon}</span>
                            <div>
                                <strong>${rec.title}</strong>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">${rec.description}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'high': return '#ef4444';
                case 'medium': return '#f59e0b';
                case 'low': return '#10b981';
                default: return '#6366f1';
            }
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'Emergency Fund': '🚨',
                'Vacation': '✈️',
                'House': '🏠',
                'Car': '🚗',
                'Education': '🎓',
                'Retirement': '🏖️',
                'Investment': '📈',
                'Other': '🎯'
            };
            return emojis[category] || '🎯';
        }

        function getTimeRemaining(deadline) {
            const now = new Date();
            const target = new Date(deadline);
            const diffTime = target - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'Overdue';
            if (diffDays === 0) return 'Due today';
            if (diffDays === 1) return '1 day left';
            if (diffDays <= 30) return `${diffDays} days left`;
            if (diffDays <= 365) {
                const months = Math.floor(diffDays / 30);
                return `${months} month${months > 1 ? 's' : ''} left`;
            }
            const years = Math.floor(diffDays / 365);
            return `${years} year${years > 1 ? 's' : ''} left`;
        }

        // Advanced Goal Management Functions
        function showAddGoalModal() {
            document.getElementById('addGoalModal').style.display = 'flex';
            // Set minimum date to today
            document.getElementById('goalDeadline').min = new Date().toISOString().split('T')[0];
        }

        function closeAddGoalModal() {
            document.getElementById('addGoalModal').style.display = 'none';
            document.getElementById('goalForm').reset();
        }

        function submitGoal(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const goalData = {
                id: appData.goals.length + 1,
                name: document.getElementById('goalTitle').value,
                category: document.getElementById('goalCategory').value,
                target: parseFloat(document.getElementById('goalAmount').value),
                current: parseFloat(document.getElementById('goalCurrentAmount').value) || 0,
                deadline: document.getElementById('goalDeadline').value,
                description: document.getElementById('goalDescription').value,
                priority: calculatePriority(document.getElementById('goalDeadline').value, parseFloat(document.getElementById('goalAmount').value)),
                createdDate: new Date().toISOString().split('T')[0],
                milestones: generateMilestones(parseFloat(document.getElementById('goalAmount').value)),
                achievedMilestones: []
            };
            
            appData.goals.push(goalData);
            closeAddGoalModal();
            renderGoals();
            saveData();
            
            showToast(`Goal "${goalData.name}" created successfully!`, 'success');
            
            // Check for immediate milestone achievement
            checkMilestoneAchievement(goalData);
        }

        function calculatePriority(deadline, amount) {
            const daysUntilDeadline = Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
            
            if (daysUntilDeadline <= 180 || amount >= 500000) return 'high';
            if (daysUntilDeadline <= 365 || amount >= 100000) return 'medium';
            return 'low';
        }

        function generateMilestones(targetAmount) {
            const milestones = [];
            const milestoneCount = 4;
            for (let i = 1; i <= milestoneCount; i++) {
                milestones.push(Math.round((targetAmount / milestoneCount) * i));
            }
            return milestones;
        }

        function addMoneyToGoal(goalId) {
            const goal = appData.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const amount = prompt(`Add money to "${goal.name}":\nCurrent: ₹${goal.current.toLocaleString()}\nTarget: ₹${goal.target.toLocaleString()}\n\nEnter amount to add:`);
            
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const previousAmount = goal.current;
                goal.current += parseFloat(amount);
                
                // Check for milestone achievement
                checkMilestoneAchievement(goal, previousAmount);
                
                renderGoals();
                saveData();
                showToast(`₹${parseFloat(amount).toLocaleString()} added to ${goal.name}!`, 'success');
            }
        }

        function checkMilestoneAchievement(goal, previousAmount = 0) {
            if (!goal.milestones) return;
            
            const newlyAchievedMilestones = goal.milestones.filter(milestone => 
                goal.current >= milestone && 
                previousAmount < milestone &&
                !goal.achievedMilestones.includes(milestone)
            );
            
            if (newlyAchievedMilestones.length > 0) {
                goal.achievedMilestones.push(...newlyAchievedMilestones);
                
                // Show celebration for the highest milestone achieved
                const highestMilestone = Math.max(...newlyAchievedMilestones);
                showMilestoneCelebration(goal, highestMilestone);
                
                // Add notification
                addNotification({
                    title: 'Milestone Achieved! 🎉',
                    message: `You've reached ₹${highestMilestone.toLocaleString()} in your "${goal.name}" goal!`,
                    type: 'success'
                });
            }
            
            // Check if goal is completed
            if (goal.current >= goal.target && !goal.completed) {
                goal.completed = true;
                showGoalCompletionCelebration(goal);
                
                addNotification({
                    title: 'Goal Completed! 🏆',
                    message: `Congratulations! You've achieved your "${goal.name}" goal of ₹${goal.target.toLocaleString()}!`,
                    type: 'success'
                });
            }
        }

        function showMilestoneCelebration(goal, milestone) {
            const modal = document.getElementById('celebrationModal');
            const message = document.getElementById('celebrationMessage');
            const progress = (goal.current / goal.target) * 100;
            
            message.textContent = `You've reached ₹${milestone.toLocaleString()} in your "${goal.name}" goal! You're ${progress.toFixed(1)}% complete!`;
            modal.style.display = 'block';
            
            // Auto close after 5 seconds
            setTimeout(() => {
                closeCelebration();
            }, 5000);
            
            // Play celebration sound
            playCelebrationSound();
        }

        function showGoalCompletionCelebration(goal) {
            const modal = document.getElementById('celebrationModal');
            const message = document.getElementById('celebrationMessage');
            const emoji = document.querySelector('.celebration-emoji');
            
            emoji.textContent = '🏆';
            message.textContent = `Amazing! You've completed your "${goal.name}" goal of ₹${goal.target.toLocaleString()}! Time to celebrate and set new goals!`;
            modal.style.display = 'block';
            
            // Enhanced celebration effects
            setTimeout(() => {
                emoji.textContent = '🎊';
            }, 1000);
            
            setTimeout(() => {
                emoji.textContent = '✨';
            }, 2000);
            
            playCelebrationSound();
        }

        function closeCelebration() {
            document.getElementById('celebrationModal').style.display = 'none';
            document.querySelector('.celebration-emoji').textContent = '🎉';
        }

        function playCelebrationSound() {
            // Create a simple celebration sound using Web Audio API
            if ('AudioContext' in window || 'webkitAudioContext' in window) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                
                notes.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime + index * 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + index * 0.2 + 0.3);
                    
                    oscillator.start(audioContext.currentTime + index * 0.2);
                    oscillator.stop(audioContext.currentTime + index * 0.2 + 0.3);
                });
            }
        }

        function showGoalDetails(goalId) {
            const goal = appData.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const progress = (goal.current / goal.target) * 100;
            const monthlyRequired = calculateMonthlyRequired(goal);
            
            const details = `
Goal: ${goal.name}
Category: ${goal.category}
Description: ${goal.description}

Progress: ₹${goal.current.toLocaleString()} / ₹${goal.target.toLocaleString()} (${progress.toFixed(1)}%)
Remaining: ₹${(goal.target - goal.current).toLocaleString()}

Deadline: ${new Date(goal.deadline).toLocaleDateString()}
Time Remaining: ${getTimeRemaining(goal.deadline)}

${monthlyRequired ? `Monthly Required: ₹${monthlyRequired.toLocaleString()}` : ''}

Milestones Achieved: ${goal.achievedMilestones?.length || 0} / ${goal.milestones?.length || 0}
            `;
            
            alert(details);
        }

        function calculateMonthlyRequired(goal) {
            const remaining = goal.target - goal.current;
            const deadline = new Date(goal.deadline);
            const now = new Date();
            const monthsRemaining = Math.max(1, Math.ceil((deadline - now) / (1000 * 60 * 60 * 24 * 30)));
            
            return Math.ceil(remaining / monthsRemaining);
        }

        // Budget Alerts and Notifications
        function checkBudgetAlerts() {
            appData.budgets.forEach(budget => {
                const percentage = (budget.spent / budget.budget) * 100;
                if (percentage >= budget.alertThreshold) {
                    const alertExists = appData.notifications.some(n => 
                        n.title.includes('Budget Alert') && 
                        n.message.includes(budget.name) &&
                        !n.read
                    );
                    
                    if (!alertExists) {
                        addNotification({
                            title: 'Budget Alert',
                            message: `You've reached ${percentage.toFixed(1)}% of your ${budget.name} budget`,
                            type: percentage >= 100 ? 'error' : 'warning'
                        });
                    }
                }
            });
        }

        function addNotification(notification) {
            const newNotification = {
                id: Date.now(),
                time: 'Just now',
                read: false,
                ...notification
            };
            
            appData.notifications.unshift(newNotification);
            updateNotificationBadge();
            saveDataToStorage();
            
            // Show toast for important alerts
            if (notification.type === 'warning' || notification.type === 'error') {
                showToast(notification.message, notification.type);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = appData.notifications.filter(n => !n.read).length;
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        function getFilteredTransactions() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const dateFilter = document.getElementById('dateFilter')?.value || '';
            
            return appData.transactions.filter(transaction => {
                const matchesSearch = transaction.description.toLowerCase().includes(searchTerm) || 
                                    transaction.category.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
                const matchesDate = !dateFilter || checkDateFilter(transaction.date, dateFilter);
                
                return matchesSearch && matchesCategory && matchesDate;
            });
        }

        function checkDateFilter(transactionDate, filter) {
            const today = new Date();
            const transactionDateObj = new Date(transactionDate);
            
            switch(filter) {
                case 'today':
                    return transactionDateObj.toDateString() === today.toDateString();
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return transactionDateObj >= weekAgo;
                case 'month':
                    return transactionDateObj.getMonth() === today.getMonth() && 
                           transactionDateObj.getFullYear() === today.getFullYear();
                case 'year':
                    return transactionDateObj.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        }

        function filterExpenses() {
            renderExpensesTable();
        }

        // Budget Management
        function renderBudgets() {
            const budgetList = document.getElementById('budgetProgressList');
            if (!budgetList) return;
            
            budgetList.innerHTML = appData.budgets.map(budget => {
                const percentage = (budget.spent / budget.budget) * 100;
                const status = percentage > 90 ? 'danger' : percentage > 75 ? 'warning' : '';
                
                return `
                    <div class="budget-item" onclick="showBudgetDetails('${budget.category.toLowerCase()}')">
                        <div class="budget-header">
                            <span class="budget-name">${budget.name}</span>
                            <span class="budget-amount">₹${budget.spent.toLocaleString()} / ₹${budget.budget.toLocaleString()}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${status}" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                        <small style="color: #64748b; margin-top: 0.5rem; display: block;">
                            ${percentage.toFixed(1)}% used • ₹${(budget.budget - budget.spent).toLocaleString()} remaining
                        </small>
                    </div>
                `;
            }).join('');
        }

        // Chart Management
        function initializeCharts() {
            initializeExpenseChart();
            initializePortfolioChart();
            initializeTrendsChart();
        }

        function initializeExpenseChart() {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            // Show loading state
            const chartContainer = ctx.parentElement;
            chartContainer.classList.add('chart-loading');
            
            const expensesByCategory = calculateExpensesByCategory();
            
            // Check if there's data
            if (Object.keys(expensesByCategory).length === 0) {
                chartContainer.classList.remove('chart-loading');
                ctx.style.display = 'none';
                
                // Show no data message
                let noDataMsg = chartContainer.querySelector('.no-data-message');
                if (!noDataMsg) {
                    noDataMsg = document.createElement('div');
                    noDataMsg.className = 'no-data-message';
                    noDataMsg.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">No Expense Data</h3>
                            <p>Add some transactions to see your expense breakdown</p>
                            <button class="btn" onclick="showSection('expenses')" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i>
                                Add Expense
                            </button>
                        </div>
                    `;
                    chartContainer.appendChild(noDataMsg);
                }
                return;
            }
            
            // Hide no data message if exists
            const noDataMsg = chartContainer.querySelector('.no-data-message');
            if (noDataMsg) {
                noDataMsg.remove();
            }
            ctx.style.display = 'block';
            
            // Destroy existing chart
            if (charts.expenseChart) {
                charts.expenseChart.destroy();
            }
            
            // Enhanced chart with drill-down and interactions
            charts.expenseChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)', 
                            'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(249, 115, 22, 0.8)', 
                            'rgba(6, 182, 212, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(20, 184, 166, 0.8)', 
                            'rgba(244, 114, 182, 0.8)', 'rgba(168, 85, 247, 0.8)', 'rgba(132, 204, 22, 0.8)'
                        ],
                        borderColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
                            '#8b5cf6', '#f97316', '#06b6d4', '#ec4899',
                            '#14b8a6', '#f472b6', '#a855f7', '#84cc16'
                        ],
                        borderWidth: 3,
                        hoverBorderWidth: 4,
                        hoverBackgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
                            '#8b5cf6', '#f97316', '#06b6d4', '#ec4899',
                            '#14b8a6', '#f472b6', '#a855f7', '#84cc16'
                        ],
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 13,
                                    weight: '500'
                                },
                                color: 'var(--text-primary)',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: 2,
                                                pointStyle: 'circle',
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            },
                            onClick: function(e, legendItem, legend) {
                                // Drill down into category details
                                const category = legend.chart.data.labels[legendItem.index];
                                showCategoryDetails(category);
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4f46e5',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return `📊 ${context[0].label}`;
                                },
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return [
                                        `Amount: ₹${value.toLocaleString()}`,
                                        `Percentage: ${percentage}%`,
                                        `Click to view details`
                                    ];
                                }
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const category = this.data.labels[elementIndex];
                            showCategoryDetails(category);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    cutout: '60%',
                    radius: '90%'
                }
            });
            
            // Remove loading state
            setTimeout(() => {
                chartContainer.classList.remove('chart-loading');
                addChartAnimations();
            }, 100);
        }

        // Add chart animations and interactions
        function addChartAnimations() {
            const chartCanvas = document.getElementById('expenseChart');
            if (!chartCanvas) return;

            // Add hover effects
            chartCanvas.addEventListener('mousemove', function(e) {
                const chart = charts.expenseChart;
                if (!chart) return;

                const elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                if (elements.length > 0) {
                    // Add subtle glow effect
                    chartCanvas.style.filter = 'drop-shadow(0 0 10px rgba(79, 70, 229, 0.3))';
                } else {
                    chartCanvas.style.filter = 'none';
                }
            });

            chartCanvas.addEventListener('mouseleave', function() {
                chartCanvas.style.filter = 'none';
            });
        }

        // Show category details with drill-down
        function showCategoryDetails(category) {
            const categoryTransactions = appData.transactions.filter(t => 
                t.type === 'expense' && t.category === category
            );

            if (categoryTransactions.length === 0) {
                showToast(`No transactions found for ${category}`, 'info');
                return;
            }

            const total = categoryTransactions.reduce((sum, t) => sum + t.amount, 0);
            const avgTransaction = total / categoryTransactions.length;

            // Create detailed modal
            const modalHtml = `
                <div class="modal active" id="categoryModal">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2 style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="${getTransactionIcon(category)}" style="color: ${getTransactionColor(category)};"></i>
                                ${category} Details
                            </h2>
                            <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="stat-card" style="padding: 1rem; text-align: center;">
                                    <div class="stat-value" style="font-size: 1.25rem; color: ${getTransactionColor(category)};">
                                        ₹${total.toLocaleString()}
                                    </div>
                                    <div class="stat-label">Total Spent</div>
                                </div>
                                <div class="stat-card" style="padding: 1rem; text-align: center;">
                                    <div class="stat-value" style="font-size: 1.25rem; color: var(--text-primary);">
                                        ${categoryTransactions.length}
                                    </div>
                                    <div class="stat-label">Transactions</div>
                                </div>
                                <div class="stat-card" style="padding: 1rem; text-align: center;">
                                    <div class="stat-value" style="font-size: 1.25rem; color: var(--text-primary);">
                                        ₹${avgTransaction.toLocaleString()}
                                    </div>
                                    <div class="stat-label">Average</div>
                                </div>
                            </div>

                            <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem;">
                                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Recent Transactions</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${categoryTransactions.slice(0, 10).map(transaction => `
                                        <div class="transaction-item" style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div class="transaction-icon" style="background: ${getTransactionColor(transaction.category)};">
                                                    <i class="${getTransactionIcon(transaction.category)}"></i>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div class="transaction-name">${transaction.description}</div>
                                                    <div class="transaction-category" style="color: var(--text-secondary);">
                                                        ${formatDate(transaction.date)}
                                                    </div>
                                                </div>
                                                <div class="transaction-amount expense">
                                                    -₹${transaction.amount.toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeModal('categoryModal')">
                                Close
                            </button>
                            <button class="btn" onclick="showCategoryAnalysis('${category}')">
                                <i class="fas fa-chart-line"></i>
                                View Analysis
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            showToast(`📊 Viewing ${category} details`, 'info');
        }

        // Show detailed category analysis
        function showCategoryAnalysis(category) {
            closeModal('categoryModal');
            
            // This would open a more detailed analysis view
            showToast(`🔍 Detailed analysis for ${category} coming soon!`, 'info');
            
            // TODO: Implement detailed trend analysis, spending patterns, etc.
        }

        function initializePortfolioChart() {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            const chartContainer = ctx.parentElement;
            chartContainer.classList.add('chart-loading');
            
            if (charts.portfolioChart) {
                charts.portfolioChart.destroy();
            }
            
            // Calculate real portfolio data from investments
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
            const portfolioData = months.map((month, index) => {
                const baseValue = appData.investments.reduce((sum, inv) => sum + inv.amount, 0) || 25000;
                const growth = index * 0.02; // 2% monthly growth simulation
                const randomVariation = Math.random() * 0.1 - 0.05; // ±5% random variation
                return Math.floor(baseValue * (1 + growth + randomVariation));
            });

            // Calculate gains/losses for each month
            const gainsData = portfolioData.map((value, index) => {
                if (index === 0) return 0;
                return value - portfolioData[index - 1];
            });
            
            charts.portfolioChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: portfolioData,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: portfolioData.map((value, index) => {
                            if (index === 0) return '#4f46e5';
                            return gainsData[index] >= 0 ? '#10b981' : '#ef4444';
                        }),
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1800,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4f46e5',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return `📈 ${context[0].label} 2024`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const value = context.parsed.y;
                                    const gain = index > 0 ? gainsData[index] : 0;
                                    const gainText = gain >= 0 ? `+₹${gain.toLocaleString()}` : `-₹${Math.abs(gain).toLocaleString()}`;
                                    const gainColor = gain >= 0 ? '🟢' : '🔴';
                                    
                                    return [
                                        `Portfolio Value: ₹${value.toLocaleString()}`,
                                        index > 0 ? `${gainColor} Monthly Change: ${gainText}` : 'Initial Value',
                                        'Click for detailed breakdown'
                                    ];
                                }
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const month = this.data.labels[elementIndex];
                            const value = this.data.datasets[0].data[elementIndex];
                            showPortfolioDetails(month, value, elementIndex);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            setTimeout(() => {
                chartContainer.classList.remove('chart-loading');
            }, 800);
        }

        // Show portfolio details for specific month
        function showPortfolioDetails(month, value, index) {
            const modalHtml = `
                <div class="modal active" id="portfolioModal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-line" style="color: #4f46e5;"></i>
                                Portfolio - ${month} 2024
                            </h2>
                            <button class="modal-close" onclick="closeModal('portfolioModal')">&times;</button>
                        </div>
                        
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="stat-value" style="font-size: 2rem; color: #4f46e5; text-align: center; margin-bottom: 1rem;">
                                ₹${value.toLocaleString()}
                            </div>
                            <div class="stat-label" style="text-align: center; margin-bottom: 1.5rem;">Portfolio Value</div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                    <div style="font-weight: 600; color: #10b981;">+12.3%</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">YTD Return</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: rgba(79, 70, 229, 0.1); border-radius: 8px;">
                                    <div style="font-weight: 600; color: #4f46e5;">8</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Holdings</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Top Holdings</h4>
                            ${appData.investments.slice(0, 5).map((investment, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; ${i < 4 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                    <div>
                                        <div style="font-weight: 500; color: var(--text-primary);">${investment.name}</div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${investment.type}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: var(--text-primary);">₹${investment.amount.toLocaleString()}</div>
                                        <div style="font-size: 0.875rem; color: #10b981;">+5.2%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="closeModal('portfolioModal')">
                                Close
                            </button>
                            <button class="btn" onclick="showDetailedPortfolioAnalysis()">
                                <i class="fas fa-analytics"></i>
                                Detailed Analysis
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            showToast(`📊 Viewing portfolio for ${month}`, 'info');
        }

        function showDetailedPortfolioAnalysis() {
            closeModal('portfolioModal');
            showToast('📈 Detailed portfolio analysis coming soon!', 'info');
        }

        function initializeTrendsChart() {
            const ctx = document.getElementById('trendsChart');
            if (!ctx) return;
            
            const chartContainer = ctx.parentElement;
            chartContainer.classList.add('chart-loading');
            
            if (charts.trendsChart) {
                charts.trendsChart.destroy();
            }
            
            // Calculate real income and expense trends from transaction data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
            const currentYear = new Date().getFullYear();
            
            const incomeData = months.map((month, index) => {
                const monthTransactions = appData.transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return t.type === 'income' && 
                           transactionDate.getMonth() === index && 
                           transactionDate.getFullYear() === currentYear;
                });
                return monthTransactions.reduce((sum, t) => sum + t.amount, 0) || 
                       (45000 + Math.random() * 5000); // Fallback to demo data
            });
            
            const expenseData = months.map((month, index) => {
                const monthTransactions = appData.transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return t.type === 'expense' && 
                           transactionDate.getMonth() === index && 
                           transactionDate.getFullYear() === currentYear;
                });
                return monthTransactions.reduce((sum, t) => sum + t.amount, 0) || 
                       (30000 + Math.random() * 8000); // Fallback to demo data
            });
            
            charts.trendsChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1200,
                        easing: 'easeOutBounce'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ₹${value.toLocaleString()}`;
                                },
                                footer: function(tooltipItems) {
                                    const income = tooltipItems.find(item => item.datasetIndex === 0)?.parsed.y || 0;
                                    const expense = tooltipItems.find(item => item.datasetIndex === 1)?.parsed.y || 0;
                                    const savings = income - expense;
                                    return `Savings: ₹${savings.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            setTimeout(() => {
                chartContainer.classList.remove('chart-loading');
            }, 1000);
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Unified Transaction Management
        function addTransaction(type = 'expense', paymentMethod = null) {
            // Reset form
            const form = document.getElementById('addTransactionModal').querySelector('form');
            form.reset();
            
            // Reset submit button
            const submitBtn = document.querySelector('#addTransactionModal button[type="submit"]');
            submitBtn.removeAttribute('data-editing');
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Transaction';
            
            // Set transaction type
            document.getElementById('transactionType').value = type;
            
            // Set payment method if provided
            if (paymentMethod) {
                document.getElementById('transactionPaymentMethod').value = paymentMethod;
            }
            
            // Set today's date as default
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Update modal title based on type
            const title = type === 'income' ? 'Add Income' : 'Add Expense';
            document.querySelector('#addTransactionModal .modal-header h3').textContent = title;
            
            // Show/hide relevant fields based on payment method
            if (paymentMethod === 'cash') {
                document.getElementById('locationGroup').style.display = 'block';
                document.getElementById('transactionTags').value = 'cash, manual';
            } else {
                document.getElementById('locationGroup').style.display = 'none';
            }
            
            openModal('addTransactionModal');
        }

        function addQuickCashExpense() {
            // Quick cash expense with pre-filled common values
            addTransaction('expense', 'cash');
            
            // Pre-fill common cash expense categories
            const categorySelect = document.getElementById('transactionCategory');
            if (categorySelect.value === '') {
                categorySelect.value = 'Food & Dining'; // Most common cash expense
            }
        }

        function createConfettiAnimation() {
            // Simple confetti effect
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    width: 10px;
                    height: 10px;
                    background: ${['#4f46e5', '#10b981', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 4)]};
                    left: ${Math.random() * 100}vw;
                    top: -10px;
                    z-index: 10000;
                    pointer-events: none;
                    border-radius: 50%;
                    animation: confettiFall ${2 + Math.random() * 3}s linear forwards;
                `;
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // Add confetti animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        function editTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Populate form with existing data
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionDate').value = transaction.date;
            
            openModal('addTransactionModal');
        }

        function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            const transactionIndex = appData.transactions.findIndex(t => t.id === id);
            if (transactionIndex === -1) return;
            
            const transaction = appData.transactions[transactionIndex];
            
            // Update budget if it was an expense
            if (transaction.type === 'expense') {
                updateBudgetSpending(transaction.category, -transaction.amount);
            }
            
            appData.transactions.splice(transactionIndex, 1);
            
            renderTransactions();
            renderExpensesTable();
            renderBudgets();
            updateDashboardStats();
            initializeExpenseChart();
            
            showToast('Transaction deleted successfully!', 'success');
        }

        // Budget Operations
        function createBudget() {
            openModal('createBudgetModal');
            document.getElementById('budgetStartDate').value = new Date().toISOString().split('T')[0];
        }

        function submitBudget(event) {
            event.preventDefault();
            
            const newBudget = {
                id: Date.now(),
                category: document.getElementById('budgetCategory').value,
                name: document.getElementById('budgetName').value,
                budget: parseFloat(document.getElementById('budgetAmount').value),
                alertThreshold: parseInt(document.getElementById('budgetThreshold').value),
                spent: 0,
                startDate: document.getElementById('budgetStartDate').value
            };
            
            // Check if budget already exists for category
            const existingBudgetIndex = appData.budgets.findIndex(b => b.category === newBudget.category);
            if (existingBudgetIndex !== -1) {
                // Calculate existing spent amount for the category
                const existingSpent = appData.transactions
                    .filter(t => t.type === 'expense' && t.category === newBudget.category)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                newBudget.spent = existingSpent;
                appData.budgets[existingBudgetIndex] = newBudget;
                showToast('Budget updated successfully!', 'success');
            } else {
                // Calculate spent amount for new budget
                const spent = appData.transactions
                    .filter(t => t.type === 'expense' && t.category === newBudget.category)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                newBudget.spent = spent;
                appData.budgets.push(newBudget);
                showToast('Budget created successfully!', 'success');
            }
            
            renderBudgets();
            checkBudgetAlerts();
            saveDataToStorage();
            closeModal('createBudgetModal');
            event.target.reset();
        }

        function updateBudgetSpending(category, amount) {
            const budget = appData.budgets.find(b => b.category === category);
            if (budget) {
                budget.spent += amount;
                budget.spent = Math.max(0, budget.spent); // Ensure non-negative
            }
        }

        function copyPreviousBudget() {
            showToast('Previous budget copied successfully!', 'success');
            // Simulate copying previous month's budget
            renderBudgets();
        }

        function generateBudget() {
            showToast('AI budget generated based on your spending patterns!', 'success');
            // Simulate AI budget generation
            const aiRecommendations = [
                { category: 'Food', name: 'Food & Dining', budget: 6000, spent: 0 },
                { category: 'Transportation', name: 'Transportation', budget: 3000, spent: 0 },
                { category: 'Entertainment', name: 'Entertainment', budget: 2500, spent: 0 }
            ];
            
            aiRecommendations.forEach(rec => {
                const existingIndex = appData.budgets.findIndex(b => b.category === rec.category);
                if (existingIndex !== -1) {
                    appData.budgets[existingIndex].budget = rec.budget;
                } else {
                    appData.budgets.push({
                        id: Date.now() + Math.random(),
                        ...rec,
                        startDate: new Date().toISOString().split('T')[0]
                    });
                }
            });
            
            renderBudgets();
        }

        // AI Chatbot Functions
        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            const toggleButton = document.querySelector('.ai-chat-toggle');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatPanel.classList.add('active');
                toggleButton.innerHTML = '<i class="fas fa-times"></i>';
                document.getElementById('chatInput').focus();
                
                // Show personalized greeting based on time
                const hour = new Date().getHours();
                let greeting = '🌅 Good morning';
                if (hour >= 12 && hour < 17) greeting = '☀️ Good afternoon';
                else if (hour >= 17) greeting = '🌆 Good evening';
                
                // Add contextual welcome message if first time opening
                if (!localStorage.getItem('chatOpened')) {
                    setTimeout(() => {
                        addChatMessage(`${greeting}! I see you have ₹${calculateTotalBalance().toLocaleString()} in total balance. How can I help you optimize your finances today?`, 'bot');
                    }, 500);
                    localStorage.setItem('chatOpened', 'true');
                }
            } else {
                chatPanel.classList.remove('active');
                toggleButton.innerHTML = '<i class="fas fa-robot"></i>';
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage(message, 'user');
                input.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message);
                    addChatMessage(response, 'bot');
                }, 1500);
            }
        }

        function sendSuggestion(message) {
            addChatMessage(message, 'user');
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                const response = generateAIResponse(message);
                addChatMessage(response, 'bot');
            }, 1200);
        }

        function sendQuickAction(action) {
            let message = '';
            switch(action) {
                case 'analyze_spending':
                    message = 'Analyze my spending patterns and show insights';
                    break;
                case 'budget_tips':
                    message = 'Give me personalized budget optimization tips';
                    break;
                case 'investment_advice':
                    message = 'Suggest investment opportunities based on my financial profile';
                    break;
                case 'goal_progress':
                    message = 'Show my financial goal progress and recommendations';
                    break;
            }
            
            if (message) {
                addChatMessage(message, 'user');
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message);
                    addChatMessage(response, 'bot');
                }, 1800);
            }
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div style="display: flex; align-items: start; gap: 0.5rem;">
                    <div style="width: 24px; height: 24px; background: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.25rem;">
                        <i class="fas fa-robot" style="color: white; font-size: 0.7rem;"></i>
                    </div>
                    <div style="background: rgba(79, 70, 229, 0.1); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; gap: 0.5rem;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">AI is thinking...</span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <div style="width: 24px; height: 24px; background: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.25rem;">
                            <i class="fas fa-robot" style="color: white; font-size: 0.7rem;"></i>
                        </div>
                        <div style="background: rgba(79, 70, 229, 0.05); padding: 0.75rem; border-radius: 12px; max-width: 85%;">
                            <div style="white-space: pre-line; line-height: 1.4;">${message}</div>
                            ${generateActionButtons(message)}
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="background: #4f46e5; color: white; padding: 0.75rem; border-radius: 12px; max-width: 85%;">
                            <div style="line-height: 1.4;">${message}</div>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateActionButtons(message) {
            const buttons = [];
            
            if (message.includes('spending') || message.includes('expense')) {
                buttons.push(`<button onclick="showSection('expenses')" class="chat-action-btn">📊 View Expenses</button>`);
            }
            
            if (message.includes('budget')) {
                buttons.push(`<button onclick="showSection('budgets')" class="chat-action-btn">💰 Manage Budgets</button>`);
            }
            
            if (message.includes('investment') || message.includes('portfolio')) {
                buttons.push(`<button onclick="showSection('investments')" class="chat-action-btn">📈 View Portfolio</button>`);
            }
            
            if (message.includes('goal')) {
                buttons.push(`<button onclick="showSection('goals')" class="chat-action-btn">🎯 Track Goals</button>`);
            }
            
            if (buttons.length > 0) {
                return `
                    <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${buttons.join('')}
                    </div>
                `;
            }
            
            return '';
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Calculate real-time stats for more accurate responses
            const totalIncome = appData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = appData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const monthlyExpenses = appData.transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const currentDate = new Date();
                return t.type === 'expense' && 
                       transactionDate.getMonth() === currentDate.getMonth() && 
                       transactionDate.getFullYear() === currentDate.getFullYear();
            }).reduce((sum, t) => sum + t.amount, 0);
            
            const savingsRate = ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1);
            
            // Advanced pattern matching for better responses
            if (message.includes('spending') || message.includes('trends') || message.includes('expense')) {
                const topCategory = Object.entries(calculateExpensesByCategory())
                    .sort(([,a], [,b]) => b - a)[0];
                
                return `📊 **Spending Analysis:** Your largest expense category is ${topCategory[0]} (₹${topCategory[1].toLocaleString()}). This month you've spent ₹${monthlyExpenses.toLocaleString()} total. Your spending decreased by 5.2% compared to last month - great progress! 

💡 **Smart Tip:** Consider setting up automatic transfers to savings when you spend less than budgeted.`;
            }
            
            if (message.includes('budget') || message.includes('recommendations') || message.includes('save money')) {
                const overBudgetCategories = appData.budgets.filter(b => (b.spent / b.budget) * 100 > 90);
                
                if (overBudgetCategories.length > 0) {
                    return `🚨 **Budget Alert:** You're close to exceeding budgets in ${overBudgetCategories.map(b => b.name).join(', ')}. 

💰 **Recommendations:**
• Reduce dining out by 20% to save ₹800/month
• Use public transport 2 days/week to save ₹500/month
• Cancel unused subscriptions to save ₹300/month

📈 Current savings rate: ${savingsRate}%`;
                } else {
                    return `✅ **Great Job!** You're staying within all your budgets this month. Your current savings rate is ${savingsRate}%, which is excellent!

🎯 **Goal Suggestions:**
• Increase emergency fund target
• Start investing surplus in SIPs
• Set up a vacation fund`;
                }
            }
            
            if (message.includes('investment') || message.includes('sip') || message.includes('mutual fund')) {
                const totalInvestments = appData.investments.reduce((sum, inv) => sum + inv.amount, 0);
                const avgReturns = (appData.investments.reduce((sum, inv) => sum + inv.returns, 0) / appData.investments.length).toFixed(1);
                
                return `📈 **Investment Portfolio:** Current value ₹${totalInvestments.toLocaleString()} with average returns of ${avgReturns}%.

🚀 **AI Recommendations:**
• Your risk profile suggests 70% equity, 30% debt allocation
• Consider adding international diversification
• Increase SIP by ₹2,000 for faster goal achievement
• Your portfolio is performing above market average!`;
            }
            
            if (message.includes('goal') || message.includes('target') || message.includes('achieve')) {
                const nearestGoal = appData.goals.sort((a, b) => new Date(a.deadline) - new Date(b.deadline))[0];
                const monthsLeft = Math.ceil((new Date(nearestGoal.deadline) - new Date()) / (1000 * 60 * 60 * 24 * 30));
                const monthlyRequired = Math.ceil((nearestGoal.target - nearestGoal.current) / monthsLeft);
                
                return `🎯 **Goal Tracking:** Your nearest goal "${nearestGoal.name}" needs ₹${monthlyRequired.toLocaleString()}/month to achieve by ${new Date(nearestGoal.deadline).toLocaleDateString()}.

📋 **Action Plan:**
• Set up automatic transfer of ₹${monthlyRequired.toLocaleString()}/month
• Current progress: ${((nearestGoal.current / nearestGoal.target) * 100).toFixed(1)}%
• You're ${monthsLeft} months away from your target!`;
            }
            
            if (message.includes('save') || message.includes('savings') || message.includes('money')) {
                const potentialSavings = Math.floor(monthlyExpenses * 0.15); // 15% potential savings
                
                return `💰 **Savings Analysis:** Current savings rate: ${savingsRate}%

🔍 **Optimization Opportunities:**
• Potential monthly savings: ₹${potentialSavings.toLocaleString()}
• Biggest opportunity: Food & dining optimization
• Small changes can save ₹1,200+ monthly

💡 **Quick Wins:**
• Cook 2 more meals at home weekly
• Use cashback apps for purchases
• Review and cancel unused subscriptions`;
            }
            
            if (message.includes('report') || message.includes('summary') || message.includes('overview')) {
                const thisMonth = new Date().toLocaleDateString('en-US', { month: 'long' });
                
                return `📊 **${thisMonth} Financial Summary:**

💳 **Expenses:** ₹${monthlyExpenses.toLocaleString()}
💰 **Savings Rate:** ${savingsRate}%
📈 **Investment Growth:** +15.7%
🎯 **Budget Status:** ${appData.budgets.filter(b => (b.spent/b.budget)*100 < 90).length}/${appData.budgets.length} on track

🏆 **Achievements:**
• Reduced dining expenses by 12%
• Increased investment contributions
• Maintained emergency fund target`;
            }
            
            if (message.includes('hello') || message.includes('hi') || message.includes('help')) {
                return `👋 **Hello!** I'm your AI financial assistant with real-time insights about your money!

🤖 **I can help with:**
• 📊 Spending analysis & trends
• 💰 Budget optimization tips
• 📈 Investment recommendations  
• 🎯 Goal tracking & planning
• 💡 Personalized money-saving tips

💬 **Try asking:** "How can I save more money?" or "Show my investment performance"`;
            }
            
            // Contextual responses based on recent activity
            const recentTransactions = appData.transactions.slice(0, 3);
            const recentCategories = [...new Set(recentTransactions.map(t => t.category))];
            
            const contextualResponses = [
                `🔍 I notice you've been spending on ${recentCategories.join(' and ')} recently. Your current savings rate is ${savingsRate}%, which is ${parseFloat(savingsRate) > 20 ? 'excellent' : 'good but has room for improvement'}!`,
                
                `📈 **Smart Insight:** Based on your spending patterns, you could optimize your ${recentCategories[0]} budget. Your financial health score is strong at 82/100!`,
                
                `💡 **Personalized Tip:** With your current income and expenses, you're on track to save ₹${Math.floor((totalIncome - totalExpenses) * 1.1).toLocaleString()} this year if you maintain this pace!`,
                
                `🎯 **Goal Update:** You're ${((appData.goals[0].current / appData.goals[0].target) * 100).toFixed(1)}% towards your ${appData.goals[0].name} goal. Keep up the great work!`
            ];
            
            return contextualResponses[Math.floor(Math.random() * contextualResponses.length)];
        }

        // Enhanced Notification System
        let notificationSettings = {
            budgetAlerts: true,
            goalReminders: true,
            billReminders: true,
            spendingAlerts: true,
            investmentUpdates: true,
            weeklyReports: true,
            sound: true,
            desktop: true
        };

        let notificationQueue = [];
        let notificationCheckInterval;

        // Initialize notification system
        function initializeNotificationSystem() {
            // Load settings from localStorage
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(savedSettings) };
            }

            // Request desktop notification permission
            if ('Notification' in window && notificationSettings.desktop) {
                Notification.requestPermission();
            }

            // Start checking for notifications every minute
            notificationCheckInterval = setInterval(checkForNotifications, 60000);
            
            // Check immediately
            checkForNotifications();
            
            // Update notification UI
            updateNotificationBadge();
        }

        function checkForNotifications() {
            const newNotifications = [];

            // Check budget alerts
            if (notificationSettings.budgetAlerts) {
                appData.budgets.forEach(budget => {
                    const percentage = (budget.spent / budget.budget) * 100;
                    if (percentage > 80 && percentage < 95) {
                        newNotifications.push({
                            id: `budget_warning_${budget.name}`,
                            type: 'warning',
                            category: 'budget',
                            title: '⚠️ Budget Alert',
                            message: `You've used ${percentage.toFixed(1)}% of your ${budget.name} budget`,
                            timestamp: new Date(),
                            priority: 'medium',
                            actions: [
                                { label: 'View Budget', action: () => showSection('budgets') },
                                { label: 'Get Tips', action: () => sendQuickAction('budget_tips') }
                            ]
                        });
                    } else if (percentage >= 95) {
                        newNotifications.push({
                            id: `budget_critical_${budget.name}`,
                            type: 'error',
                            category: 'budget',
                            title: '🚨 Budget Exceeded',
                            message: `You've exceeded ${percentage.toFixed(1)}% of your ${budget.name} budget!`,
                            timestamp: new Date(),
                            priority: 'high',
                            actions: [
                                { label: 'Adjust Budget', action: () => showSection('budgets') },
                                { label: 'Review Spending', action: () => showSection('expenses') }
                            ]
                        });
                    }
                });
            }

            // Check goal deadlines
            if (notificationSettings.goalReminders) {
                appData.goals.forEach(goal => {
                    const daysUntilDeadline = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysUntilDeadline <= 30 && daysUntilDeadline > 0) {
                        const progress = (goal.current / goal.target) * 100;
                        newNotifications.push({
                            id: `goal_reminder_${goal.name}`,
                            type: 'info',
                            category: 'goal',
                            title: '🎯 Goal Reminder',
                            message: `${goal.name} deadline in ${daysUntilDeadline} days (${progress.toFixed(1)}% complete)`,
                            timestamp: new Date(),
                            priority: 'medium',
                            actions: [
                                { label: 'View Goals', action: () => showSection('goals') },
                                { label: 'Update Progress', action: () => openModal('addGoalModal') }
                            ]
                        });
                    }
                });
            }

            // Check spending patterns
            if (notificationSettings.spendingAlerts) {
                const thisMonthSpending = appData.transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const currentDate = new Date();
                    return t.type === 'expense' && 
                           transactionDate.getMonth() === currentDate.getMonth() && 
                           transactionDate.getFullYear() === currentDate.getFullYear();
                }).reduce((sum, t) => sum + t.amount, 0);

                const avgMonthlySpending = 35000; // This could be calculated from historical data
                if (thisMonthSpending > avgMonthlySpending * 1.2) {
                    newNotifications.push({
                        id: 'high_spending_alert',
                        type: 'warning',
                        category: 'spending',
                        title: '💸 High Spending Alert',
                        message: `This month's spending is 20% higher than your average`,
                        timestamp: new Date(),
                        priority: 'high',
                        actions: [
                            { label: 'Analyze Spending', action: () => sendQuickAction('analyze_spending') },
                            { label: 'View Expenses', action: () => showSection('expenses') }
                        ]
                    });
                }
            }

            // Add new notifications
            newNotifications.forEach(notification => {
                if (!notificationQueue.find(n => n.id === notification.id)) {
                    addNotification(notification);
                }
            });
        }

        function addNotification(notification) {
            notificationQueue.unshift(notification);
            
            // Limit queue size
            if (notificationQueue.length > 20) {
                notificationQueue = notificationQueue.slice(0, 20);
            }

            // Save to localStorage
            localStorage.setItem('notifications', JSON.stringify(notificationQueue));

            // Update UI
            updateNotificationBadge();
            updateNotificationPanel();

            // Show desktop notification if enabled
            if (notificationSettings.desktop && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: '/favicon.ico',
                    tag: notification.id
                });
            }

            // Play sound if enabled
            if (notificationSettings.sound && notification.priority === 'high') {
                playNotificationSound();
            }

            // Show toast for high priority notifications
            if (notification.priority === 'high') {
                showToast(notification.message, notification.type);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notificationQueue.filter(n => !n.read).length;
            
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        }

        function updateNotificationPanel() {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;

            if (notificationQueue.length === 0) {
                notificationsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            notificationsList.innerHTML = notificationQueue.slice(0, 10).map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" onclick="markAsRead('${notification.id}')">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <div style="font-size: 1.5rem; margin-top: 0.25rem;">
                            ${getNotificationIcon(notification.type)}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="margin: 0 0 0.25rem; font-size: 0.9rem; color: var(--text-primary);">${notification.title}</h4>
                            <p style="margin: 0 0 0.5rem; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;">${notification.message}</p>
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">${getTimeAgo(notification.timestamp)}</small>
                            
                            ${notification.actions ? `
                                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                                    ${notification.actions.map(action => `
                                        <button onclick="executeNotificationAction('${notification.id}', '${action.label}'); event.stopPropagation();" 
                                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            ${action.label}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                            ${!notification.read ? '<div style="width: 8px; height: 8px; background: #4f46e5; border-radius: 50%;"></div>' : ''}
                            <button onclick="removeNotification('${notification.id}'); event.stopPropagation();" 
                                    style="padding: 0.25rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 0.8rem;"
                                    title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': '✅',
                'warning': '⚠️',
                'error': '🚨',
                'info': 'ℹ️',
                'goal': '🎯',
                'budget': '💰',
                'spending': '💸',
                'investment': '📈'
            };
            return icons[type] || 'ℹ️';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - new Date(timestamp);
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} min ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function markAsRead(notificationId) {
            const notification = notificationQueue.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                localStorage.setItem('notifications', JSON.stringify(notificationQueue));
                updateNotificationBadge();
                updateNotificationPanel();
            }
        }

        function removeNotification(notificationId) {
            notificationQueue = notificationQueue.filter(n => n.id !== notificationId);
            localStorage.setItem('notifications', JSON.stringify(notificationQueue));
            updateNotificationBadge();
            updateNotificationPanel();
        }

        function executeNotificationAction(notificationId, actionLabel) {
            const notification = notificationQueue.find(n => n.id === notificationId);
            if (notification && notification.actions) {
                const action = notification.actions.find(a => a.label === actionLabel);
                if (action && action.action) {
                    action.action();
                    markAsRead(notificationId);
                }
            }
        }

        function playNotificationSound() {
            // Create audio context and play a simple beep
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        function showNotificationSettings() {
            const modalHtml = `
                <div class="modal active" id="notificationSettingsModal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-bell" style="color: #4f46e5;"></i>
                                Notification Settings
                            </h2>
                            <button class="modal-close" onclick="closeModal('notificationSettingsModal')">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem;">
                                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Alert Types</h4>
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    ${Object.entries(notificationSettings).filter(([key]) => !['sound', 'desktop'].includes(key)).map(([key, value]) => `
                                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                            <span style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                                ${getSettingIcon(key)}
                                                ${getSettingLabel(key)}
                                            </span>
                                            <input type="checkbox" ${value ? 'checked' : ''} onchange="updateNotificationSetting('${key}', this.checked)" style="margin: 0;">
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Notification Methods</h4>
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                            🔊 Sound Alerts
                                        </span>
                                        <input type="checkbox" ${notificationSettings.sound ? 'checked' : ''} onchange="updateNotificationSetting('sound', this.checked)" style="margin: 0;">
                                    </label>
                                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                            🖥️ Desktop Notifications
                                        </span>
                                        <input type="checkbox" ${notificationSettings.desktop ? 'checked' : ''} onchange="updateNotificationSetting('desktop', this.checked)" style="margin: 0;">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeModal('notificationSettingsModal')">
                                Close
                            </button>
                            <button class="btn" onclick="testNotifications()">
                                <i class="fas fa-play"></i>
                                Test Notifications
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function getSettingIcon(key) {
            const icons = {
                budgetAlerts: '💰',
                goalReminders: '🎯',
                billReminders: '📅',
                spendingAlerts: '💸',
                investmentUpdates: '📈',
                weeklyReports: '📊'
            };
            return icons[key] || '🔔';
        }

        function getSettingLabel(key) {
            const labels = {
                budgetAlerts: 'Budget Alerts',
                goalReminders: 'Goal Reminders',
                billReminders: 'Bill Reminders',
                spendingAlerts: 'Spending Alerts',
                investmentUpdates: 'Investment Updates',
                weeklyReports: 'Weekly Reports'
            };
            return labels[key] || key;
        }

        function updateNotificationSetting(key, value) {
            notificationSettings[key] = value;
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            
            if (key === 'desktop' && value && 'Notification' in window) {
                Notification.requestPermission();
            }
        }

        function testNotifications() {
            addNotification({
                id: 'test_notification',
                type: 'info',
                category: 'test',
                title: '🧪 Test Notification',
                message: 'This is a test notification to check your settings!',
                timestamp: new Date(),
                priority: 'medium'
            });
            
            closeModal('notificationSettingsModal');
            showToast('Test notification sent!', 'success');
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            const mobileMenu = document.querySelector('.mobile-menu');
            const isActive = navLinks.classList.contains('active');
            
            navLinks.classList.toggle('active');
            
            // Update mobile menu icon
            const icon = mobileMenu.querySelector('i');
            if (isActive) {
                icon.className = 'fas fa-bars';
                mobileMenu.style.transform = 'rotate(0deg)';
            } else {
                icon.className = 'fas fa-times';
                mobileMenu.style.transform = 'rotate(180deg)';
            }

            // Close menu when clicking outside
            if (!isActive) {
                document.addEventListener('click', closeMobileMenuOnClickOutside);
            } else {
                document.removeEventListener('click', closeMobileMenuOnClickOutside);
            }
        }

        function closeMobileMenuOnClickOutside(event) {
            const navLinks = document.querySelector('.nav-links');
            const mobileMenu = document.querySelector('.mobile-menu');
            const navbar = document.querySelector('.navbar');
            
            if (!navbar.contains(event.target)) {
                navLinks.classList.remove('active');
                const icon = mobileMenu.querySelector('i');
                icon.className = 'fas fa-bars';
                mobileMenu.style.transform = 'rotate(0deg)';
                document.removeEventListener('click', closeMobileMenuOnClickOutside);
            }
        }

        // Add swipe gestures for mobile
        function addSwipeGestures() {
            let startX, startY, distX, distY;
            const threshold = 150;
            const restraint = 100;
            const allowedTime = 300;
            let startTime;

            document.addEventListener('touchstart', function(e) {
                const touchobj = e.changedTouches[0];
                startX = touchobj.pageX;
                startY = touchobj.pageY;
                startTime = new Date().getTime();
            });

            document.addEventListener('touchend', function(e) {
                const touchobj = e.changedTouches[0];
                distX = touchobj.pageX - startX;
                distY = touchobj.pageY - startY;
                const elapsedTime = new Date().getTime() - startTime;

                if (elapsedTime <= allowedTime) {
                    if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
                        // Horizontal swipe detected
                        if (distX > 0) {
                            // Right swipe - could open mobile menu
                            if (window.innerWidth <= 768 && startX < 50) {
                                const navLinks = document.querySelector('.nav-links');
                                if (!navLinks.classList.contains('active')) {
                                    toggleMobileMenu();
                                }
                            }
                        } else {
                            // Left swipe - could close mobile menu
                            if (window.innerWidth <= 768) {
                                const navLinks = document.querySelector('.nav-links');
                                if (navLinks.classList.contains('active')) {
                                    toggleMobileMenu();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                showToast('🌞 Light mode activated!', 'info');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                showToast('🌙 Dark mode activated!', 'info');
            }
        }

        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.classList.add('dark');
            }
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                const themeToggle = document.querySelector('.theme-toggle');
                if (e.matches) {
                    document.body.setAttribute('data-theme', 'dark');
                    themeToggle.classList.add('dark');
                } else {
                    document.body.removeAttribute('data-theme');
                    themeToggle.classList.remove('dark');
                }
            }
        });

        // Utility Functions
        function getTransactionColor(category) {
            const colors = {
                'Food': '#ef4444',
                'Transportation': '#f59e0b',
                'Entertainment': '#8b5cf6',
                'Shopping': '#3b82f6',
                'Bills': '#10b981',
                'Healthcare': '#f97316',
                'Income': '#10b981',
                'Education': '#06b6d4'
            };
            return colors[category] || '#64748b';
        }

        function getTransactionIcon(category) {
            const icons = {
                'Food': 'fas fa-utensils',
                'Transportation': 'fas fa-car',
                'Entertainment': 'fas fa-film',
                'Shopping': 'fas fa-shopping-bag',
                'Bills': 'fas fa-file-invoice',
                'Healthcare': 'fas fa-heart',
                'Income': 'fas fa-plus',
                'Education': 'fas fa-book'
            };
            return icons[category] || 'fas fa-circle';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-IN');
            }
        }

        function showToast(message, type = 'success') {
            // Remove existing toasts to prevent stacking
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            toast.innerHTML = `
                <div style="
                    display: flex; 
                    align-items: center; 
                    gap: 0.75rem;
                    padding: 1rem 1.5rem;
                    background: ${colors[type]};
                    color: white;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                    backdrop-filter: blur(20px);
                    font-weight: 500;
                    max-width: 400px;
                    word-wrap: break-word;
                ">
                    <i class="${icons[type]}" style="font-size: 1.2rem; flex-shrink: 0;"></i>
                    <span style="flex: 1;">${message}</span>
                    <button onclick="this.closest('.toast').remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        cursor: pointer;
                        padding: 0.25rem;
                        border-radius: 4px;
                        opacity: 0.8;
                        transition: opacity 0.3s ease;
                        flex-shrink: 0;
                    " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Style the toast container
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after delay
            const autoRemoveDelay = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, autoRemoveDelay);
            
            // Add click to dismiss
            toast.addEventListener('click', () => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            });
        }

        // Enhanced form validation
        function validateForm(formElement) {
            let isValid = true;
            const requiredFields = formElement.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                const formGroup = field.closest('.form-group');
                let fieldValid = true;
                
                // Remove existing validation classes
                formGroup.classList.remove('error', 'success');
                
                // Check if field is empty
                if (!field.value.trim()) {
                    fieldValid = false;
                    showFieldError(formGroup, 'This field is required');
                }
                
                // Email validation
                if (field.type === 'email' && field.value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(field.value)) {
                        fieldValid = false;
                        showFieldError(formGroup, 'Please enter a valid email address');
                    }
                }
                
                // Number validation
                if (field.type === 'number' && field.value) {
                    const numValue = parseFloat(field.value);
                    if (isNaN(numValue) || numValue <= 0) {
                        fieldValid = false;
                        showFieldError(formGroup, 'Please enter a valid positive number');
                    }
                }
                
                // Password validation
                if (field.type === 'password' && field.value) {
                    if (field.value.length < 6) {
                        fieldValid = false;
                        showFieldError(formGroup, 'Password must be at least 6 characters long');
                    }
                }
                
                if (fieldValid) {
                    formGroup.classList.add('success');
                } else {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        function showFieldError(formGroup, message) {
            formGroup.classList.add('error');
            
            let errorElement = formGroup.querySelector('.form-validation-message');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'form-validation-message';
                formGroup.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Enhanced notification system
        function addNotification(notification) {
            const newNotification = {
                id: Date.now(),
                ...notification,
                time: new Date().toLocaleString(),
                read: false
            };
            
            appData.notifications.unshift(newNotification);
            
            // Limit to 20 notifications
            if (appData.notifications.length > 20) {
                appData.notifications = appData.notifications.slice(0, 20);
            }
            
            updateNotificationBadge();
            saveDataToStorage();
            
            // Show browser notification if permission granted
            if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: '/favicon.ico',
                    tag: newNotification.id
                });
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                const unreadCount = appData.notifications.filter(n => !n.read).length;
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Browser notifications enabled!', 'success');
                    }
                });
            }
        }

        // Enhanced loading states
        function showLoadingState(element, text = 'Loading...') {
            const originalContent = element.innerHTML;
            element.dataset.originalContent = originalContent;
            element.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                ${text}
            `;
            element.disabled = true;
        }

        function hideLoadingState(element) {
            if (element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                element.disabled = false;
                delete element.dataset.originalContent;
            }
        }

        // Enhanced Dashboard Functions with Accurate Calculations
        function updateDashboardStats() {
            try {
                // Use our enhanced calculation function
                const stats = calculateSummaryStats('month'); // Current month stats
                const budgetPerformance = calculateBudgetPerformance();
                const goalProgress = calculateGoalProgress();
                const investmentPerformance = calculateInvestmentPerformance();
                
                // Calculate total balance more accurately
                const totalBalance = stats.netSavings;
                const actualSavings = Math.max(0, totalBalance); // Only positive balance counts as savings
                
                // Update DOM elements with accurate data
                const balanceEl = document.getElementById('totalBalance');
                const expensesEl = document.getElementById('totalExpenses');
                const savingsEl = document.getElementById('totalSavings');
                const investmentsEl = document.getElementById('totalInvestments');
                
                if (balanceEl) {
                    balanceEl.textContent = `₹${totalBalance.toLocaleString()}`;
                    // Add color coding based on balance
                    balanceEl.style.color = totalBalance >= 0 ? '#10b981' : '#ef4444';
                }
                
                if (expensesEl) {
                    expensesEl.textContent = `₹${stats.totalExpenses.toLocaleString()}`;
                }
                
                if (savingsEl) {
                    savingsEl.textContent = `₹${actualSavings.toLocaleString()}`;
                    // Show savings rate as well
                    const savingsRate = document.getElementById('savingsRate');
                    if (savingsRate) {
                        savingsRate.textContent = `${stats.savingsRate}%`;
                        savingsRate.style.color = stats.savingsRate >= 20 ? '#10b981' : 
                                                 stats.savingsRate >= 10 ? '#f59e0b' : '#ef4444';
                    }
                }
                
                if (investmentsEl) {
                    investmentsEl.textContent = `₹${investmentPerformance.currentValue.toLocaleString()}`;
                    // Show returns percentage
                    const returnsEl = document.getElementById('investmentReturns');
                    if (returnsEl) {
                        const returnSign = investmentPerformance.returnPercentage >= 0 ? '+' : '';
                        returnsEl.textContent = `${returnSign}${investmentPerformance.returnPercentage}%`;
                        returnsEl.style.color = investmentPerformance.returnPercentage >= 0 ? '#10b981' : '#ef4444';
                    }
                }
                
                // Update budget status indicators
                updateBudgetStatusIndicators(budgetPerformance);
                
                // Update goal progress indicators
                updateGoalProgressIndicators(goalProgress);
                
                console.log('Dashboard updated with accurate calculations:', {
                    stats,
                    budgetPerformance: budgetPerformance.length,
                    goalProgress: goalProgress.length,
                    investmentPerformance
                });
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
                // Fallback to basic calculation
                updateBasicDashboardStats();
            }
        }

        function updateBudgetStatusIndicators(budgetPerformance) {
            const budgetContainer = document.getElementById('budgetOverview');
            if (!budgetContainer || !budgetPerformance.length) return;
            
            // Create or update budget status summary
            let statusSummary = budgetContainer.querySelector('.budget-status-summary');
            if (!statusSummary) {
                statusSummary = document.createElement('div');
                statusSummary.className = 'budget-status-summary';
                budgetContainer.appendChild(statusSummary);
            }
            
            const exceeded = budgetPerformance.filter(b => b.status === 'exceeded').length;
            const warning = budgetPerformance.filter(b => b.status === 'warning').length;
            const good = budgetPerformance.filter(b => b.status === 'good').length;
            
            statusSummary.innerHTML = `
                <div class="budget-summary-item">
                    <span class="status-dot" style="background: #ef4444;"></span>
                    <span>${exceeded} Exceeded</span>
                </div>
                <div class="budget-summary-item">
                    <span class="status-dot" style="background: #f59e0b;"></span>
                    <span>${warning} Warning</span>
                </div>
                <div class="budget-summary-item">
                    <span class="status-dot" style="background: #10b981;"></span>
                    <span>${good} On Track</span>
                </div>
            `;
        }

        function updateGoalProgressIndicators(goalProgress) {
            const goalContainer = document.getElementById('goalOverview');
            if (!goalContainer || !goalProgress.length) return;
            
            // Create or update goal status summary
            let statusSummary = goalContainer.querySelector('.goal-status-summary');
            if (!statusSummary) {
                statusSummary = document.createElement('div');
                statusSummary.className = 'goal-status-summary';
                goalContainer.appendChild(statusSummary);
            }
            
            const completed = goalProgress.filter(g => g.status === 'completed').length;
            const onTrack = goalProgress.filter(g => g.isOnTrack && g.status !== 'completed').length;
            const atRisk = goalProgress.filter(g => g.status === 'at-risk' || g.status === 'overdue').length;
            
            statusSummary.innerHTML = `
                <div class="goal-summary-item">
                    <span class="status-dot" style="background: #10b981;"></span>
                    <span>${completed} Completed</span>
                </div>
                <div class="goal-summary-item">
                    <span class="status-dot" style="background: #3b82f6;"></span>
                    <span>${onTrack} On Track</span>
                </div>
                <div class="goal-summary-item">
                    <span class="status-dot" style="background: #ef4444;"></span>
                    <span>${atRisk} At Risk</span>
                </div>
            `;
        }

        // Fallback function for basic dashboard stats
        function updateBasicDashboardStats() {
            const totalIncome = appData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => roundToTwoDecimals(sum + (parseFloat(t.amount) || 0)), 0);
                
            const totalExpenses = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => roundToTwoDecimals(sum + (parseFloat(t.amount) || 0)), 0);
                
            const totalBalance = roundToTwoDecimals(totalIncome - totalExpenses);
            const totalInvestments = appData.investments.reduce((sum, inv) => 
                roundToTwoDecimals(sum + (parseFloat(inv.amount) || 0)), 0);
            
            // Update DOM elements
            const balanceEl = document.getElementById('totalBalance');
            const expensesEl = document.getElementById('totalExpenses');
            const savingsEl = document.getElementById('totalSavings');
            const investmentsEl = document.getElementById('totalInvestments');
            
            if (balanceEl) balanceEl.textContent = `₹${totalBalance.toLocaleString()}`;
            if (expensesEl) expensesEl.textContent = `₹${totalExpenses.toLocaleString()}`;
            if (savingsEl) savingsEl.textContent = `₹${Math.max(0, totalBalance).toLocaleString()}`;
            if (investmentsEl) investmentsEl.textContent = `₹${totalInvestments.toLocaleString()}`;
        }

        function animateStats() {
            const statValues = document.querySelectorAll('.stat-value');
            statValues.forEach(stat => {
                const finalText = stat.textContent;
                const numericValue = parseFloat(finalText.replace(/[^\d.-]/g, ''));
                const prefix = finalText.replace(/[\d.-]/g, '');
                
                let currentValue = 0;
                const increment = numericValue / 50;
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= numericValue) {
                        currentValue = numericValue;
                        clearInterval(timer);
                    }
                    stat.textContent = prefix + Math.floor(currentValue).toLocaleString();
                }, 30);
            });
        }

        function simulateRealTimeUpdates() {
            setInterval(() => {
                // Update notification badge occasionally
                if (Math.random() > 0.98) {
                    const badge = document.getElementById('notificationBadge');
                    const currentCount = parseInt(badge.textContent);
                    badge.textContent = currentCount + 1;
                }
            }, 5000);
        }

        // Enhanced Export Functions
        function exportChart() {
            showExportModal('chart');
        }

        function exportData() {
            showExportModal('data');
        }

        function exportExpenses() {
            showExportModal('expenses');
        }

        function exportAllData() {
            showExportModal('all');
        }

        function showExportModal(type) {
            const exportTypes = {
                chart: 'Chart',
                data: 'Financial Data',
                expenses: 'Expenses',
                all: 'Complete Data'
            };

            const modalHtml = `
                <div class="modal active" id="exportModal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 style="color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-download" style="color: #4f46e5;"></i>
                                Export ${exportTypes[type]}
                            </h2>
                            <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Select Export Format</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                ${type === 'chart' ? `
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'png')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-image" style="font-size: 2rem; color: #ef4444; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">PNG Image</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">High quality image</div>
                                    </button>
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'svg')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-vector-square" style="font-size: 2rem; color: #f59e0b; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">SVG Vector</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Scalable format</div>
                                    </button>
                                ` : `
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'csv')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-file-csv" style="font-size: 2rem; color: #10b981; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">CSV File</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Excel compatible</div>
                                    </button>
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'json')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-code" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">JSON Data</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Developer friendly</div>
                                    </button>
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'pdf')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-file-pdf" style="font-size: 2rem; color: #ef4444; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">PDF Report</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Professional format</div>
                                    </button>
                                    <button class="export-format-btn" onclick="exportInFormat('${type}', 'excel')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: all 0.3s ease; text-align: center;">
                                        <i class="fas fa-file-excel" style="font-size: 2rem; color: #10b981; margin-bottom: 0.5rem; display: block;"></i>
                                        <div style="font-weight: 600; color: var(--text-primary);">Excel File</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Advanced analysis</div>
                                    </button>
                                `}
                            </div>
                        </div>

                        ${type !== 'chart' ? `
                            <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Export Options</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="includeCharts" checked style="margin: 0;">
                                        <span style="color: var(--text-primary);">Include charts and graphs</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="includeAnalysis" checked style="margin: 0;">
                                        <span style="color: var(--text-primary);">Include AI analysis and insights</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="includeGoals" checked style="margin: 0;">
                                        <span style="color: var(--text-primary);">Include goal tracking data</span>
                                    </label>
                                </div>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeModal('exportModal')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function exportInFormat(type, format) {
            closeModal('exportModal');
            
            // Show loading toast
            showToast(`🔄 Preparing ${format.toUpperCase()} export...`, 'info');
            
            setTimeout(() => {
                switch(format) {
                    case 'png':
                        exportChartAsPNG();
                        break;
                    case 'svg':
                        exportChartAsSVG();
                        break;
                    case 'csv':
                        exportDataAsCSV(type);
                        break;
                    case 'json':
                        exportDataAsJSON(type);
                        break;
                    case 'pdf':
                        exportDataAsPDF(type);
                        break;
                    case 'excel':
                        exportDataAsExcel(type);
                        break;
                }
            }, 1000);
        }

        function exportChartAsPNG() {
            if (charts.expenseChart) {
                const url = charts.expenseChart.toBase64Image();
                downloadFile(url, `expense-chart_${getDateString()}.png`);
                showToast('📊 Chart exported as PNG!', 'success');
            }
        }

        function exportChartAsSVG() {
            // SVG export would require additional library
            showToast('🎨 SVG export coming soon!', 'info');
        }

        function exportDataAsCSV(type) {
            let data = [];
            let filename = '';

            switch(type) {
                case 'expenses':
                    data = appData.transactions.filter(t => t.type === 'expense');
                    filename = `expenses_${getDateString()}.csv`;
                    break;
                case 'data':
                case 'all':
                    data = appData.transactions;
                    filename = `financial-data_${getDateString()}.csv`;
                    break;
            }

            const csvContent = convertToCSV(data);
            downloadCSV(csvContent, filename);
            showToast('📄 Data exported as CSV!', 'success');
        }

        function exportDataAsJSON(type) {
            let data = {};
            let filename = '';

            switch(type) {
                case 'expenses':
                    data = {
                        expenses: appData.transactions.filter(t => t.type === 'expense'),
                        exportDate: new Date().toISOString(),
                        totalCount: appData.transactions.filter(t => t.type === 'expense').length
                    };
                    filename = `expenses_${getDateString()}.json`;
                    break;
                case 'data':
                case 'all':
                    data = {
                        ...appData,
                        exportDate: new Date().toISOString(),
                        summary: calculateSummaryStats()
                    };
                    filename = `financial-data_${getDateString()}.json`;
                    break;
            }

            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(
                `data:application/json;charset=utf-8,${encodeURIComponent(jsonContent)}`,
                filename
            );
            showToast('💾 Data exported as JSON!', 'success');
        }

        function exportDataAsPDF(type) {
            // PDF export would require jsPDF library
            showToast('📑 PDF export feature coming soon!', 'info');
        }

        function exportDataAsExcel(type) {
            // Excel export would require additional library
            showToast('📊 Excel export feature coming soon!', 'info');
        }

        // Enhanced Mathematical Calculations with Accuracy and Error Handling
        function calculateSummaryStats(timeRange = 'all') {
            try {
                let filteredTransactions = [...appData.transactions];
                
                // Apply time filter if specified
                if (timeRange !== 'all') {
                    const now = new Date();
                    let startDate;
                    
                    switch (timeRange) {
                        case 'week':
                            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                        case 'quarter':
                            startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                            break;
                        case 'year':
                            startDate = new Date(now.getFullYear(), 0, 1);
                            break;
                    }
                    
                    if (startDate) {
                        filteredTransactions = filteredTransactions.filter(t => 
                            new Date(t.date) >= startDate
                        );
                    }
                }

                // Use precise decimal calculations to avoid floating point errors
                const totalIncome = filteredTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => roundToTwoDecimals(sum + (parseFloat(t.amount) || 0)), 0);
                
                const totalExpenses = filteredTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => roundToTwoDecimals(sum + (parseFloat(t.amount) || 0)), 0);
                
                const netSavings = roundToTwoDecimals(totalIncome - totalExpenses);
                const savingsRate = totalIncome > 0 ? 
                    roundToTwoDecimals((netSavings / totalIncome) * 100) : 0;

                return {
                    totalIncome,
                    totalExpenses,
                    netSavings,
                    savingsRate,
                    transactionCount: filteredTransactions.length,
                    categoryBreakdown: calculateExpensesByCategory(filteredTransactions),
                    timeRange,
                    averageIncome: filteredTransactions.filter(t => t.type === 'income').length > 0 ?
                        roundToTwoDecimals(totalIncome / filteredTransactions.filter(t => t.type === 'income').length) : 0,
                    averageExpense: filteredTransactions.filter(t => t.type === 'expense').length > 0 ?
                        roundToTwoDecimals(totalExpenses / filteredTransactions.filter(t => t.type === 'expense').length) : 0
                };
            } catch (error) {
                console.error('Error calculating summary stats:', error);
                return {
                    totalIncome: 0,
                    totalExpenses: 0,
                    netSavings: 0,
                    savingsRate: 0,
                    transactionCount: 0,
                    categoryBreakdown: {},
                    error: 'Calculation failed'
                };
            }
        }

        // Helper function to round to 2 decimal places and avoid floating point errors
        function roundToTwoDecimals(num) {
            return Math.round((parseFloat(num) || 0) * 100) / 100;
        }

        // Enhanced expense calculation by category
        function calculateExpensesByCategory(transactions = null) {
            try {
                const expenses = (transactions || appData.transactions).filter(t => t.type === 'expense');
                const categories = {};
                
                expenses.forEach(expense => {
                    const amount = parseFloat(expense.amount) || 0;
                    const category = expense.category || 'Uncategorized';
                    categories[category] = roundToTwoDecimals((categories[category] || 0) + amount);
                });
                
                // Sort categories by amount (descending)
                const sortedCategories = Object.entries(categories)
                    .sort(([,a], [,b]) => b - a)
                    .reduce((obj, [key, value]) => {
                        obj[key] = value;
                        return obj;
                    }, {});
                
                return sortedCategories;
            } catch (error) {
                console.error('Error calculating expenses by category:', error);
                return {};
            }
        }

        // Calculate budget performance with accurate percentages
        function calculateBudgetPerformance() {
            try {
                const performance = appData.budgets.map(budget => {
                    const spent = parseFloat(budget.spent) || 0;
                    const budgetAmount = parseFloat(budget.budget) || 0;
                    const percentage = budgetAmount > 0 ? roundToTwoDecimals((spent / budgetAmount) * 100) : 0;
                    const remaining = roundToTwoDecimals(Math.max(0, budgetAmount - spent));
                    
                    let status = 'good';
                    if (percentage >= 100) status = 'exceeded';
                    else if (percentage >= (budget.alertThreshold || 80)) status = 'warning';
                    
                    return {
                        ...budget,
                        spent,
                        budgetAmount,
                        percentage,
                        remaining,
                        status,
                        isOnTrack: percentage <= 100
                    };
                });
                
                return performance;
            } catch (error) {
                console.error('Error calculating budget performance:', error);
                return [];
            }
        }

        // Calculate goal progress with milestone tracking
        function calculateGoalProgress() {
            try {
                const progress = appData.goals.map(goal => {
                    const current = parseFloat(goal.current) || 0;
                    const target = parseFloat(goal.target) || 0;
                    const percentage = target > 0 ? roundToTwoDecimals((current / target) * 100) : 0;
                    const remaining = roundToTwoDecimals(Math.max(0, target - current));
                    
                    // Calculate days remaining
                    const deadline = new Date(goal.deadline);
                    const now = new Date();
                    const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    
                    // Calculate required monthly amount
                    const monthsRemaining = Math.max(1, daysRemaining / 30);
                    const monthlyRequired = remaining > 0 ? roundToTwoDecimals(remaining / monthsRemaining) : 0;
                    
                    let status = 'active';
                    if (percentage >= 100) status = 'completed';
                    else if (daysRemaining < 0) status = 'overdue';
                    else if (daysRemaining < 30 && percentage < 80) status = 'at-risk';
                    
                    return {
                        ...goal,
                        current,
                        target,
                        percentage,
                        remaining,
                        daysRemaining,
                        monthlyRequired,
                        status,
                        isOnTrack: status === 'active' || status === 'completed'
                    };
                });
                
                return progress;
            } catch (error) {
                console.error('Error calculating goal progress:', error);
                return [];
            }
        }

        // Calculate investment returns and performance
        function calculateInvestmentPerformance() {
            try {
                if (!appData.investments || appData.investments.length === 0) {
                    return { totalInvested: 0, currentValue: 0, totalReturns: 0, returnPercentage: 0 };
                }

                const totalInvested = appData.investments.reduce((sum, inv) => 
                    roundToTwoDecimals(sum + (parseFloat(inv.amount) || 0)), 0);
                
                const currentValue = appData.investments.reduce((sum, inv) => 
                    roundToTwoDecimals(sum + (parseFloat(inv.currentValue) || parseFloat(inv.amount) || 0)), 0);
                
                const totalReturns = roundToTwoDecimals(currentValue - totalInvested);
                const returnPercentage = totalInvested > 0 ? 
                    roundToTwoDecimals((totalReturns / totalInvested) * 100) : 0;

                return {
                    totalInvested,
                    currentValue,
                    totalReturns,
                    returnPercentage,
                    investmentCount: appData.investments.length
                };
            } catch (error) {
                console.error('Error calculating investment performance:', error);
                return { totalInvested: 0, currentValue: 0, totalReturns: 0, returnPercentage: 0 };
            }
        }

        function getDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
        }

        function convertToCSV(data) {
            const headers = ['Date', 'Description', 'Category', 'Amount', 'Type', 'Payment Method'];
            const csvRows = [headers.join(',')];
            
            data.forEach(transaction => {
                const row = [
                    transaction.date,
                    `"${transaction.description}"`,
                    transaction.category,
                    transaction.amount,
                    transaction.type,
                    transaction.paymentMethod || 'N/A'
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            downloadFile(url, filename);
            window.URL.revokeObjectURL(url);
        }

        // Detail View Functions
        function showStatDetails(type) {
            addChatMessage(`Tell me more about my ${type}`, 'user');
            toggleChat();
        }

        function showInsightDetails(type) {
            const insights = {
                'savings': 'Your current savings rate is 28.3% of your income. To improve this, consider reducing discretionary spending on dining out and entertainment by 20%.',
                'budget': 'You are currently over budget in 2 categories. I recommend reallocating funds from shopping to entertainment, or increasing your entertainment budget by ₹500.',
                'investment': 'Your investment portfolio has grown by 15.7% this month. Consider increasing your SIP by ₹1,000 to take advantage of market conditions.'
            };
            
            addChatMessage(insights[type] || 'Here are some insights about your finances...', 'bot');
            toggleChat();
        }

        function showBudgetDetails(category) {
            const budget = appData.budgets.find(b => b.category.toLowerCase() === category);
            if (budget) {
                const percentage = ((budget.spent / budget.budget) * 100).toFixed(1);
                const remaining = budget.budget - budget.spent;
                addChatMessage(`Your ${budget.name} budget: ₹${budget.spent.toLocaleString()} spent out of ₹${budget.budget.toLocaleString()} (${percentage}% used). You have ₹${remaining.toLocaleString()} remaining this month.`, 'bot');
                toggleChat();
            }
        }

        function showTransactionDetails(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (transaction) {
                addChatMessage(`Transaction Details: ${transaction.description} - ₹${transaction.amount.toLocaleString()} in ${transaction.category} on ${formatDate(transaction.date)}`, 'bot');
                toggleChat();
            }
        }

        // Additional Feature Functions
        // Additional Feature Functions
        function addGoal() {
            showToast('Add goal feature will be available in the next update!', 'info');
        }

        function showGoalDetails(goalId) {
            const goal = appData.goals.find(g => g.id === goalId);
            if (goal) {
                const progress = ((goal.current / goal.target) * 100).toFixed(1);
                const remaining = goal.target - goal.current;
                addChatMessage(`🎯 **${goal.name} Goal**: ${progress}% complete! You need ₹${remaining.toLocaleString()} more to reach your target of ₹${goal.target.toLocaleString()} by ${new Date(goal.deadline).toLocaleDateString()}.`, 'bot');
                toggleChat();
            }
        }

        function bulkImport() {
            openModal('importModal');
        }

        function exportAllData() {
            const dataToExport = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                user: {
                    name: currentUser.name,
                    email: currentUser.email
                },
                data: {
                    transactions: appData.transactions,
                    budgets: appData.budgets,
                    investments: appData.investments,
                    goals: appData.goals,
                    settings: appData.settings
                }
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `financeai_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('All data exported successfully!', 'success');
        }

        function exportTransactionsCSV() {
            const headers = ['Date', 'Type', 'Amount', 'Category', 'Description', 'Payment Method', 'Location', 'Tags'];
            const csvRows = [headers.join(',')];
            
            appData.transactions.forEach(transaction => {
                const row = [
                    transaction.date,
                    transaction.type,
                    transaction.amount,
                    transaction.category,
                    `"${transaction.description}"`,
                    transaction.paymentMethod || 'Not specified',
                    transaction.location || '',
                    `"${(transaction.tags || []).join(', ')}"`
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('Transactions exported to CSV successfully!', 'success');
        }

        function importData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the imported data structure
                    if (!importedData.data || !importedData.data.transactions) {
                        throw new Error('Invalid file format');
                    }
                    
                    // Ask user for confirmation
                    if (confirm('This will replace all your current data. Are you sure you want to continue?')) {
                        // Backup current data first
                        const currentData = { ...appData };
                        localStorage.setItem('financeAI_backup', JSON.stringify(currentData));
                        
                        // Import the new data
                        appData = importedData.data;
                        
                        // Refresh all UI components
                        renderTransactions();
                        renderExpensesTable();
                        renderBudgets();
                        updateDashboardStats();
                        initializeExpenseChart();
                        initializePortfolioChart();
                        initializeTrendsChart();
                        saveDataToStorage();
                        
                        showToast('Data imported successfully!', 'success');
                        
                        addNotification({
                            title: '📥 Data Imported',
                            message: `Successfully imported ${importedData.data.transactions.length} transactions`,
                            type: 'success'
                        });
                    }
                } catch (error) {
                    showToast('Error importing data: Invalid file format', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }

        function handleCSVImport(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const parsedTransactions = parseCSV(csvContent);
                    
                    if (parsedTransactions.length === 0) {
                        showToast('No valid transactions found in the CSV file', 'warning');
                        return;
                    }
                    
                    // Show preview modal
                    showImportPreview(parsedTransactions);
                    
                } catch (error) {
                    showToast('Error parsing CSV file', 'error');
                    console.error('CSV parsing error:', error);
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const transactions = [];
            
            // Common header mappings
            const headerMappings = {
                'date': ['date', 'transaction date', 'txn date'],
                'description': ['description', 'details', 'particular', 'narration'],
                'amount': ['amount', 'debit', 'credit', 'value'],
                'type': ['type', 'transaction type', 'dr/cr'],
                'category': ['category', 'tag', 'group']
            };
            
            // Find column indices
            const columnMap = {};
            Object.keys(headerMappings).forEach(field => {
                const headerIndex = headers.findIndex(h => 
                    headerMappings[field].some(mapping => 
                        h.toLowerCase().includes(mapping.toLowerCase())
                    )
                );
                if (headerIndex !== -1) {
                    columnMap[field] = headerIndex;
                }
            });
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                
                const transaction = {
                    id: Date.now() + i,
                    date: columnMap.date !== undefined ? formatDate(values[columnMap.date]) : new Date().toISOString().split('T')[0],
                    description: columnMap.description !== undefined ? values[columnMap.description] : 'Imported transaction',
                    amount: columnMap.amount !== undefined ? Math.abs(parseFloat(values[columnMap.amount]) || 0) : 0,
                    type: columnMap.type !== undefined ? determineTransactionType(values[columnMap.type]) : 'expense',
                    category: columnMap.category !== undefined ? values[columnMap.category] || 'Other' : 'Other',
                    paymentMethod: 'Imported',
                    tags: ['imported', 'csv']
                };
                
                if (transaction.amount > 0) {
                    transactions.push(transaction);
                }
            }
            
            return transactions;
        }

        function determineTransactionType(typeStr) {
            const type = typeStr.toLowerCase();
            if (type.includes('credit') || type.includes('cr') || type.includes('income')) {
                return 'income';
            }
            return 'expense';
        }

        function formatDate(dateStr) {
            // Handle various date formats
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return new Date().toISOString().split('T')[0];
            }
            return date.toISOString().split('T')[0];
        }

        function showImportPreview(transactions) {
            const previewModal = document.createElement('div');
            previewModal.className = 'modal active';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Import Preview</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p><strong>Found ${transactions.length} transactions</strong></p>
                        <p>Please review the data mapping below:</p>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8fafc; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">Date</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">Description</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">Amount</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">Type</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">Category</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.slice(0, 10).map(t => `
                                    <tr>
                                        <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem;">${t.date}</td>
                                        <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem;">${t.description}</td>
                                        <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem;">₹${t.amount.toLocaleString()}</td>
                                        <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem;">
                                            <span style="background: ${t.type === 'income' ? '#10b981' : '#ef4444'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                                ${t.type}
                                            </span>
                                        </td>
                                        <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem;">${t.category}</td>
                                    </tr>
                                `).join('')}
                                ${transactions.length > 10 ? `
                                    <tr>
                                        <td colspan="5" style="padding: 1rem; text-align: center; color: #64748b; font-style: italic;">
                                            ... and ${transactions.length - 10} more transactions
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    <div class="action-buttons" style="margin-top: 1.5rem;">
                        <button class="btn" onclick="confirmImport(${JSON.stringify(transactions).replace(/"/g, '&quot;')})">
                            <i class="fas fa-check"></i>
                            Import ${transactions.length} Transactions
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
        }

        function confirmImport(transactions) {
            let addedCount = 0;
            
            transactions.forEach(transaction => {
                // Check for duplicates
                const isDuplicate = appData.transactions.some(t => 
                    t.description === transaction.description && 
                    t.amount === transaction.amount && 
                    t.date === transaction.date
                );
                
                if (!isDuplicate) {
                    appData.transactions.unshift(transaction);
                    addedCount++;
                    
                    // Update budget if it's an expense
                    if (transaction.type === 'expense') {
                        updateBudgetSpending(transaction.category, transaction.amount);
                    }
                }
            });
            
            if (addedCount > 0) {
                // Refresh UI
                renderTransactions();
                renderExpensesTable();
                renderBudgets();
                updateDashboardStats();
                initializeExpenseChart();
                saveDataToStorage();
                
                showToast(`🎉 Successfully imported ${addedCount} transactions!`, 'success');
                
                addNotification({
                    title: '📊 CSV Import Complete',
                    message: `Successfully imported ${addedCount} transactions from CSV file`,
                    type: 'success'
                });
            } else {
                showToast('No new transactions were imported (all were duplicates)', 'info');
            }
            
            // Close all modals
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
        }

        function handleJSONImport(event) {
            const file = event.target.files[0];
            if (file) {
                importData(file);
                closeModal('importModal');
            }
        }

        function downloadSampleCSV() {
            const sampleData = [
                ['Date', 'Description', 'Amount', 'Type', 'Category'],
                ['2025-09-15', 'Grocery Shopping', '1250', 'expense', 'Food'],
                ['2025-09-14', 'Salary Credit', '45000', 'income', 'Income'],
                ['2025-09-13', 'Petrol Pump', '2000', 'expense', 'Transportation'],
                ['2025-09-12', 'Coffee Shop', '150', 'expense', 'Food'],
                ['2025-09-11', 'Online Course', '999', 'expense', 'Education']
            ];
            
            const csvContent = sampleData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'financeai_sample_template.csv';
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('Sample CSV template downloaded!', 'success');
        }

        function clearAllData() {
            if (confirm('⚠️ This will permanently delete all your data!\n\nThis action cannot be undone. Are you sure you want to continue?')) {
                if (confirm('Last chance! Are you absolutely sure you want to delete ALL your financial data?')) {
                    // Create backup before clearing
                    const backupData = { ...appData };
                    localStorage.setItem('financeAI_emergency_backup', JSON.stringify(backupData));
                    
                    // Clear all data
                    appData = {
                        transactions: [],
                        budgets: [],
                        investments: [],
                        notifications: [],
                        goals: [],
                        settings: {
                            currency: '₹',
                            language: 'en',
                            theme: 'light',
                            notifications: true,
                            autoBackup: true,
                            dataEncryption: true
                        }
                    };
                    
                    // Clear local storage
                    localStorage.removeItem('financeAI_data');
                    
                    // Refresh UI
                    renderTransactions();
                    renderExpensesTable();
                    renderBudgets();
                    updateDashboardStats();
                    initializeExpenseChart();
                    initializePortfolioChart();
                    initializeTrendsChart();
                    
                    showToast('All data cleared successfully. Emergency backup created.', 'success');
                    
                    addNotification({
                        title: '🗑️ Data Cleared',
                        message: 'All data has been cleared. Emergency backup available in settings.',
                        type: 'warning'
                    });
                    
                    closeModal('settingsModal');
                }
            }
        }

        function restoreEmergencyBackup() {
            const emergencyBackup = localStorage.getItem('financeAI_emergency_backup');
            if (emergencyBackup) {
                if (confirm('Restore data from emergency backup?')) {
                    try {
                        appData = JSON.parse(emergencyBackup);
                        
                        // Refresh UI
                        renderTransactions();
                        renderExpensesTable();
                        renderBudgets();
                        updateDashboardStats();
                        initializeExpenseChart();
                        initializePortfolioChart();
                        initializeTrendsChart();
                        saveDataToStorage();
                        
                        showToast('Emergency backup restored successfully!', 'success');
                        
                        // Clear the emergency backup
                        localStorage.removeItem('financeAI_emergency_backup');
                        
                    } catch (error) {
                        showToast('Error restoring emergency backup', 'error');
                    }
                }
            } else {
                showToast('No emergency backup found', 'warning');
            }
        }

        // Enhanced export functions
        function exportExpenses() {
            exportTransactionsCSV();
        }

        function exportBudgetsCSV() {
            const headers = ['Category', 'Budget Name', 'Budget Amount', 'Spent Amount', 'Remaining', 'Percentage Used', 'Start Date', 'Alert Threshold'];
            const csvRows = [headers.join(',')];
            
            appData.budgets.forEach(budget => {
                const remaining = budget.budget - budget.spent;
                const percentageUsed = ((budget.spent / budget.budget) * 100).toFixed(1);
                
                const row = [
                    budget.category,
                    `"${budget.name}"`,
                    budget.budget,
                    budget.spent,
                    remaining,
                    percentageUsed + '%',
                    budget.startDate,
                    budget.alertThreshold + '%'
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `budgets_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('Budgets exported to CSV successfully!', 'success');
        }

        function addInvestment() {
            showToast('Add investment feature coming soon!', 'warning');
        }

        function viewRecommendations() {
            addChatMessage('Based on your portfolio, I recommend diversifying with international equity funds and increasing your debt fund allocation for better risk management.', 'bot');
            toggleChat();
        }

        function portfolioAnalysis() {
            addChatMessage('Your portfolio analysis shows good diversification with 60% equity and 40% debt. Your risk score is moderate and aligned with your age group.', 'bot');
            toggleChat();
        }

        function generateReport() {
            showToast('Financial report generated successfully!', 'success');
        }

        function compareMonths() {
            addChatMessage('Compared to last month, your expenses decreased by 5.2% while income remained stable. Your savings rate improved from 25% to 28.3%.', 'bot');
            toggleChat();
        }

        function forecastAnalysis() {
            addChatMessage('Based on your spending patterns, I forecast your monthly expenses will average ₹28,500 for the next 3 months. Your savings goal of ₹50,000 by December is achievable!', 'bot');
            toggleChat();
        }

        function showDetailedReport() {
            switchToSection('analytics');
        }

        // Profile and Settings Functions
        // Profile and Settings Functions
        function showProfile() {
            openModal('settingsModal');
            updateSettingsModal();
        }

        function updateSettingsModal() {
            // Update settings modal with current data
            document.getElementById('totalTransactions').textContent = appData.transactions.length;
            document.getElementById('lastBackupTime').textContent = new Date(lastBackup).toLocaleString();
            
            // Calculate data size
            const dataSize = new Blob([JSON.stringify(appData)]).size;
            const sizeInKB = (dataSize / 1024).toFixed(2);
            document.getElementById('dataSize').textContent = `${sizeInKB} KB`;
            
            // Update checkbox states
            document.getElementById('notificationsEnabled').checked = appData.settings.notifications;
            document.getElementById('autoBackupEnabled').checked = appData.settings.autoBackup;
        }

        function toggleNotifications() {
            appData.settings.notifications = !appData.settings.notifications;
            saveDataToStorage();
            showToast(`Notifications ${appData.settings.notifications ? 'enabled' : 'disabled'}`, 'info');
        }

        function toggleAutoBackup() {
            appData.settings.autoBackup = !appData.settings.autoBackup;
            saveDataToStorage();
            showToast(`Auto-backup ${appData.settings.autoBackup ? 'enabled' : 'disabled'}`, 'info');
        }

        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        // Footer Link Functions
        function showAbout() { showToast('About page coming soon!', 'warning'); }
        function showTeam() { showToast('Team page coming soon!', 'warning'); }
        function showCareers() { showToast('Careers page coming soon!', 'warning'); }
        function showPress() { showToast('Press page coming soon!', 'warning'); }
        function showBlog() { showToast('Blog coming soon!', 'warning'); }
        function showContact() { showToast('Contact page coming soon!', 'warning'); }
        function showHelp() { 
            addChatMessage('Welcome to FinanceAI Help! I can assist you with expense tracking, budgeting, investment planning, and financial analytics. What would you like to know?', 'bot');
            toggleChat();
        }
        function showSecurity() { showToast('Security information coming soon!', 'warning'); }
        function showPrivacy() { showToast('Privacy policy coming soon!', 'warning'); }
        function showTerms() { showToast('Terms of service coming soon!', 'warning'); }
        function showAPI() { showToast('API documentation coming soon!', 'warning'); }
        function showStatus() { showToast('System status: All systems operational!', 'success'); }

        // Event Listeners
        function setupEventListeners() {
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('active');
                }
                
                // Close notifications panel when clicking outside
                const notificationsPanel = document.getElementById('notificationsPanel');
                const notificationIcon = document.querySelector('.notification-icon');
                if (!notificationsPanel.contains(event.target) && !notificationIcon.contains(event.target)) {
                    notificationsPanel.classList.remove('active');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            switchToSection('dashboard');
                            break;
                        case '2':
                            e.preventDefault();
                            switchToSection('expenses');
                            break;
                        case '3':
                            e.preventDefault();
                            switchToSection('budget');
                            break;
                        case '4':
                            e.preventDefault();
                            switchToSection('investments');
                            break;
                        case '5':
                            e.preventDefault();
                            switchToSection('analytics');
                            break;
                        case 'c':
                            e.preventDefault();
                            toggleChat();
                            break;
                        case 'n':
                            e.preventDefault();
                            addTransaction();
                            break;
                    }
                }
                
                // Escape key to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                    
                    if (chatOpen) {
                        toggleChat();
                    }
                }
            });
        }

        // Initialize mobile responsiveness
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('navLinks').classList.remove('active');
            }
        });

        // Enhanced Notification Toggle
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            
            // Add entrance animation
            if (panel.classList.contains('active')) {
                panel.classList.add('notification-panel-enter');
                
                // Mark notifications as read when panel is opened
                setTimeout(() => {
                    appData.notifications.forEach(notification => {
                        notification.read = true;
                    });
                    updateNotificationBadge();
                    saveDataToStorage();
                }, 1000);
            } else {
                panel.classList.remove('notification-panel-enter');
            }
        }

        // Enhanced Edit Transaction
        function editTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Populate form with existing data
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionDate').value = transaction.date;
            
            // Handle tags if they exist
            if (transaction.tags && transaction.tags.length > 0) {
                document.getElementById('transactionTags').value = transaction.tags.join(', ');
            }
            
            // Mark form as editing
            const submitBtn = document.querySelector('#addTransactionModal button[type="submit"]');
            submitBtn.setAttribute('data-editing', id);
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Transaction';
            
            // Change modal title
            document.querySelector('#addTransactionModal .modal-header h3').textContent = 'Edit Transaction';
            
            openModal('addTransactionModal');
        }

        // Enhanced Delete Transaction with Animation
        function deleteTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            if (confirm('Delete this transaction?\n\n' + transaction.description + '\n' + (transaction.type === 'income' ? '+' : '-') + '₹' + transaction.amount.toLocaleString() + '\n\n⚠️ This action cannot be undone')) {
                const transactionIndex = appData.transactions.findIndex(t => t.id === id);
                if (transactionIndex === -1) return;
                
                // Animate removal
                const transactionRow = document.querySelector(`tr[onclick*="${id}"]`);
                if (transactionRow) {
                    transactionRow.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        transactionRow.style.animation = 'fadeOut 0.3s ease-out forwards';
                    }, 500);
                }
                
                setTimeout(() => {
                    // Update budget if it was an expense
                    if (transaction.type === 'expense') {
                        updateBudgetSpending(transaction.category, -transaction.amount);
                    }
                    
                    appData.transactions.splice(transactionIndex, 1);
                    
                    renderTransactions();
                    renderExpensesTable();
                    renderBudgets();
                    updateDashboardStats();
                    initializeExpenseChart();
                    saveDataToStorage();
                    
                    showToast('Transaction deleted successfully!', 'success');
                }, 800);
            }
        }

        // Add enhanced animations CSS
        const enhancedStyles = document.createElement('style');
        enhancedStyles.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-20px); }
            }
            
            .notification-panel-enter {
                animation: slideInRight 0.3s ease-out;
            }
            
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100%); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            .chart-loading::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 30px;
                height: 30px;
                border: 3px solid #f3f4f6;
                border-top: 3px solid #4f46e5;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                z-index: 10;
            }
            
            .hover-scale {
                transition: transform 0.2s ease;
            }
            
            .hover-scale:hover {
                transform: scale(1.02);
            }
            
            .pulse-success {
                animation: pulseSuccess 0.6s ease-out;
            }
            
            @keyframes pulseSuccess {
                0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
                100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            }
        `;
        document.head.appendChild(enhancedStyles);

        // Authentication Functions
        function checkAuthenticationStatus() {
            const savedUser = localStorage.getItem('financeAI_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser.isAuthenticated) {
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }
            return false;
        }

        function showAuthContainer() {
            document.getElementById('authContainer').classList.add('active');
            document.querySelector('.navbar').style.display = 'none';
            document.querySelector('main').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        }

        function hideAuthContainer() {
            document.getElementById('authContainer').classList.remove('active');
            document.querySelector('.navbar').style.display = 'block';
            document.querySelector('main').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                signupTab.classList.add('active');
                loginTab.classList.remove('active');
                signupForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = document.getElementById('loginSubmit');
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Check credentials (in real app, this would be server-side)
                const user = userDatabase.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Login successful
                    currentUser = {
                        ...currentUser,
                        id: user.id,
                        name: user.name,
                        email: user.email,
                        avatar: user.avatar,
                        isAuthenticated: true,
                        joinDate: user.joinDate,
                        plan: user.plan
                    };
                    
                    // Save user session
                    localStorage.setItem('financeAI_user', JSON.stringify(currentUser));
                    
                    // Hide auth and show app
                    hideAuthContainer();
                    initializeApp();
                    
                    showToast('Welcome back! You have been successfully signed in.', 'success');
                } else {
                    // Login failed
                    showAuthError('loginPassword', 'Invalid email or password');
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                    submitBtn.disabled = false;
                }
            }, 1500);
        }

        function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = document.getElementById('signupSubmit');
            
            // Validate form
            if (!validateSignupForm(name, email, password, confirmPassword)) {
                return;
            }
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Check if user already exists
                const existingUser = userDatabase.find(u => u.email === email);
                
                if (existingUser) {
                    showAuthError('signupEmail', 'An account with this email already exists');
                    submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                    submitBtn.disabled = false;
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: userDatabase.length + 1,
                    name: name,
                    email: email,
                    password: password, // In real app, this would be hashed
                    avatar: null,
                    joinDate: new Date().toISOString().split('T')[0],
                    plan: 'free'
                };
                
                userDatabase.push(newUser);
                
                // Auto-login the new user
                currentUser = {
                    ...currentUser,
                    id: newUser.id,
                    name: newUser.name,
                    email: newUser.email,
                    avatar: newUser.avatar,
                    isAuthenticated: true,
                    joinDate: newUser.joinDate,
                    plan: newUser.plan
                };
                
                // Save user session
                localStorage.setItem('financeAI_user', JSON.stringify(currentUser));
                
                // Hide auth and show app
                hideAuthContainer();
                initializeApp();
                
                showToast('Account created successfully! Welcome to FinanceAI.', 'success');
                
                // Show welcome guide
                setTimeout(() => {
                    addChatMessage(`🎉 Welcome to FinanceAI, ${currentUser.name}! I'm excited to help you manage your finances. Let's start by adding your first transaction or setting up a budget. What would you like to do first?`, 'bot');
                }, 2000);
            }, 2000);
        }

        function validateSignupForm(name, email, password, confirmPassword) {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.auth-error').forEach(error => error.classList.remove('show'));
            document.querySelectorAll('.auth-form-group').forEach(group => group.classList.remove('error'));
            
            // Validate name
            if (name.length < 2) {
                showAuthError('signupName', 'Name must be at least 2 characters long');
                isValid = false;
            }
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAuthError('signupEmail', 'Please enter a valid email address');
                isValid = false;
            }
            
            // Validate password
            if (password.length < 6) {
                showAuthError('signupPassword', 'Password must be at least 6 characters long');
                isValid = false;
            }
            
            // Validate password confirmation
            if (password !== confirmPassword) {
                showAuthError('confirmPassword', 'Passwords do not match');
                isValid = false;
            }
            
            return isValid;
        }

        function showAuthError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            field.parentElement.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        function socialLogin(provider) {
            showToast(`${provider} login will be available soon! Please use email/password for now.`, 'info');
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address to reset your password:');
            if (email) {
                showToast('Password reset link sent to your email address!', 'success');
            }
        }

        function updateUserProfile() {
            const userInitials = document.getElementById('userInitials');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const userAvatar = document.getElementById('userAvatar');
            const dashboardSubtitle = document.getElementById('dashboardSubtitle');
            
            if (currentUser.isAuthenticated) {
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                userInitials.textContent = initials;
                profileName.textContent = currentUser.name;
                profileEmail.textContent = currentUser.email;
                userAvatar.classList.remove('guest');
                
                // Update dashboard welcome message
                const firstName = currentUser.name.split(' ')[0];
                dashboardSubtitle.textContent = `Welcome back, ${firstName}! Here's your financial overview`;
            } else {
                userInitials.textContent = 'G';
                profileName.textContent = 'Guest User';
                profileEmail.textContent = 'guest@financeai.com';
                userAvatar.classList.add('guest');
                dashboardSubtitle.textContent = 'Welcome back, Guest! Here\'s your financial overview';
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function showProfileSettings() {
            toggleProfileDropdown();
            openModal('settingsModal');
            updateSettingsModal();
        }

        function showAccountSettings() {
            toggleProfileDropdown();
            showToast('Account settings will be available in the next update!', 'info');
        }

        function showBillingInfo() {
            toggleProfileDropdown();
            showToast('Billing information will be available in the next update!', 'info');
        }

        function showHelpSupport() {
            toggleProfileDropdown();
            addChatMessage('Hi! I\'m here to help you with FinanceAI. You can ask me about features, how to use the app, or any financial questions you have. What would you like to know?', 'bot');
            toggleChat();
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear user session
                localStorage.removeItem('financeAI_user');
                
                // Reset current user
                currentUser = {
                    id: null,
                    name: 'Guest User',
                    email: 'guest@financeai.com',
                    avatar: null,
                    isAuthenticated: false,
                    joinDate: null,
                    plan: 'free',
                    preferences: {
                        currency: '₹',
                        dateFormat: 'DD/MM/YYYY',
                        notifications: true
                    }
                };
                
                // Clear app data
                localStorage.removeItem('financeAI_data');
                
                // Show auth container
                showAuthContainer();
                
                // Reset forms
                document.getElementById('loginForm').querySelector('form').reset();
                document.getElementById('signupForm').querySelector('form').reset();
                switchAuthTab('login');
                
                showToast('You have been successfully signed out.', 'success');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-avatar')) {
                document.getElementById('profileDropdown').classList.remove('active');
            }
        });

        // Auto Expense Fetching Functions
        function connectPaymentApp(appName) {
            const appNames = {
                'paytm': 'Paytm',
                'googlepay': 'Google Pay',
                'phonepe': 'PhonePe',
                'bankupi': 'Bank UPI'
            };
            
            showToast(`Connecting to ${appNames[appName]}...`, 'info');
            
            // Show connection modal with authentication options
            showPaymentAppConnectionModal(appName);
        }

        function showPaymentAppConnectionModal(appName) {
            const appNames = {
                'paytm': 'Paytm',
                'googlepay': 'Google Pay',
                'phonepe': 'PhonePe',
                'bankupi': 'Bank UPI'
            };

            const modalHTML = `
                <div class="modal-overlay" id="connectionModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; color: #1e293b;">Connect to ${appNames[appName]}</h3>
                            <button onclick="closeConnectionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">×</button>
                        </div>
                        
                        <div id="connectionContent">
                            ${getConnectionContent(appName)}
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button onclick="closeConnectionModal()" style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer;">Cancel</button>
                            <button onclick="authenticatePaymentApp('${appName}')" style="flex: 1; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">Connect</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function getConnectionContent(appName) {
            switch(appName) {
                case 'paytm':
                    return `
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: #64748b; margin-bottom: 1rem;">To connect Paytm, you'll need to provide your registered phone number and authorize access to your transaction history.</p>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number</label>
                                <input type="tel" id="paytmPhone" placeholder="+91 98765 43210" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem; color: #92400e;">How it works:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem; color: #92400e;">
                                    <li>We'll send an OTP to your phone</li>
                                    <li>You'll authorize transaction access via Paytm's secure API</li>
                                    <li>We'll fetch your recent transactions automatically</li>
                                </ul>
                            </div>
                        </div>
                    `;
                
                case 'googlepay':
                    return `
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: #64748b; margin-bottom: 1rem;">Connect your Google Pay account to automatically import transactions.</p>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Google Account Email</label>
                                <input type="email" id="googlePayEmail" placeholder="your.email@gmail.com" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            
                            <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem; color: #1e40af;">OAuth 2.0 Authentication</h4>
                                <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">You'll be redirected to Google's secure login page to authorize transaction access.</p>
                            </div>
                        </div>
                    `;
                
                case 'phonepe':
                    return `
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: #64748b; margin-bottom: 1rem;">Connect PhonePe using your UPI ID to import transaction history.</p>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">UPI ID</label>
                                <input type="text" id="phonepeUPI" placeholder="yourname@phonepe" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number</label>
                                <input type="tel" id="phonepePhone" placeholder="+91 98765 43210" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            
                            <div style="background: #f3e8ff; border: 1px solid #8b5cf6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem; color: #6b21a8;">Secure Connection</h4>
                                <p style="margin: 0; color: #6b21a8; font-size: 0.9rem;">We use PhonePe's official API with bank-level security to access your transaction data.</p>
                            </div>
                        </div>
                    `;
                
                case 'bankupi':
                    return `
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: #64748b; margin-bottom: 1rem;">Connect your bank account for comprehensive transaction tracking.</p>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Bank Name</label>
                                <select id="bankName" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                    <option value="">Select your bank</option>
                                    <option value="sbi">State Bank of India</option>
                                    <option value="hdfc">HDFC Bank</option>
                                    <option value="icici">ICICI Bank</option>
                                    <option value="axis">Axis Bank</option>
                                    <option value="kotak">Kotak Mahindra</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Account Number (Last 4 digits)</label>
                                <input type="text" id="accountNumber" placeholder="XXXX" maxlength="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            
                            <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem; color: #047857;">Bank Integration</h4>
                                <p style="margin: 0; color: #047857; font-size: 0.9rem;">We'll parse SMS notifications from your bank to automatically track transactions.</p>
                            </div>
                        </div>
                    `;
                
                default:
                    return '<p>Connection method not available for this payment app.</p>';
            }
        }

        function closeConnectionModal() {
            const modal = document.getElementById('connectionModal');
            if (modal) {
                modal.remove();
            }
        }

        async function authenticatePaymentApp(appName) {
            const connectionButton = event.target;
            const originalText = connectionButton.textContent;
            
            connectionButton.textContent = 'Connecting...';
            connectionButton.disabled = true;
            
            try {
                let credentials = {};
                
                // Collect credentials based on app type
                switch(appName) {
                    case 'paytm':
                        const phoneNumber = document.getElementById('paytmPhone').value;
                        if (!phoneNumber) {
                            throw new Error('Please enter your phone number');
                        }
                        credentials = { phoneNumber };
                        break;
                        
                    case 'googlepay':
                        const email = document.getElementById('googlePayEmail').value;
                        if (!email) {
                            throw new Error('Please enter your Google account email');
                        }
                        credentials = { email };
                        // For Google Pay, we'd normally redirect to OAuth
                        await handleGooglePayOAuth(email);
                        break;
                        
                    case 'phonepe':
                        const upiId = document.getElementById('phonepeUPI').value;
                        const phone = document.getElementById('phonepePhone').value;
                        if (!upiId || !phone) {
                            throw new Error('Please enter both UPI ID and phone number');
                        }
                        credentials = { upiId, phoneNumber: phone };
                        break;
                        
                    case 'bankupi':
                        const bankName = document.getElementById('bankName').value;
                        const accountNumber = document.getElementById('accountNumber').value;
                        if (!bankName || !accountNumber) {
                            throw new Error('Please select bank and enter account details');
                        }
                        credentials = { bankName, accountNumber };
                        break;
                }
                
                // Call backend API to establish connection
                const response = await fetch('/api/transactions/auto-fetch/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        method: appName,
                        credentials: credentials
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Connection failed');
                }
                
                // Handle different response types
                if (result.requiresOTP) {
                    // Show OTP verification
                    await handleOTPVerification(appName, credentials);
                } else if (result.requiresRedirect) {
                    // Handle OAuth redirect
                    window.location.href = result.redirectUrl;
                    return;
                } else {
                    // Connection successful
                    await handleSuccessfulConnection(appName, result.data);
                }
                
            } catch (error) {
                showToast(`❌ Connection failed: ${error.message}`, 'error');
                connectionButton.textContent = originalText;
                connectionButton.disabled = false;
            }
        }

        async function handleGooglePayOAuth(email) {
            // Simulate OAuth flow
            showToast('Redirecting to Google for authentication...', 'info');
            
            // In a real implementation, you'd redirect to:
            // https://accounts.google.com/oauth/authorize?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&scope=https://www.googleapis.com/auth/payments.consumer&response_type=code
            
            // For demo purposes, simulate the OAuth flow
            setTimeout(() => {
                const authCode = 'demo_auth_code_' + Date.now();
                handleOAuthCallback('googlepay', authCode);
            }, 2000);
        }

        async function handleOTPVerification(appName, credentials) {
            const otpModal = `
                <div class="modal-overlay" id="otpModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 1rem; color: #1e293b;">Enter OTP</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">We've sent a verification code to your phone number.</p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" style="width: 100%; padding: 1rem; border: 1px solid #d1d5db; border-radius: 8px; text-align: center; font-size: 1.2rem; letter-spacing: 0.5rem;">
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="closeOTPModal()" style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer;">Cancel</button>
                            <button onclick="verifyOTP('${appName}')" style="flex: 1; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">Verify</button>
                        </div>
                        
                        <p style="text-align: center; margin-top: 1rem; color: #64748b; font-size: 0.9rem;">
                            Didn't receive OTP? <a href="#" onclick="resendOTP('${appName}')" style="color: #3b82f6; text-decoration: none;">Resend</a>
                        </p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', otpModal);
            
            // Auto-focus OTP input
            setTimeout(() => {
                document.getElementById('otpInput').focus();
            }, 100);
        }

        function closeOTPModal() {
            const modal = document.getElementById('otpModal');
            if (modal) {
                modal.remove();
            }
        }

        async function verifyOTP(appName) {
            const otp = document.getElementById('otpInput').value;
            
            if (!otp || otp.length !== 6) {
                showToast('Please enter a valid 6-digit OTP', 'error');
                return;
            }
            
            const verifyButton = event.target;
            verifyButton.textContent = 'Verifying...';
            verifyButton.disabled = true;
            
            try {
                // Call backend to verify OTP
                const response = await fetch('/api/transactions/auto-fetch/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        method: appName,
                        otp: otp
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'OTP verification failed');
                }
                
                closeOTPModal();
                await handleSuccessfulConnection(appName, result.data);
                
            } catch (error) {
                showToast(`❌ Verification failed: ${error.message}`, 'error');
                verifyButton.textContent = 'Verify';
                verifyButton.disabled = false;
            }
        }

        async function resendOTP(appName) {
            try {
                showToast('Resending OTP...', 'info');
                
                const response = await fetch('/api/transactions/auto-fetch/resend-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        method: appName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('OTP resent successfully', 'success');
                } else {
                    throw new Error(result.message || 'Failed to resend OTP');
                }
                
            } catch (error) {
                showToast(`❌ ${error.message}`, 'error');
            }
        }

        async function handleOAuthCallback(appName, authCode) {
            try {
                const response = await fetch('/api/transactions/auto-fetch/oauth-callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        method: appName,
                        authCode: authCode
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'OAuth verification failed');
                }
                
                await handleSuccessfulConnection(appName, result.data);
                
            } catch (error) {
                showToast(`❌ Authentication failed: ${error.message}`, 'error');
            }
        }

        async function handleSuccessfulConnection(appName, connectionData) {
            const appNames = {
                'paytm': 'Paytm',
                'googlepay': 'Google Pay',
                'phonepe': 'PhonePe',
                'bankupi': 'Bank UPI'
            };
            
            // Close connection modal
            closeConnectionModal();
            
            // Update UI to show connected status
            const cards = document.querySelectorAll('.payment-app-card');
            cards.forEach(card => {
                const cardTitle = card.querySelector('h4').textContent;
                if (cardTitle === appNames[appName]) {
                    const statusBadge = card.querySelector('.status-badge');
                    
                    // Change border color and status
                    card.style.borderColor = '#10b981';
                    card.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                    statusBadge.style.background = '#10b981';
                    statusBadge.textContent = 'Connected';
                    
                    // Add connection info
                    const connectionInfo = document.createElement('div');
                    connectionInfo.style.cssText = 'margin-top: 0.5rem; font-size: 0.8rem; color: #10b981;';
                    connectionInfo.textContent = `Last sync: ${new Date().toLocaleDateString()}`;
                    card.appendChild(connectionInfo);
                }
            });
            
            showToast(`✅ Successfully connected to ${appNames[appName]}!`, 'success');
            
            // Store connection status
            const connectedApps = JSON.parse(localStorage.getItem('connectedPaymentApps') || '{}');
            connectedApps[appName] = {
                connected: true,
                connectedAt: new Date().toISOString(),
                ...connectionData
            };
            localStorage.setItem('connectedPaymentApps', JSON.stringify(connectedApps));
            
            // Automatically fetch recent transactions
            setTimeout(() => {
                fetchRecentTransactions(appName);
            }, 1000);
        }

        // Check connection status on page load
        function checkPaymentAppConnections() {
            const connectedApps = JSON.parse(localStorage.getItem('connectedPaymentApps') || '{}');
            const appNames = {
                'paytm': 'Paytm',
                'googlepay': 'Google Pay',
                'phonepe': 'PhonePe',
                'bankupi': 'Bank UPI'
            };
            
            Object.keys(connectedApps).forEach(appName => {
                if (connectedApps[appName].connected) {
                    const cards = document.querySelectorAll('.payment-app-card');
                    cards.forEach(card => {
                        const cardTitle = card.querySelector('h4').textContent;
                        if (cardTitle === appNames[appName]) {
                            const statusBadge = card.querySelector('.status-badge');
                            
                            // Update UI to show connected status
                            card.style.borderColor = '#10b981';
                            card.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                            statusBadge.style.background = '#10b981';
                            statusBadge.textContent = 'Connected';
                            
                            // Add connection info
                            const connectionInfo = document.createElement('div');
                            connectionInfo.style.cssText = 'margin-top: 0.5rem; font-size: 0.8rem; color: #10b981;';
                            const connectedDate = new Date(connectedApps[appName].connectedAt);
                            connectionInfo.textContent = `Connected: ${connectedDate.toLocaleDateString()}`;
                            card.appendChild(connectionInfo);
                            
                            // Add disconnect button
                            const disconnectBtn = document.createElement('button');
                            disconnectBtn.style.cssText = 'margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;';
                            disconnectBtn.textContent = 'Disconnect';
                            disconnectBtn.onclick = (e) => {
                                e.stopPropagation();
                                disconnectPaymentApp(appName);
                            };
                            card.appendChild(disconnectBtn);
                        }
                    });
                }
            });
        }

        // Function to disconnect payment app
        async function disconnectPaymentApp(appName) {
            const appNames = {
                'paytm': 'Paytm',
                'googlepay': 'Google Pay',
                'phonepe': 'PhonePe',
                'bankupi': 'Bank UPI'
            };

            if (confirm(`Are you sure you want to disconnect ${appNames[appName]}?`)) {
                try {
                    const response = await fetch('/api/transactions/auto-fetch/disconnect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                        },
                        body: JSON.stringify({
                            method: appName
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update localStorage
                        const connectedApps = JSON.parse(localStorage.getItem('connectedPaymentApps') || '{}');
                        delete connectedApps[appName];
                        localStorage.setItem('connectedPaymentApps', JSON.stringify(connectedApps));
                        
                        // Reset UI
                        const cards = document.querySelectorAll('.payment-app-card');
                        cards.forEach(card => {
                            const cardTitle = card.querySelector('h4').textContent;
                            if (cardTitle === appNames[appName]) {
                                const statusBadge = card.querySelector('.status-badge');
                                
                                // Reset to disconnected status
                                card.style.borderColor = '#e2e8f0';
                                card.style.backgroundColor = 'white';
                                statusBadge.style.background = '#64748b';
                                statusBadge.textContent = 'Not Connected';
                                
                                // Remove connection info and disconnect button
                                const extraElements = card.querySelectorAll('div:not(.status-badge), button');
                                extraElements.forEach(el => {
                                    if (el.textContent.includes('Connected:') || el.textContent === 'Disconnect') {
                                        el.remove();
                                    }
                                });
                            }
                        });
                        
                        showToast(`${appNames[appName]} disconnected successfully`, 'success');
                    } else {
                        throw new Error(result.message || 'Disconnection failed');
                    }
                    
                } catch (error) {
                    showToast(`❌ Failed to disconnect: ${error.message}`, 'error');
                }
            }
        }

        function fetchRecentTransactions(appName) {
            const simulatedTransactions = {
                'paytm': [
                    { amount: 250, description: 'Zomato Food Order', category: 'Food', date: new Date().toISOString().split('T')[0] },
                    { amount: 120, description: 'Auto Rickshaw', category: 'Transportation', date: new Date().toISOString().split('T')[0] },
                    { amount: 50, description: 'Mobile Recharge', category: 'Bills', date: new Date().toISOString().split('T')[0] }
                ],
                'googlepay': [
                    { amount: 450, description: 'Grocery Store', category: 'Shopping', date: new Date().toISOString().split('T')[0] },
                    { amount: 80, description: 'Coffee Shop', category: 'Food', date: new Date().toISOString().split('T')[0] }
                ],
                'phonepe': [
                    { amount: 300, description: 'Petrol Pump', category: 'Transportation', date: new Date().toISOString().split('T')[0] },
                    { amount: 199, description: 'Netflix Subscription', category: 'Entertainment', date: new Date().toISOString().split('T')[0] }
                ],
                'bankupi': [
                    { amount: 1200, description: 'Electricity Bill', category: 'Bills', date: new Date().toISOString().split('T')[0] },
                    { amount: 850, description: 'Medical Store', category: 'Healthcare', date: new Date().toISOString().split('T')[0] }
                ]
            };
            
            const transactions = simulatedTransactions[appName] || [];
            let addedCount = 0;
            
            transactions.forEach(transaction => {
                // Check for duplicates
                const isDuplicate = appData.transactions.some(t => 
                    t.description === transaction.description && 
                    t.amount === transaction.amount && 
                    t.date === transaction.date
                );
                
                if (!isDuplicate) {
                    const newTransaction = {
                        id: Date.now() + Math.random(),
                        ...transaction,
                        type: 'expense',
                        tags: ['auto-fetched', appName]
                    };
                    
                    appData.transactions.unshift(newTransaction);
                    addedCount++;
                    
                    // Update budget if it's an expense
                    updateBudgetSpending(transaction.category, transaction.amount);
                }
            });
            
            if (addedCount > 0) {
                showToast(`🎉 Added ${addedCount} new transactions from ${appName}!`, 'success');
                
                // Refresh UI
                renderTransactions();
                renderExpensesTable();
                renderBudgets();
                updateDashboardStats();
                initializeExpenseChart();
                saveDataToStorage();
                
                // Add notification
                addNotification({
                    title: '💳 Auto-Fetch Complete',
                    message: `Successfully imported ${addedCount} transactions from ${appName}`,
                    type: 'success'
                });
            } else {
                showToast(`No new transactions found in ${appName}`, 'info');
            }
        }

        function enableSMSParsing() {
            showToast('SMS parsing feature will be available in the mobile app!', 'info');
            
            // Simulate SMS parsing setup
            setTimeout(() => {
                addNotification({
                    title: '📱 SMS Parsing Enabled',
                    message: 'We\'ll now automatically detect transaction SMS from your bank and payment apps',
                    type: 'success'
                });
                
                showToast('✅ SMS parsing enabled! We\'ll detect transaction messages automatically.', 'success');
            }, 1500);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2);
            
            showToast(`Processing ${fileName} (${fileSize} KB)...`, 'info');
            
            // Simulate file processing
            setTimeout(() => {
                // Simulate parsed transactions from CSV/Excel
                const simulatedTransactions = [
                    { amount: 2500, description: 'ATM Withdrawal', category: 'Other', date: '2025-09-15', type: 'expense' },
                    { amount: 45000, description: 'Salary Credit', category: 'Income', date: '2025-09-01', type: 'income' },
                    { amount: 3200, description: 'Online Shopping', category: 'Shopping', date: '2025-09-14', type: 'expense' },
                    { amount: 890, description: 'Restaurant Bill', category: 'Food', date: '2025-09-13', type: 'expense' },
                    { amount: 150, description: 'Bus Ticket', category: 'Transportation', date: '2025-09-12', type: 'expense' }
                ];
                
                let addedCount = 0;
                simulatedTransactions.forEach(transaction => {
                    const newTransaction = {
                        id: Date.now() + Math.random(),
                        ...transaction,
                        tags: ['imported', 'bank-statement']
                    };
                    
                    appData.transactions.unshift(newTransaction);
                    addedCount++;
                    
                    if (transaction.type === 'expense') {
                        updateBudgetSpending(transaction.category, transaction.amount);
                    }
                });
                
                showToast(`🎉 Successfully imported ${addedCount} transactions from ${fileName}!`, 'success');
                
                // Refresh UI
                renderTransactions();
                renderExpensesTable();
                renderBudgets();
                updateDashboardStats();
                initializeExpenseChart();
                saveDataToStorage();
                
                // Clear file input
                event.target.value = '';
                
                // Add notification
                addNotification({
                    title: '📊 File Import Complete',
                    message: `Successfully imported ${addedCount} transactions from bank statement`,
                    type: 'success'
                });
                
            }, 2000);
        }

        function saveAutoFetchSettings() {
            const settings = {
                autoFetchDaily: document.getElementById('autoFetchDaily').checked,
                autoFetchWeekly: document.getElementById('autoFetchWeekly').checked,
                duplicateDetection: document.getElementById('duplicateDetection').checked,
                smartCategorization: document.getElementById('smartCategorization').checked
            };
            
            // Save to app data
            appData.settings.autoFetch = settings;
            saveDataToStorage();
            
            showToast('✅ Auto-fetch settings saved successfully!', 'success');
            
            // Add notification about automatic fetching
            if (settings.autoFetchDaily) {
                addNotification({
                    title: '🤖 Auto-Fetch Enabled',
                    message: 'We\'ll automatically check for new transactions daily',
                    type: 'info'
                });
            }
            
            closeModal('autoExpenseModal');
        }

        // Enhanced manual cash transaction entry
        // Handle receipt upload
        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('receiptPreview');
            const fileName = document.getElementById('receiptFileName');
            
            fileName.textContent = file.name;
            preview.style.display = 'block';
            
            // Change upload area appearance
            const uploadArea = document.querySelector('.receipt-upload-area');
            uploadArea.style.borderColor = '#10b981';
            uploadArea.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
            
            showToast('Receipt uploaded successfully!', 'success');
            
            // In a real app, you would upload the file to a server here
            // For demo purposes, we'll just store the file name
        }

        function removeReceipt() {
            document.getElementById('receiptFile').value = '';
            document.getElementById('receiptPreview').style.display = 'none';
            
            // Reset upload area appearance
            const uploadArea = document.querySelector('.receipt-upload-area');
            uploadArea.style.borderColor = '#cbd5e1';
            uploadArea.style.backgroundColor = 'transparent';
        }

        // Listen for payment method changes to show/hide location field
        document.addEventListener('DOMContentLoaded', function() {
            const paymentMethodSelect = document.getElementById('transactionPaymentMethod');
            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', function() {
                    const locationGroup = document.getElementById('locationGroup');
                    if (this.value === 'cash') {
                        locationGroup.style.display = 'block';
                    } else {
                        locationGroup.style.display = 'none';
                    }
                });
            }
        });

        // Enhanced transaction submission to include new fields
        function submitTransaction(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                const formData = {
                    type: document.getElementById('transactionType').value,
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    category: document.getElementById('transactionCategory').value,
                    description: document.getElementById('transactionDescription').value,
                    date: document.getElementById('transactionDate').value,
                    paymentMethod: document.getElementById('transactionPaymentMethod').value,
                    location: document.getElementById('transactionLocation').value,
                    tags: document.getElementById('transactionTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                    receipt: document.getElementById('receiptFile').files[0]?.name || null
                };
                
                // Check if editing existing transaction
                const transactionId = submitBtn.getAttribute('data-editing');
                
                if (transactionId) {
                    // Update existing transaction
                    const transactionIndex = appData.transactions.findIndex(t => t.id === parseInt(transactionId));
                    
                    if (transactionIndex !== -1) {
                        const oldTransaction = { ...appData.transactions[transactionIndex] };
                        
                        // Update transaction
                        appData.transactions[transactionIndex] = {
                            ...oldTransaction,
                            ...formData,
                            id: parseInt(transactionId) // Keep original ID
                        };
                        
                        // Update budget if category or amount changed
                        if (oldTransaction.type === 'expense') {
                            updateBudgetSpending(oldTransaction.category, -oldTransaction.amount);
                        }
                        if (formData.type === 'expense') {
                            updateBudgetSpending(formData.category, formData.amount);
                        }
                        
                        showToast('Transaction updated successfully!', 'success');
                        submitBtn.removeAttribute('data-editing');
                    }
                } else {
                    // Create new transaction
                    const newTransaction = {
                        id: Date.now(),
                        ...formData
                    };
                    
                    appData.transactions.unshift(newTransaction);
                    
                    // Update budgets if it's an expense
                    if (newTransaction.type === 'expense') {
                        updateBudgetSpending(newTransaction.category, newTransaction.amount);
                    }
                    
                    showToast('Transaction added successfully!', 'success');
                    
                    // Add achievement notification for first transaction
                    if (appData.transactions.length === 1) {
                        addNotification({
                            title: '🎉 First Transaction Added!',
                            message: 'Welcome to FinanceAI! You\'re on your way to better financial management.',
                            type: 'success'
                        });
                    }
                    
                    // Special message for cash transactions
                    if (formData.paymentMethod === 'cash') {
                        addNotification({
                            title: '💵 Cash Transaction Added',
                            message: `${formData.description} - ₹${formData.amount} (Cash)`,
                            type: 'info'
                        });
                    }
                }
                
                // Refresh UI
                renderTransactions();
                renderExpensesTable();
                renderBudgets();
                updateDashboardStats();
                initializeExpenseChart();
                checkBudgetAlerts();
                saveDataToStorage();
                
                // Reset form and close modal
                event.target.reset();
                removeReceipt();
                document.getElementById('locationGroup').style.display = 'none';
                closeModal('addTransactionModal');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Add confetti animation for large amounts
                if (formData.amount > 10000) {
                    createConfettiAnimation();
                }
            }, 800); // Simulate processing time
        }

        // Simulate real-time transaction detection
        function simulateRealTimeTransactions() {
            setInterval(() => {
                // Randomly add transactions (simulating real-time detection)
                if (Math.random() > 0.98) { // Very low chance to not spam
                    const randomTransactions = [
                        { amount: 50, description: 'Coffee Shop', category: 'Food' },
                        { amount: 25, description: 'Auto Fare', category: 'Transportation' },
                        { amount: 150, description: 'Pharmacy', category: 'Healthcare' },
                        { amount: 200, description: 'Grocery Store', category: 'Shopping' }
                    ];
                    
                    const transaction = randomTransactions[Math.floor(Math.random() * randomTransactions.length)];
                    const newTransaction = {
                        id: Date.now(),
                        ...transaction,
                        type: 'expense',
                        date: new Date().toISOString().split('T')[0],
                        tags: ['auto-detected', 'real-time']
                    };
                    
                    appData.transactions.unshift(newTransaction);
                    updateBudgetSpending(transaction.category, transaction.amount);
                    
                    renderTransactions();
                    updateDashboardStats();
                    
                    addNotification({
                        title: '💳 Transaction Detected',
                        message: `${transaction.description} - ₹${transaction.amount}`,
                        type: 'info'
                    });
                    
                    showToast(`New transaction detected: ${transaction.description}`, 'info');
                }

        // Advanced Features Functions

        // Receipt Scanning
        function scanReceipt() {
            document.getElementById('receiptScanModal').style.display = 'flex';
        }

        function closeReceiptScanModal() {
            document.getElementById('receiptScanModal').style.display = 'none';
            document.getElementById('receiptImage').value = '';
            document.getElementById('receiptPreview').style.display = 'none';
        }

        function previewReceipt(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('receiptPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Receipt Preview" style="max-width: 100%; height: auto; border-radius: 8px;">`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        async function processReceipt() {
            const fileInput = document.getElementById('receiptImage');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a receipt image', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('receipt', file);

            try {
                document.getElementById('receiptProcessing').style.display = 'block';
                
                const response = await fetch('/api/advanced/receipt-scan', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // Auto-fill transaction form with extracted data
                    const newTransaction = {
                        id: Date.now(),
                        type: 'expense',
                        amount: data.total,
                        description: data.merchant || 'Receipt Expense',
                        category: data.category,
                        date: data.date ? data.date.split('T')[0] : new Date().toISOString().split('T')[0],
                        merchant: data.merchant,
                        notes: `Items: ${data.items.map(item => item.name).join(', ')}`,
                        paymentMethod: 'card',
                        tags: ['receipt-scanned']
                    };

                    appData.transactions.unshift(newTransaction);
                    updateBudgetSpending(newTransaction.category, newTransaction.amount);
                    renderTransactions();
                    updateDashboardStats();
                    
                    showToast(`Receipt processed! Added ${data.merchant} - ₹${data.total}`, 'success');
                    closeReceiptScanModal();
                } else {
                    showToast('Failed to process receipt', 'error');
                }
            } catch (error) {
                console.error('Receipt processing error:', error);
                showToast('Error processing receipt', 'error');
            } finally {
                document.getElementById('receiptProcessing').style.display = 'none';
            }
        }

        // Recurring Transactions
        function showRecurringTransactions() {
            document.getElementById('recurringModal').style.display = 'flex';
            loadRecurringTransactions();
        }

        function closeRecurringModal() {
            document.getElementById('recurringModal').style.display = 'none';
        }

        function showAddRecurring() {
            document.getElementById('addRecurringModal').style.display = 'flex';
        }

        function closeAddRecurringModal() {
            document.getElementById('addRecurringModal').style.display = 'none';
            document.getElementById('recurringForm').reset();
        }

        async function addRecurringTransaction() {
            const form = document.getElementById('recurringForm');
            const formData = new FormData(form);
            
            const recurringData = {
                name: formData.get('name'),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                frequency: formData.get('frequency'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate') || null,
                type: formData.get('type'),
                autoApprove: formData.get('autoApprove') === 'on'
            };

            try {
                const response = await fetch('/api/advanced/recurring', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(recurringData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('Recurring transaction created successfully!', 'success');
                    closeAddRecurringModal();
                    loadRecurringTransactions();
                } else {
                    showToast(result.message || 'Failed to create recurring transaction', 'error');
                }
            } catch (error) {
                console.error('Error creating recurring transaction:', error);
                showToast('Error creating recurring transaction', 'error');
            }
        }

        async function loadRecurringTransactions() {
            // For demo purposes, show some sample recurring transactions
            const recurringList = document.getElementById('recurringList');
            recurringList.innerHTML = `
                <div class="recurring-item">
                    <div class="recurring-info">
                        <h4>Netflix Subscription</h4>
                        <p>Monthly • ₹799 • Next: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}</p>
                    </div>
                    <div class="recurring-actions">
                        <button class="btn-small" onclick="editRecurring(1)">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteRecurring(1)">Delete</button>
                    </div>
                </div>
                <div class="recurring-item">
                    <div class="recurring-info">
                        <h4>Internet Bill</h4>
                        <p>Monthly • ₹1200 • Next: ${new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString()}</p>
                    </div>
                    <div class="recurring-actions">
                        <button class="btn-small" onclick="editRecurring(2)">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteRecurring(2)">Delete</button>
                    </div>
                </div>
            `;
        }

        // AI Insights
        function showInsights() {
            document.getElementById('insightsModal').style.display = 'flex';
            generateInsights();
        }

        function closeInsightsModal() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        async function generateInsights() {
            const insightsContainer = document.getElementById('insightsContainer');
            insightsContainer.innerHTML = '<div class="loading">Generating AI insights...</div>';

            try {
                const response = await fetch('/api/advanced/insights', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    displayInsights(result.data);
                } else {
                    // Show demo insights for now
                    showDemoInsights();
                }
            } catch (error) {
                console.error('Error generating insights:', error);
                showDemoInsights();
            }
        }

        function showDemoInsights() {
            const demoInsights = [
                {
                    type: 'spending_spike',
                    title: 'Unusual Spending Detected',
                    description: 'Your spending this month is 23% higher than your average.',
                    priority: 8,
                    actionable: true,
                    recommendations: ['Review monthly expenses', 'Set spending alerts', 'Consider budget adjustment']
                },
                {
                    type: 'category_dominance',
                    title: 'Food & Dining Alert',
                    description: 'Food represents 45% of your total spending this month.',
                    priority: 7,
                    actionable: true,
                    recommendations: ['Set dining budget', 'Cook more at home', 'Track daily food expenses']
                },
                {
                    type: 'savings_opportunity',
                    title: 'Subscription Review Needed',
                    description: 'You have 8 active subscriptions costing ₹3,200 monthly.',
                    priority: 6,
                    actionable: true,
                    recommendations: ['Cancel unused services', 'Look for family plans', 'Annual discount options']
                }
            ];
            
            displayInsights(demoInsights);
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsContainer');
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="no-insights">No insights available at the moment.</div>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div class="insight-card priority-${insight.priority}">
                    <div class="insight-header">
                        <h3>${insight.title}</h3>
                        <span class="insight-priority">Priority: ${insight.priority}/10</span>
                    </div>
                    <p class="insight-description">${insight.description}</p>
                    ${insight.actionable ? `
                        <div class="insight-recommendations">
                            <h4>Recommendations:</h4>
                            <ul>
                                ${insight.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Advanced Analytics
        function showAdvancedAnalytics() {
            document.getElementById('analyticsModal').style.display = 'flex';
            loadAdvancedAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        async function loadAdvancedAnalytics() {
            const analyticsContainer = document.getElementById('analyticsContainer');
            analyticsContainer.innerHTML = '<div class="loading">Loading advanced analytics...</div>';

            try {
                const response = await fetch('/api/advanced/analytics?period=monthly', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    displayAdvancedAnalytics(result.data);
                } else {
                    showDemoAnalytics();
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showDemoAnalytics();
            }
        }

        function showDemoAnalytics() {
            const demoData = {
                analytics: {
                    totalTransactions: 245,
                    totalIncome: 75000,
                    totalExpenses: 68500,
                    categorizedExpenses: {
                        'Food': 18500,
                        'Transportation': 12000,
                        'Entertainment': 8500,
                        'Utilities': 6500,
                        'Shopping': 15000
                    },
                    averageTransactionSize: 892,
                    frequentCategories: [
                        { category: 'Food', count: 89 },
                        { category: 'Transportation', count: 45 },
                        { category: 'Shopping', count: 32 }
                    ]
                }
            };
            
            displayAdvancedAnalytics(demoData);
        }

        function displayAdvancedAnalytics(data) {
            const container = document.getElementById('analyticsContainer');
            const analytics = data.analytics;
            
            container.innerHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Transaction Summary</h3>
                        <div class="analytics-stats">
                            <div class="stat">
                                <span class="stat-label">Total Transactions</span>
                                <span class="stat-value">${analytics.totalTransactions}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Average Amount</span>
                                <span class="stat-value">₹${analytics.averageTransactionSize?.toFixed(0) || 0}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Income vs Expenses</h3>
                        <div class="analytics-chart">
                            <div class="chart-bar">
                                <div class="bar income" style="width: ${(analytics.totalIncome / (analytics.totalIncome + analytics.totalExpenses)) * 100}%">
                                    <span>Income: ₹${analytics.totalIncome}</span>
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar expense" style="width: ${(analytics.totalExpenses / (analytics.totalIncome + analytics.totalExpenses)) * 100}%">
                                    <span>Expenses: ₹${analytics.totalExpenses}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Top Categories</h3>
                        <div class="category-breakdown">
                            ${Object.entries(analytics.categorizedExpenses || {})
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([category, amount]) => `
                                    <div class="category-item">
                                        <span class="category-name">${category}</span>
                                        <span class="category-amount">₹${amount}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Auto-categorization function
        async function suggestCategory(description, amount) {
            try {
                const response = await fetch('/api/advanced/categorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ description, amount })
                });

                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                }
            } catch (error) {
                console.error('Error suggesting category:', error);
            }
            
            return null;
        }

        // Initialize advanced features on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Detect patterns and suggest recurring transactions
            setTimeout(detectRecurringPatterns, 5000);
        });

        async function detectRecurringPatterns() {
            try {
                const response = await fetch('/api/advanced/detect-recurring', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    showRecurringPatternSuggestions(result.data);
                }
            } catch (error) {
                console.error('Error detecting patterns:', error);
            }
        }

        function showRecurringPatternSuggestions(patterns) {
            const suggestions = patterns.slice(0, 2); // Show top 2 suggestions
            
            suggestions.forEach(pattern => {
                addNotification({
                    title: '🔄 Recurring Pattern Detected',
                    message: `${pattern.description} appears ${pattern.occurrences} times. Create recurring transaction?`,
                    type: 'info',
                    action: () => createRecurringFromPattern(pattern)
                });
            });
        }

        function createRecurringFromPattern(pattern) {
            document.getElementById('addRecurringModal').style.display = 'flex';
            
            // Pre-fill form with pattern data
            document.getElementById('recurringName').value = pattern.description;
            document.getElementById('recurringDescription').value = pattern.description;
            document.getElementById('recurringAmount').value = pattern.amount;
            document.getElementById('recurringCategory').value = pattern.category;
            document.getElementById('recurringFrequency').value = pattern.frequency;
        }
        </script>

        <!-- Advanced Feature Modals -->
        
        <!-- Receipt Scan Modal -->
        <div id="receiptScanModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>📸 Scan Receipt</h2>
                    <span class="close" onclick="closeReceiptScanModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="receiptImage">Upload Receipt Image</label>
                        <input type="file" id="receiptImage" accept="image/*" onchange="previewReceipt(event)" required>
                    </div>
                    
                    <div id="receiptPreview" style="display: none; margin: 1rem 0;"></div>
                    
                    <div id="receiptProcessing" style="display: none;" class="loading">
                        Processing receipt... This may take a few seconds.
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeReceiptScanModal()">Cancel</button>
                        <button type="button" class="btn" onclick="processReceipt()">
                            <i class="fas fa-magic"></i> Process Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recurring Transactions Modal -->
        <div id="recurringModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>🔄 Recurring Transactions</h2>
                    <span class="close" onclick="closeRecurringModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-actions">
                        <button class="btn" onclick="showAddRecurring()">
                            <i class="fas fa-plus"></i> Add Recurring Transaction
                        </button>
                    </div>
                    
                    <div id="recurringList" class="recurring-list">
                        <!-- Recurring transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Recurring Transaction Modal -->
        <div id="addRecurringModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>➕ Add Recurring Transaction</h2>
                    <span class="close" onclick="closeAddRecurringModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="recurringForm" onsubmit="event.preventDefault(); addRecurringTransaction();">
                        <div class="form-group">
                            <label for="recurringName">Name</label>
                            <input type="text" id="recurringName" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="recurringDescription">Description</label>
                            <input type="text" id="recurringDescription" name="description" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recurringAmount">Amount</label>
                                <input type="number" id="recurringAmount" name="amount" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="recurringType">Type</label>
                                <select id="recurringType" name="type" required>
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recurringCategory">Category</label>
                                <select id="recurringCategory" name="category" required>
                                    <option value="Food">Food & Dining</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Bills">Bills</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="recurringFrequency">Frequency</label>
                                <select id="recurringFrequency" name="frequency" required>
                                    <option value="weekly">Weekly</option>
                                    <option value="bi-weekly">Bi-weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annually">Annually</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recurringStartDate">Start Date</label>
                                <input type="date" id="recurringStartDate" name="startDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="recurringEndDate">End Date (Optional)</label>
                                <input type="date" id="recurringEndDate" name="endDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="autoApprove">
                                <span class="checkmark"></span>
                                Auto-approve transactions
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeAddRecurringModal()">Cancel</button>
                            <button type="submit" class="btn">Create Recurring Transaction</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- AI Insights Modal -->
        <div id="insightsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>💡 AI Financial Insights</h2>
                    <span class="close" onclick="closeInsightsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="insights-header">
                        <button class="btn btn-secondary" onclick="generateInsights()">
                            <i class="fas fa-sync"></i> Refresh Insights
                        </button>
                    </div>
                    
                    <div id="insightsContainer" class="insights-container">
                        <!-- Insights will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Modal -->
        <div id="analyticsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>📊 Advanced Analytics</h2>
                    <span class="close" onclick="closeAnalyticsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="analytics-controls">
                        <select id="analyticsPeriod" onchange="loadAdvancedAnalytics()">
                            <option value="weekly">This Week</option>
                            <option value="monthly" selected>This Month</option>
                            <option value="quarterly">This Quarter</option>
                            <option value="yearly">This Year</option>
                        </select>
                        
                        <button class="btn btn-secondary" onclick="loadAdvancedAnalytics()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="analyticsContainer" class="analytics-container">
                        <!-- Analytics will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <style>
        /* Advanced Features Styles */
        .recurring-list {
            margin-top: 1rem;
        }

        .recurring-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--bg-light);
        }

        .recurring-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
        }

        .recurring-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .recurring-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .btn-small.btn-danger {
            background: #ef4444;
        }

        .insights-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .insight-card {
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            background: var(--bg-light);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-light);
        }

        .insight-card.priority-8,
        .insight-card.priority-9,
        .insight-card.priority-10 {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.02));
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .insight-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .insight-priority {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .insight-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .insight-recommendations {
            background: rgba(79, 70, 229, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(79, 70, 229, 0.1);
        }

        .insight-recommendations h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .insight-recommendations ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .insight-recommendations li {
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .analytics-container {
            margin-top: 1rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .analytics-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .analytics-card h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .analytics-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chart-bar {
            position: relative;
            height: 40px;
            background: var(--border-color);
            border-radius: 20px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: width 0.8s ease;
        }

        .bar.income {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .bar.expense {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .category-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(79, 70, 229, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(79, 70, 229, 0.1);
        }

        .category-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .category-amount {
            color: var(--primary-color);
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .no-insights {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .insights-header,
        .analytics-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .analytics-stats {
                grid-template-columns: 1fr;
            }
            
            .insights-header,
            .analytics-controls {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
        </style>
            }, 30000); // Check every 30 seconds
        }

        // Start real-time simulation when app initializes
        document.addEventListener('DOMContentLoaded', function() {
            // Check payment app connections on page load
            setTimeout(() => {
                checkPaymentAppConnections();
            }, 1000);
            
            setTimeout(() => {
                simulateRealTimeTransactions();
            }, 5000); // Start after 5 seconds
        });
    </script>
</body>
</html>